<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="https://jpaztech.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2022-12-22T05:56:35.243Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure Windows VM でクラスター サイズが拡張したいボリューム サイズに対応してない場合について</title>
    <link href="https://jpaztech.github.io/blog/vm/extend-data-disk-related-to-a-cluster-size/"/>
    <id>https://jpaztech.github.io/blog/vm/extend-data-disk-related-to-a-cluster-size/</id>
    <published>2022-12-21T05:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.243Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの新見です。</p><p>Azure Windows VM において、データ ディスクの拡張方法に関してお問い合わせをいただくことがあります。<br>今回はディスク拡張前の Windows NTFS のクラスター サイズ（アロケーション ユニットサイズ）が、ディスク拡張後のボリューム サイズに対応していない際に、ディスクを拡張する方法をご案内させていただきます。</p><h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><p>念のため、作業の実施前には、予期せぬご状況に備えてバックアップやスナップショットの取得をご実施いただければと存じます。<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">公開情報：Azure VM バックアップについて - Azure Backup | Microsoft Docs</a><br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/snapshot-copy-managed-disk?tabs=portal">公開情報：仮想ハード ディスクの Azure スナップショットを作成する - Azure Virtual Machines | Microsoft Docs</a></p><p>また、記憶域スペースをご利用をいただいている場合においては、以下の手順をご参照ください。<br><a href="https://jpaztech.github.io/blog/vm/extend-storage-space-on-azure-windows-vm/">公開情報：Azure Windows VM で記憶域スペースを拡張する | Japan Azure IaaS Core Support Blog (jpaztech.github.io)</a></p><h2 id="クラスター-サイズが拡張したいボリューム-サイズに対応している場合"><a href="#クラスター-サイズが拡張したいボリューム-サイズに対応している場合" class="headerlink" title="クラスター サイズが拡張したいボリューム サイズに対応している場合"></a>クラスター サイズが拡張したいボリューム サイズに対応している場合</h2><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>データ ディスクを拡張する際には、クラスター サイズが拡張したいボリューム サイズに対応している場合、Azure Portal 等にてディスクのサイズを拡張いただいた後、ゲスト OS 上の操作にてボリュームを拡張する必要があります。</p><h3 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h3><h4 id="1-仮想マシンを停止し、ディスクのサイズを拡張する"><a href="#1-仮想マシンを停止し、ディスクのサイズを拡張する" class="headerlink" title="1. 仮想マシンを停止し、ディスクのサイズを拡張する"></a>1. 仮想マシンを停止し、ディスクのサイズを拡張する</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/expand-os-disk#resize-a-managed-disk-in-the-azure-portal">公開情報：Azure 内の Windows VM に接続されている仮想ハード ディスクを拡張する - Azure Virtual Machines | Microsoft Docs</a><br>参照箇所：Azure portal でマネージド ディスクのサイズを変更する</p><h4 id="2-仮想マシン内からボリュームを拡張する"><a href="#2-仮想マシン内からボリュームを拡張する" class="headerlink" title="2. 仮想マシン内からボリュームを拡張する"></a>2. 仮想マシン内からボリュームを拡張する</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/expand-os-disk#using-disk-manager">公開情報：Azure 内の Windows VM に接続されている仮想ハード ディスクを拡張する - Azure Virtual Machines | Microsoft Docs</a><br>参照箇所：ディスク マネージャーの使用</p><p>しかしながら、この手順を実行する際にクラスター サイズが対応していない場合はエラーが発生するため、対処方法を以下の通りお伝えします。</p><h2 id="クラスター-サイズが拡張したいボリューム-サイズに対応していない場合"><a href="#クラスター-サイズが拡張したいボリューム-サイズに対応していない場合" class="headerlink" title="クラスター サイズが拡張したいボリューム サイズに対応していない場合"></a>クラスター サイズが拡張したいボリューム サイズに対応していない場合</h2><h3 id="概要-1"><a href="#概要-1" class="headerlink" title="概要"></a>概要</h3><p>そのまま既存のデータ ディスクを拡張することができないため、データ ディスクを新規で作成して仮想マシンに接続し、クラスター サイズが対応しているサイズでボリュームを作成した上で、既存ボリューム上のデータを新規ボリュームにコピーする必要があります。</p><h3 id="解説"><a href="#解説" class="headerlink" title="解説"></a>解説</h3><p>クラスター サイズが拡張したいボリューム サイズに対応している場合の手順で拡張した場合、クラスター サイズは拡張前のデフォルトのサイズのままなので、拡張したいボリュームのサイズに対応していない場合はクラスター サイズを対応させる必要があります。<br>しかし、クラスター サイズを変えてしまうと、ボリュームのフォーマットが実施されデータが消えてしまうため、新規でデータ ディスクを作成することでご対応いただければと存じます。</p><p>P70 で作成したディスクの 16TB のボリュームを、 32TB に拡張したい場合を例として説明します。</p><h4 id="デフォルトのクラスター-サイズと必要なクラスター-サイズ"><a href="#デフォルトのクラスター-サイズと必要なクラスター-サイズ" class="headerlink" title="デフォルトのクラスター サイズと必要なクラスター サイズ"></a>デフォルトのクラスター サイズと必要なクラスター サイズ</h4><p>作成するボリュームのサイズによって、デフォルトのクラスター サイズは以下のように異なります。<br><a href="https://support.microsoft.com/ja-jp/topic/ntfs-fat-%E3%81%8A%E3%82%88%E3%81%B3-exfat-%E3%81%AE%E3%83%87%E3%83%95%E3%82%A9%E3%83%AB%E3%83%88%E3%81%AE%E3%82%AF%E3%83%A9%E3%82%B9%E3%82%BF%E3%83%BC-%E3%82%B5%E3%82%A4%E3%82%BA-9772e6f1-e31a-00d7-e18f-73169155af95">公開情報：NTFS、FAT、および exFAT のデフォルトのクラスター サイズ (microsoft.com)</a></p><table><thead><tr><th align="left">ボリュームのサイズ</th><th align="left">Windows 7、Windows Server 2008 R2、Windows Server 2008、Windows Vista、Windows Server 2003、Windows XP、Windows 2000</th></tr></thead><tbody><tr><td align="left">2TB – 16TB</td><td align="left">4KB</td></tr><tr><td align="left">16TB – 32TB</td><td align="left">8KB</td></tr></tbody></table><p>P70(16TB) でディスクを作成し、16TB でボリュームを作成した場合、デフォルトのクラスター サイズは 4KB になります。<br>クラスター サイズ が 4KB の場合、ボリュームは 16TB までしか対応していません。<br>32TB のボリュームを作成するには、8KB のクラスター サイズが必要になります。</p><p><a href="https://learn.microsoft.com/ja-jp/windows-server/storage/file-server/ntfs-overview#support-for-large-volumes">公開情報：NTFS の概要 | Microsoft Docs</a></p><table><thead><tr><th align="left">クラスター サイズ</th><th align="left">最大ボリュームおよびファイル</th></tr></thead><tbody><tr><td align="left">4KB (既定のサイズ)</td><td align="left">16TB</td></tr><tr><td align="left">8KB</td><td align="left">32TB</td></tr></tbody></table><p>クラスター サイズが拡張したいボリューム サイズに対応している場合の手順で、P70(16TB) のディスクを P80(32TB) に拡張した場合、16TB で作成済のボリュームのクラスター サイズはデフォルトと変わらず 4KB のままです。<br>そのため、この作成済の 16TB ボリュームを 32TB にしたい場合、 8KB のクラスター サイズが必要となるので、クラスター サイズが 4KBのままでは 32TB に拡張することができず、実際実行した場合以下のようにエラーメッセージが表示されます。</p><p><img src="/blog/vm/extend-data-disk-related-to-a-cluster-size/extend-data-disk-related-to-a-cluster-size-01.png">    </p><h4 id="クラスター-サイズの変更はフォーマットが伴う"><a href="#クラスター-サイズの変更はフォーマットが伴う" class="headerlink" title="クラスター サイズの変更はフォーマットが伴う"></a>クラスター サイズの変更はフォーマットが伴う</h4><p>上記の通り、32TB のボリュームを利用するためには、クラスター サイズを 8KB 以上に変更する必要がありますが、クラスター サイズを変更してしまうと、ボリュームのフォーマットが実施されることとなってしまいます。<br>（ P70(16TB) のディスク上でクラスター サイズを 8KB に変更してしまうと、データが消えてしまいます。）</p><h4 id="ディスク内の既存のデータに影響を与えない方法"><a href="#ディスク内の既存のデータに影響を与えない方法" class="headerlink" title="ディスク内の既存のデータに影響を与えない方法"></a>ディスク内の既存のデータに影響を与えない方法</h4><p>P80 のデータ ディスクを新規作成して仮想マシンに接続し、16TB 以上のサイズでボリュームを作成した上で、既存ボリューム上のデータを新規ボリュームにコピーします。<br>16TB ~ 32TB のサイズでボリュームを新規で作成した場合は、デフォルトのクラスター サイズが 8KB となるため、そのままご利用いただくことができます。</p><h3 id="手順-1"><a href="#手順-1" class="headerlink" title="手順"></a>手順</h3><h4 id="1-対応しているサイズのデータ-ディスクを新規作成して、仮想マシンにアタッチする"><a href="#1-対応しているサイズのデータ-ディスクを新規作成して、仮想マシンにアタッチする" class="headerlink" title="1. 対応しているサイズのデータ ディスクを新規作成して、仮想マシンにアタッチする"></a>1. 対応しているサイズのデータ ディスクを新規作成して、仮想マシンにアタッチする</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/attach-managed-disk-portal">公開情報：マネージド データ ディスクを Windows VM に接続する - Azure - Azure Virtual Machines | Microsoft Docs</a></p><p>Azure portal にて、対象の VM を選択します。<br>左のメニューから [ディスク] を選択し、[新しいディスクを作成し接続する] を選択します。<br>[保存] を選択したら、新しいデータ ディスクの作成と VM への接続の完了です。</p><p><img src="/blog/vm/extend-data-disk-related-to-a-cluster-size/extend-data-disk-related-to-a-cluster-size-02.png"></p><h4 id="2-新規ボリュームを作成する"><a href="#2-新規ボリュームを作成する" class="headerlink" title="2. 新規ボリュームを作成する"></a>2. 新規ボリュームを作成する</h4><p><a href="https://support.microsoft.com/ja-jp/windows/%E3%83%8F%E3%83%BC%E3%83%89-%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF-%E3%83%91%E3%83%BC%E3%83%86%E3%82%A3%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%92%E4%BD%9C%E6%88%90%E3%81%97%E3%81%A6%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88%E3%81%99%E3%82%8B-bbb8e185-1bda-ecd1-3465-c9728f7d7d2e">公開情報：ハード ディスク パーティションを作成してフォーマットする (microsoft.com)</a></p><p>まず、対象の VM に接続します。<br>まず、[スタート]  ボタンを右クリックし、 [コンピューターの管理] を開きます。<br>新規でアタッチしたディスクの上で右クリックし、[新しいボリューム]を選択し、希望のサイズで新規ボリュームを作成します。</p><p><img src="/blog/vm/extend-data-disk-related-to-a-cluster-size/extend-data-disk-related-to-a-cluster-size-03.png"></p><p>しばらくすると、フォーマットが完了し、ボリュームが新規作成されます。</p><p><img src="/blog/vm/extend-data-disk-related-to-a-cluster-size/extend-data-disk-related-to-a-cluster-size-04.png"></p><p>エクスプローラーでもボリュームが作成できたことを確認できます。</p><p><img src="/blog/vm/extend-data-disk-related-to-a-cluster-size/extend-data-disk-related-to-a-cluster-size-05.png"></p><h4 id="3-既存ボリューム上のデータを新規ボリュームにコピーする"><a href="#3-既存ボリューム上のデータを新規ボリュームにコピーする" class="headerlink" title="3. 既存ボリューム上のデータを新規ボリュームにコピーする"></a>3. 既存ボリューム上のデータを新規ボリュームにコピーする</h4><p><a href="https://learn.microsoft.com/ja-jp/windows-server/administration/windows-commands/robocopy">公開情報：robocopy | Microsoft Docs</a></p><p>新規ボリュームに既存のボリュームのデータをコピーします。</p><p>例）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">robocopy F:\ G:\ /copyall</span><br></pre></td></tr></table></figure><h4 id="4-既存ディスクをデタッチする"><a href="#4-既存ディスクをデタッチする" class="headerlink" title="4. 既存ディスクをデタッチする"></a>4. 既存ディスクをデタッチする</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/detach-disk#detach-a-data-disk-using-the-portal">公開情報：Windows VM からデータ ディスクを切断する - Azure - Azure Virtual Machines | Microsoft Docs</a></p><p>Azure portal にて、対象の仮想マシンを選択します。<br>左のメニューから [ディスク] を選択し、既存のデータ ディスクの右端にある [X] ボタンを選択します。<br>[保存] を選択したら、既存のデータ ディスクが VM から接続解除されます。<br>※デタッチしたディスクはストレージに残ります。 ディスクが削除されるわけではありません。</p><p><img src="/blog/vm/extend-data-disk-related-to-a-cluster-size/extend-data-disk-related-to-a-cluster-size-06.png"></p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>Azure Windows VM において、データ ディスク拡張前の Windows NTFS のクラスター サイズが、ディスク拡張後のボリューム サイズに対応していない際は、ディスクを拡張する方法にご留意ください。<br>本記事が、皆様の運用に役立つことを願っています。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの新見です。&lt;/p&gt;
&lt;p&gt;Azure Windows VM において、データ ディスクの拡張方法に関してお問い合わせをいただくことがあります。&lt;br&gt;今回はディスク拡張前の Windows NTFS のクラスター サイズ</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Data Disk" scheme="https://jpaztech.github.io/blog/tags/Data-Disk/"/>
    
  </entry>
  
  <entry>
    <title>AKSのメモリ関連トラブルシューティング</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-memory-troubleshoot/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-memory-troubleshoot/</id>
    <published>2022-12-21T03:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.079Z</updated>
    
    <content type="html"><![CDATA[<p>この記事は<a href="https://qiita.com/advent-calendar/2022/microsoft-azure-tech">Microsoft Azure Tech Advent Calendar 2022</a>の21日目の記事です。</p><p>Azureテクニカルサポートチームの高田です。</p><p>Azure Kubernetes Service(AKS)の運用に際して、メモリ関連の要因によりワークロードが期待通りに実行されない…という方向けに、下記の典型的な事例と対処方法を紹介させて頂きます。</p><ul><li>事例1: Podが配置・実行されない</li><li>事例2: 実行中のPodが終了され、Failed状態となる(または削除・再作成される)</li><li>事例3: 実行中のPodにてOOMKillが発生する</li></ul><h2 id="事例1-Podが配置・実行されない"><a href="#事例1-Podが配置・実行されない" class="headerlink" title="事例1: Podが配置・実行されない"></a>事例1: Podが配置・実行されない</h2><p>これは、新たに作成されたPodのメモリ要求(requests)を満たすノードが存在せず、Podがどのノードにも配置(スケジューリング)されない = 実行が開始されない、というものとなります。</p><p><a href="https://kubernetes.io/ja/docs/concepts/configuration/manage-resources-containers/#my-pods-are-pending-with-event-message-failedscheduling">Kubernetes の公式ドキュメント</a>でも同様の事例が紹介されておりますが、簡単に解説します。</p><p>PodがRunning状態とならず、<code>kubectl describe pod</code>コマンドにてStatusがPendingとなっており、Eventsが下記のような表示となっていた場合に、このケースに該当します。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod &lt;pod名&gt;</span></span><br><span class="line">(略)</span><br><span class="line">Status:       Pending</span><br><span class="line">(略)</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason            Age   From               Message</span><br><span class="line">  ----     ------            ----  ----               -------</span><br><span class="line">  Warning  FailedScheduling  7s    default-scheduler  0/3 nodes are available: 3 Insufficient memory.</span><br></pre></td></tr></table></figure><p>メモリ要求を満たすノードが存在しない、ということは、言い換えると、このPodをどのノードに配置しても、そのノード上のPodのメモリ要求の合計がそのノードの割当可能な(allocatable)メモリ量を超えてしまう、という意味となります。</p><p>実際には、メモリ「のみ」に関しては条件を満たすノードがあるものの、その他の条件(例:Pod のマニフェストにて指定されている配置条件、CPU等他リソースの状況、ノードのTaint等)により、それらを同時に満たすノードが存在しない、というケースもあります。</p><p>Podのメモリ要求値、各ノードのメモリ割り当て状況は、各々<code>kubectl describe pods</code> <code>kubectl describe nodes</code>コマンドで確認できます。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod &lt;pod名&gt;</span></span><br><span class="line">(略)</span><br><span class="line">Containers:</span><br><span class="line">  podcontainer:</span><br><span class="line">    Image:      podimage</span><br><span class="line">    Port:       &lt;none&gt;</span><br><span class="line">    Host Port:  &lt;none&gt;</span><br><span class="line">    Requests:</span><br><span class="line">      memory:     2Gi                    &lt;- 2GiBのメモリを要求</span><br><span class="line">    Environment:  &lt;none&gt;</span><br></pre></td></tr></table></figure><p>この例では、Pod内のコンテナーに設定されているメモリ要求値が2Giになっています。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe node &lt;node名&gt;</span></span><br><span class="line">(略)</span><br><span class="line">Capacity:</span><br><span class="line">  cpu:                2</span><br><span class="line">  ephemeral-storage:  129886128Ki</span><br><span class="line">  hugepages-1Gi:      0</span><br><span class="line">  hugepages-2Mi:      0</span><br><span class="line">  memory:             4025844Ki          &lt;-ノードの全メモリは4,025,844KiB</span><br><span class="line">  pods:               30</span><br><span class="line">Allocatable:</span><br><span class="line">  cpu:                1900m</span><br><span class="line">  ephemeral-storage:  119703055367</span><br><span class="line">  hugepages-1Gi:      0</span><br><span class="line">  hugepages-2Mi:      0</span><br><span class="line">  memory:             2209268Ki          &lt;-Podに割当可能なメモリは2,209,268KiB</span><br><span class="line">  pods:               30</span><br><span class="line">(略)</span><br><span class="line">Allocated resources:</span><br><span class="line">  (Total limits may be over 100 percent, i.e., overcommitted.)</span><br><span class="line">  Resource           Requests     Limits</span><br><span class="line">  --------           --------     ------</span><br><span class="line">  cpu                430m (22%)   4500m (236%)</span><br><span class="line">  memory             310Mi (14%)  3286Mi (152%)    &lt;- 310MiB (Allocatable の14%) が割当済み</span><br><span class="line">  ephemeral-storage  0 (0%)       0 (0%)</span><br><span class="line">  hugepages-1Gi      0 (0%)       0 (0%)</span><br><span class="line">  hugepages-2Mi      0 (0%)       0 (0%)</span><br><span class="line">Events:              &lt;none&gt;</span><br></pre></td></tr></table></figure><p>ノードに残されている割当可能なメモリ2209268Ki - 310Mi よりもPodの要求値 (2Gi) が大きいため、このノードには配置できない、ということがわかります。</p><p>ここでご注意頂きたい点として、配置時に関しては、ノード上で実際に使用されているメモリ量、Pod/コンテナーが実際に使用しているメモリ量は直接関係なく、あくまでもPod/コンテナーが(マニフェスト内の指定にて)<strong>要求する</strong>メモリ量、ノード上のそれらの<strong>要求</strong>の合計により判定される、というものがあります。<br>ノード上の既存のPod/コンテナーが実際にはほとんどメモリを使用していない場合でも、それらの<strong>要求</strong>値が高い場合には、配置時の観点ではそのノードは「メモリに余裕がない」扱いとなります。<br>この問題のトラブルシューティングの際には、(後述するワーキングセットメモリの監視など)実際のメモリ使用量ではなく、<strong>要求</strong>量を確認しましょう。</p><h3 id="対処方法"><a href="#対処方法" class="headerlink" title="対処方法"></a>対処方法</h3><p>これを解消するには、メモリ割り当てに余裕のあるノードを確保するか、あるいは、Podのメモリ要求を既存のノードで賄える程度まで小さくする必要があります。</p><p>前者に関しては、不要なPodの削除による割り当ての開放、または、<a href="https://learn.microsoft.com/ja-jp/azure/aks/use-multiple-node-pools#scale-a-node-pool-manually">ノードプールのスケーリング</a>、<a href="https://learn.microsoft.com/ja-jp/azure/aks/use-multiple-node-pools#add-a-node-pool">ノードプールの追加</a>、<a href="https://learn.microsoft.com/ja-jp/azure/aks/resize-node-pool">ノードのVMサイズの変更</a>、等によるノードの増強、といった方法があります。</p><p>後者に関しては、Pod のメモリ要求の値、すなわち、Podのマニフェストの<code>spec.containers[].resources.requests.memory</code>の値を減らすこととなります。</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="string">(略)</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">podimage</span></span><br><span class="line"><span class="string">(略)</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">2Gi</span> <span class="comment"># &lt;- これを減らす</span></span><br></pre></td></tr></table></figure><p>ただし、Podが実際に使用するメモリ量を考慮せずにこの値を減らした場合、後述するOOMKillやEvictが発生するリスクが生じますのでご注意下さい。</p><h3 id="補足-詰め込みの是非"><a href="#補足-詰め込みの是非" class="headerlink" title="補足:詰め込みの是非"></a>補足:詰め込みの是非</h3><p>Podのメモリ要求に対して必要最小限のノードにてAKSクラスターを運用したい、という方も多いかと思います。<br>しかしながら、平常時にて未割当のメモリが少ない場合、Deployment の更新によるローリングアップデートの際等に、メモリが割当不能になるリスクがあります。</p><p>AKSでは、ユーザのPodの他に、CoreDNS等のシステムPodが配置され、動作しています。<br>これらは随時アップデートが行われることがあります。<br>また、AKSに関するアドオンの有効化等により、システムPodが追加で配置されることもあります。<br>このとき、既に各ノードのメモリのほぼ全てが割り当てられていた場合、システムPodの配置失敗や、システムPodの配置のために既存Podが<a href="https://kubernetes.io/docs/concepts/scheduling-eviction/pod-priority-preemption/#preemption">Preemption</a>の対象となることがあり得ます。<br>このような事態を避けるため、少なくとも<a href="https://learn.microsoft.com/ja-jp/azure/aks/use-system-pools?tabs=azure-cli">システムノードプール</a>内のノードに関してはある程度の余裕を確保することをご検討下さい。</p><p>ちなみに、配置の際にはCPUとメモリの扱いに本質的な違いはないので、上記の考え方はCPUに関してもそのまま適用可能です。</p><h2 id="事例2-実行中のPodが終了され、Failed状態となる-または削除・再作成される"><a href="#事例2-実行中のPodが終了され、Failed状態となる-または削除・再作成される" class="headerlink" title="事例2: 実行中のPodが終了され、Failed状態となる(または削除・再作成される)"></a>事例2: 実行中のPodが終了され、Failed状態となる(または削除・再作成される)</h2><p>これは、実行中のPodがノードのメモリ不足によりEvict(退去)の対象となった場合に発生します。<br><code>kubectl describe pod</code>コマンドの結果にて下記のような記録があった場合にこのケースに該当します。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash"> kubectl describe pod &lt;pod名&gt;</span></span><br><span class="line">(略)</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason               Age   From     Message</span><br><span class="line">  ----     ------               ----  ----     -------</span><br><span class="line">(略)</span><br><span class="line">  Warning  Evicted              110s  kubelet  The node was low on resource: memory. Container &lt;container名&gt; was using 3256Ki, which exceeds its request of 2048Ki.</span><br><span class="line">  Normal   Killing              110s  kubelet  Stopping container &lt;container名&gt;</span><br></pre></td></tr></table></figure><p>Podのマニフェストに記載するメモリ要求(<code>spec.containers[].requests.memory</code>)はあくまでも「予算」のようなものであり、Podはこの値を超えてメモリを確保・使用できます。<br>このため、要求の合計がノードの割当可能なメモリ量の範囲に収まるようにPodが配置されていても、それらのPod(の一部)が要求値を超えてメモリを確保・使用した場合には、ノードにてメモリ不足が発生します。<br>このとき、要求を超えてメモリを使用しているPodの中から、Podに設定されている優先等を考慮して選択されたものが<a href="https://kubernetes.io/docs/concepts/scheduling-eviction/node-pressure-eviction/">evict</a>(退去)されます。<br>(メモリ使用量が急激に増加した場合など、Evictが発生せずに後述するOOMKillが発生する場合もあります)</p><h3 id="対処方法-1"><a href="#対処方法-1" class="headerlink" title="対処方法"></a>対処方法</h3><p>メモリ不足によるEvictを防ぐには、ノード上でメモリ不足が発生しないようにする必要があります。<br>必ずしもPod・コンテナーが使用するメモリの最大値を要求に記載する必要はありませんが、Pod・コンテナーのメモリ使用量が定常的に要求値を超える場合は、そのようなPodの要求値(Podマニフェスト中の<code>pod.spec.containers[].resources.requests.memory</code>の値)をより大きなものに変更することで、対象のPodがよりメモリ割当に余裕のあるノードに配置されることとなり、ノード上でのメモリ不足が発生しにくくなります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">(略)</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: podimage</span><br><span class="line">(略)</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: 1Gi # &lt;- これを増やす</span><br></pre></td></tr></table></figure><p>なお、この変更によりPodの配置が行えなくなる可能性もありますので、必要に応じて「Podが配置・実行されない」のトラブルシューティングも実施しましょう。</p><h3 id="補足-コンテナー分析情報"><a href="#補足-コンテナー分析情報" class="headerlink" title="補足:コンテナー分析情報"></a>補足:コンテナー分析情報</h3><p>実際のノードやPod・コンテナーのメモリ消費量は、<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-enable-aks?tabs=azure-cli">コンテナー分析情報</a>を有効にすることで監視できます。</p><p>コンテナー分析情報は、AzureポータルのAKSクラスターの画面中、「監視」内「分析情報」のタブから利用できます。<br>コンテナー分析情報ではRSS(プロセスが直接明示的に使用しているメモリ領域の大きさ)とワーキングセット(RSS以外の、ファイルキャッシュ等の間接的なメモリ消費を含んだ値)を確認できますが、Evictや後述するOOMKillはワーキングセットに基づいて行われますため、メモリ不足発生の有無の観点ではワーキングセットを確認するようにしましょう。</p><p><img src="/blog/containers/aks-memory-troubleshoot/aks-memory-troubleshoot01.png" alt="ノードのワーキングセット"><br><img src="/blog/containers/aks-memory-troubleshoot/aks-memory-troubleshoot02.png" alt="Pod/コンテナーのワーキングセット"></p><h2 id="事例3-実行中のPodにてOOMKillが発生する"><a href="#事例3-実行中のPodにてOOMKillが発生する" class="headerlink" title="事例3: 実行中のPodにてOOMKillが発生する"></a>事例3: 実行中のPodにてOOMKillが発生する</h2><p>OOM(Out Of Memory)Kill は、ノードに配置され実行中のPodによるメモリ使用量が「制限値」を超過した(正確には、超過してメモリを使用しようとした)ときに発生します。</p><p><code>kubectl describe pod</code>コマンドにて、 Last State 等のReasonに”OOMKilled”と書かれている場合が該当します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ kubectl describe pod &lt;pod名&gt;</span><br><span class="line">(略)</span><br><span class="line">Containers:</span><br><span class="line">(略)</span><br><span class="line">    Last State:     Terminated</span><br><span class="line">      Reason:       OOMKilled</span><br><span class="line">      Exit Code:    1</span><br><span class="line">      Started:      Fri, 16 Dec 2022 09:57:41 +0000</span><br><span class="line">      Finished:     Fri, 16 Dec 2022 09:57:44 +0000</span><br><span class="line">    Ready:          False</span><br><span class="line">    Restart Count:  1</span><br></pre></td></tr></table></figure><p>制限値には、Pod/コンテナーレベルのものと、ノードレベルのものがあります。<br>(ノード上でのPod合計のメモリ使用量増加する=ノードがメモリ不足となる場合は前項で解説したEvictも発生し得ますが、メモリ増加ペース等によりEvictが発生せずいきなりOOMKillとなる場合もあります)<br>ノード全体のメモリ使用量等から、どちらの制限値に抵触したか判断可能な場合が多いですが、後述の、OOMKillの詳細情報にて判断することも可能です。</p><h3 id="Pod-コンテナーレベルのOOMKillの原因と対処方法"><a href="#Pod-コンテナーレベルのOOMKillの原因と対処方法" class="headerlink" title="Pod/コンテナーレベルのOOMKillの原因と対処方法"></a>Pod/コンテナーレベルのOOMKillの原因と対処方法</h3><p>Pod/コンテナーレベルのOOMKillは、Podのマニフェスト中、<code>spec.containers[].resources.limits.memory</code>にてメモリ制限値が指定されていた場合に、Pod/コンテナーのメモリ使用量がこれに抵触することで発生します。</p><p>したがって、Pod/コンテナーレベルのOOMKillが発生した場合、その原因はPod/コンテナーのメモリ使用量に問題がある(=Pod/コンテナー内アプリケーションの何らかの異常等により、メモリ使用量が想定を超えて増大している)か、メモリ制限値に問題がある(=Pod/コンテナー内のワークロードの使用するメモリ量を低く見積もり過ぎている)か、のどちらかとなります。</p><p>ワークロードの種類によっては判断が難しい場合もありますが、もしメモリ制限値が厳しすぎた可能性があると考える場合は、limitsの値を増やしましょう。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">(略)</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - image: podimage</span><br><span class="line">(略)</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: 500Mi</span><br><span class="line">      limits:</span><br><span class="line">        memory: 1Gi  # &lt;- これを増やす</span><br></pre></td></tr></table></figure><p>なお、Pod/コンテナーのメモリ使用量はワーキングセット(RSS以外のファイルキャッシュ等も<br>含んだ値)に関して評価されます。<br>psコマンド等で確認できるプロセスのメモリ使用量(RSS)の合計よりも大きな値となりますので、コンテナー分析情報等にてワーキングセットの値も確認しましょう。</p><h3 id="ノードレベルのOOMKillの原因と対処方法"><a href="#ノードレベルのOOMKillの原因と対処方法" class="headerlink" title="ノードレベルのOOMKillの原因と対処方法"></a>ノードレベルのOOMKillの原因と対処方法</h3><p>ノードレベルにて、「割当可能なメモリ量」の値 + evictionのための猶予値が制限値として設定されているため、これに抵触した場合に(たとえPod/コンテナーレベルの制限値に抵触しなくても)OOMKillが発生します。</p><p>この場合、原因はメモリ不足によるEvictと同様のため、対処方法も同様に各Podのメモリ要求の見直しと、必要に応じたノードの増強等となります。</p><h3 id="補足-OOMKillの詳細情報"><a href="#補足-OOMKillの詳細情報" class="headerlink" title="補足: OOMKillの詳細情報"></a>補足: OOMKillの詳細情報</h3><p>OOMKillはLinux Kernelのメモリ関連機能である<a href="https://www.kernel.org/doc/html/latest/admin-guide/cgroup-v1/memcg_test.html">memcg</a>により駆動されるため、発生時のカーネルメッセージを参照することでさまざまな情報が得られます。<br>例えば、下記メッセージ中のoom_memcgにはOOMKillの原因となった制限値が設定されていたmemcg(memory cgroup、プロセスの集合)が記載されているため、これが下記のように<code>/kubepods</code>となっていた場合はノードレベルのOOMKill、 <code>/kubepods/....</code>と続いていた場合はPod/コンテナーレベルのOOMKillとなります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Dec 16 09:37:31 aks-nodepool1-32235639-vmss000002 kernel: [376723.579928] oom-kill:constraint=CONSTRAINT_MEMCG,nodemask=(null),cpuset=d9a4f01c5cfe15ee88972f51557b3395ea6f8d0f31a93d7ef19c64459085a156,mems_allowed=0,oom_memcg=/kubepods,task_memcg=/kubepods/besteffort/pod325d3265-721f-4032-a97b-b3caa6e51859/d9a4f01c5cfe15ee88972f51557b3395ea6f8d0f31a93d7ef19c64459085a156,task=stress,pid=2268420,uid=0</span><br></pre></td></tr></table></figure><p>この他、メッセージにはOOMKillが発生したときのメモリ使用状況等も含まれており、これがメモリ使用内訳の調査等にも役に立つことがあります。<br>カーネルメッセージは、ノードの<code>/var/log/syslog</code>等に記録されるため、 <a href="https://learn.microsoft.com/ja-jp/azure/aks/node-access">ノードにログイン</a>した後に <code>/host/var/log/syslog</code>等を参照することで確認できます。</p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>AKSはワークロードの配置や実行、問題発生時の復旧を自動的に行ってくれる一方、与える情報や設定が不十分であったり、実態と乖離した場合には予期しない動作となることもあります。<br>今回ご紹介した事例が、皆様のAKSの運用に役立つことを願っています。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;この記事は&lt;a href=&quot;https://qiita.com/advent-calendar/2022/microsoft-azure-tech&quot;&gt;Microsoft Azure Tech Advent Calendar 2022&lt;/a&gt;の21日目の記事です。&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
    <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
  <entry>
    <title>Azure IaaS VM で実施されるメンテナンスについて</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-maintenance/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-maintenance/</id>
    <published>2022-10-16T13:40:00.000Z</published>
    <updated>2022-12-22T05:56:35.419Z</updated>
    
    <content type="html"><![CDATA[<p>Azure テクニカル サポートチームの鳥越です。</p><p>Azure をご利用いただいているお客様の中にはメンテナンスによる影響を経験された方もいらっしゃるかと存じます。<br>クラウド環境として、新機能の導入や更なる安定稼働を進めていく上で、このメンテナンスは必要不可欠なものです。<br>しかしながら、このメンテナンスといった言葉の中には、どのようなメンテナンスなのかがよくわからないといったご不安もあるかと推察します。</p><span id="more"></span><p>このような背景もあり、メンテナンスについて、またその影響について可能な限り補足させていただければと、このブログ記事を執筆しました。少しでも本内容がお客様のAzureに対する安心と信頼につながれば幸いでございます。<br>※ なお、今回は IaaS のメンテナンスを中心に記載しております。</p><hr><h2 id="■-そもそもメンテナンスとは何か"><a href="#■-そもそもメンテナンスとは何か" class="headerlink" title="■ そもそもメンテナンスとは何か ?"></a>■ そもそもメンテナンスとは何か ?</h2><p>例えば、オンプレミス環境で言えば、ハードウェア廃止による機材の入れ替えや冗長化などの構成変更、物理的な電気系統の検査、サーバーやネットワーク機器のセキュリティを含む Firmware アップデートなどが該当するかと考えます。</p><p><em>余談ですが、私が以前、オンプレミス環境のサポートを行っていた際には、このような　Firmware のアップデートは深夜の業務停止時間帯に数時間確保した上で計画的実施されておりました。しかし、この Firmware のアップデートは必ずうまくいくといった保証もなく、失敗した際のリカバリ対応も多く経験しました。</em></p><hr><h2 id="■-Azure-環境ではどのように考えるべきか"><a href="#■-Azure-環境ではどのように考えるべきか" class="headerlink" title="■ Azure 環境ではどのように考えるべきか ?"></a>■ Azure 環境ではどのように考えるべきか ?</h2><p>Azure 環境は、物理ホスト サーバー群とその上で複雑に制御された機能をつかさどる各プロセスが稼働しています。また、これらをつなぐネットワーク機器や物理ホスト サーバー群を管理するための機能といった様々なコンポーネントが存在します。</p><p>Azure では、定期的にこのようなプラットフォームを更新して、仮想マシン (VM) のホスト インフラストラクチャーの信頼性、パフォーマンス、セキュリティの向上に努めています。これらの更新の目的は、ホスティング環境のソフトウェア コンポーネントの新機能追加、修正から、ネットワーク コンポーネントのアップグレード、ハードウェアの使用停止まで、広い範囲に及びます。</p><hr><h2 id="■-どのようなメンテナンスがあるか"><a href="#■-どのようなメンテナンスがあるか" class="headerlink" title="■ どのようなメンテナンスがあるか ?"></a>■ どのようなメンテナンスがあるか ?</h2><p>VM における再起動の有無により、大きく分けて、以下の 2 種類が考えられます。</p><ul><li>再起動を必要とするメンテナンス</li><li>再起動を必要としないメンテナンス</li></ul><hr><h2 id="■-再起動を必要とするメンテナンスとは"><a href="#■-再起動を必要とするメンテナンスとは" class="headerlink" title="■ 再起動を必要とするメンテナンスとは ?"></a>■ 再起動を必要とするメンテナンスとは ?</h2><p>再起動を必要とするメンテナンスは、計画メンテナンスとも呼ばれ、VM の再起動を伴うためにお客様に対して事前に通知が行われます。<br>セルフ サービス フェーズと呼ばれる準備期間内には、お客様の任意のタイミングにてメンテナンスを実施することができるため、メンテナンスに伴う VM 再起動による業務影響の発生を避けることが可能です。詳細については、下記公開情報をご確認ください。</p><blockquote><p>参考文献) 再起動を必要とするメンテナンス<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-and-updates#maintenance-that-requires-a-reboot">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-and-updates#maintenance-that-requires-a-reboot</a></p></blockquote><blockquote><p>参考文献) 計画メンテナンスの通知の処理<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-notifications</a></p></blockquote><p>メンテナンスの目的としては、ソフトウェアや Firmware 更新、古いハードウェアの更新 (移行) 作業やネットワーク スイッチにおける機器の交換作業などが考えられます。</p><div class="alert is-info"><p class="alert-title">Note</p><p>ネットワーク スイッチにおける機器ついては、現在、ネットワーク スイッチの冗長性を上げて、仮に 1 つのネットワーク スイッチに問題が生じた場合にも、もう 1 つのネットワーク スイッチで問題なく配下の物理ホスト サーバーおよび VM が稼働を続けることができるよう、日々 Azure プラットフォーム側の改善に努めております。</p></div><hr><h2 id="■-再起動を必要としないメンテナンスとは"><a href="#■-再起動を必要としないメンテナンスとは" class="headerlink" title="■ 再起動を必要としないメンテナンスとは ?"></a>■ 再起動を必要としないメンテナンスとは ?</h2><p>Azure では、物理ホスト サーバー群とその上で複雑に制御された機能をつかさどる各プロセスが稼働しており、これらは新しいバージョンのリリースと共に更新が必要となります。これらの更新作業が、再起動を必要としないメンテナンスに該当します。</p><blockquote><p>参考文献) 再起動を必要としないメンテナンス<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-and-updates#maintenance-that-doesnt-require-a-reboot">https://learn.microsoft.com/ja-jp/azure/virtual-machines/maintenance-and-updates#maintenance-that-doesnt-require-a-reboot</a></p></blockquote><p>ほとんどのプラットフォーム更新は、お客様の VM に影響しません。しかしながら影響を及ぼさない更新が不可能な場合、Azure は、お客様の <strong>VM への影響が最小となる更新メカニズム</strong> を利用して更新を行います。</p><h3 id="■-影響が最小となる更新メカニズムとは"><a href="#■-影響が最小となる更新メカニズムとは" class="headerlink" title="■ 影響が最小となる更新メカニズムとは ?"></a>■ 影響が最小となる更新メカニズムとは ?</h3><p>Windows Azure から Azure に名前が変更された 2014 年頃には、物理ホスト サーバーのモジュールの更新であったとしても、メンテナンスとして物理ホスト サーバーの再起動が必要となる場合があり、メンテナンスに伴いお客様の VM は毎回数分間の停止が必要でした。</p><p>このようなお客様への影響を可能な限り最小限にするため、Azure は投資、開発、改善を行い続けている結果、多くのメンテナンスでほとんどお客様が影響を感じないメンテナンスを実現することが可能となりました。</p><p>再起動を必要としないメンテナンスとしては下記のようなものがございます。</p><blockquote><p>参考文献) 影響がゼロまたは影響の少ないメンテナンス テクノロジの進化の変遷<br><a href="https://azure.microsoft.com/ja-jp/blog/advancing-noimpact-and-lowimpact-maintenance-technologies/">https://azure.microsoft.com/ja-jp/blog/advancing-noimpact-and-lowimpact-maintenance-technologies/</a></p></blockquote><blockquote><p>参考文献) Advancing failure prediction and mitigation—introducing Narya<br><a href="https://azure.microsoft.com/en-us/blog/advancing-failure-prediction-and-mitigation-introducing-narya/">https://azure.microsoft.com/en-us/blog/advancing-failure-prediction-and-mitigation-introducing-narya/</a></p></blockquote><h4 id="プラン-A-ホット-パッチ"><a href="#プラン-A-ホット-パッチ" class="headerlink" title="プラン A: ホット パッチ"></a>プラン A: ホット パッチ</h4><p>ホット パッチは、VM に一切ダウンタイムを生じさせることなく、物理ホスト サーバー上の実行中のプロセスに対して変更を行うことができるものであり、Azure では物理ホスト サーバーの更新プログラムを適用する際にできる限り使用しています。これは、物理ホスト サーバー上の機能を新たに呼び出す際、更新されたバージョンにリダイレクトすることで実現しています。</p><p>Azure では 2017 年からホット パッチを使用しており、それ以降、ホット パッチを使用できる範囲の拡大に取り組んでいます。たとえば 2018 年には、ハイパーバイザーに対してホット パッチが使用可能となりました。将来的には、さらなるカスタマー エクスペリエンスの向上のため、これまで “更新にはサーバーの再起動がつきもの” とされてきた Firmware への対応のため、ハードウェア メーカーと連携して検討を勧めています。</p><div class="alert is-important"><p class="alert-title">重要</p><p>ホットパッチのデモは、以下のビデオにて公開されています。</p><p>仮想化ホスト OS における特定のドライバーの置き換えが、人間には認識できないほどのわずかな時間にて成功しています。</p><p>このようなドライバーの更新は、たった 1 つのモジュールの置き換えであっても一般的な OS ではシステム再起動が</p><p>必須となっていたものですが、Azure OS ではこの一部についてはシステムを一切停止させずに更新していくことが可能となっています。</p><blockquote><p>[YouTube] <a href="https://www.youtube.com/watch?v=t3Vo37V9oU8&t=4216s">Inside Azure Datacenter Architecture with Mark Russinovich : Build 2018</a></p></div></blockquote><iframe width="560" height="315" src="https://www.youtube.com/embed/t3Vo37V9oU8?start=4216" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><p>大規模なホスト更新プログラムの中には、機能レベルのホット パッチでは適用できない変更が含まれているものもございます。それらの更新プログラムについては、メモリ保持メンテナンスを使用するようにしています。</p><h4 id="プラン-B-メモリ保持メンテナンス"><a href="#プラン-B-メモリ保持メンテナンス" class="headerlink" title="プラン B: メモリ保持メンテナンス"></a>プラン B: メモリ保持メンテナンス</h4><p>メモリ保持メンテナンスでは、RAM 内のメモリを保持して VM を “一時停止 (Freeze)” し、物理ホスト サーバーの更新を実施します。更新完了後には VM を再開し、クロックを自動的に同期する作業を実施します。</p><p>Azure では 2018 年からメモリ保持メンテナンスを使用しており、それ以降、3 つの観点で機能の向上を図ってきました。1 つ目は、物理ホスト サーバーを再起動せずに更新が実施できるホスト コンポーネントを対象とした影響の少ないメモリ保持メンテナンスのバリエーションの開発、2 つ目は、VM で発生する一時停止時間の短縮、3 つ目は、メモリ保持メンテナンスによって更新できる VM の種類の拡充です。</p><div class="alert is-important"><p class="alert-title">重要</p><p>メモリ保持メンテナンスのデモは、以下のビデオにて公開されています。</p><p>3D グラフィックスによるリアルタイムな映像が表示されていますが、1 秒未満のゲスト VM の停止時間にて、ホスト OS 側のドライバーの更新を行うことに成功しています。</p><blockquote><p>[YouTube] <a href="https://www.youtube.com/watch?v=t3Vo37V9oU8&t=4149s">Inside Azure Datacenter Architecture with Mark Russinovich : Build 2018</a></p></div></blockquote><iframe width="560" height="315" src="https://www.youtube.com/embed/t3Vo37V9oU8?start=4149" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe><div class="alert is-warning"><p class="alert-title">警告</p><p>現状、メモリ保持メンテナンスはさまざまな技術的理由により、M、N、H シリーズなど特定の VM サイズ シリーズに対応できておりません。</p><p>このようなまれなケースでは、より影響の大きな (ホストの再起動や、VM の再展開などを伴う) メンテナンスを行う必要があるため、お客様には事前に通知し、それぞれのワークロードに適したタイミングでメンテナンスを実行できるようにしています。</p></div><h3 id="■-メモリ保持メンテナンスについて"><a href="#■-メモリ保持メンテナンスについて" class="headerlink" title="■ メモリ保持メンテナンスについて"></a>■ メモリ保持メンテナンスについて</h3><p>上記のように、ホットパッチでの対応が難しいものについてはメモリ保持メンテナンスが実施されます　 (逆に言うと、多くのメンテナンスがメモリ保持メンテナンスを用いずにホットパッチ機能を利用して更新が行われるように改善が進められました　)。</p><p>ドキュメントにはこのメンテナンスは通常、最長で 30 秒間といった記載がございます。<br>この記載がメンテナンスは 30 秒間で必ず完了するものといった誤解を生むことにつながりました。</p><h3 id="■-メンテナンス時間-30-秒間について"><a href="#■-メンテナンス時間-30-秒間について" class="headerlink" title="■ メンテナンス時間 30 秒間について"></a>■ メンテナンス時間 30 秒間について</h3><p>Azureをご利用いただく上で必要となるこれらのメンテナンスに対して、少しでもお客様に影響を与えないようカスタマー エクスペリエンスの向上を続けております。<br>その結果、メモリ保持メンテナンスであったとしても、ほとんどのメンテナンスで、99 パーセンタイル (P99) において Azure 基盤側の更新処理が 30 秒以内に完了できるようになりました。</p><div class="alert is-info"><p class="alert-title">Note</p><p>パーセンタイルとは、主に統計で使われる用語であり、最小値から並べてその値がどの位置にいるかを示す単位となります。</p><p>つまり P99 の場合、”99/100 番目の位置は 30 秒以内である” =&gt; “ほぼ 30 秒以内に終わる” ことを示しています。</p></div><p>しかしながら、100　% 完了とはなっておらず、お客様によっては、どうしても 30 秒以上の影響を受けてしまう状況が発生してしまうことは、現在に至っても避けられてはおりません。</p><p>メンテナンス内容によっても影響範囲が大きいもの、小さいものがございます。</p><p>例えば、ホスト サーバー上で動作するモジュールの置き換えであれば、ホットパッチまたは軽微なメモリ保持メンテナンスで解決いたしますが、ホスト サーバーのオペレーティングシステムの (カーネルを含むような) 更新を伴うような大きなメンテナンスの場合には、メモリ保持メンテナンスであったとしても、その影響が色濃く表れることもございます。</p><p>ご利用いただいている VM のオペレーティングシステムにより、古い Linux OS (カーネル) を利用されている場合には、想定以上にメンテナンスに対する影響の時間が長くなることもございます。<br>また、OS だけでなく、ネットワーク インフラストラクチャーにおける更新作業についても、OS やお客様の VM 自体を停止するものではありませんが、TCP/IP の自動的なリトライ ロジックを超えて瞬断が発生する可能性がございます。</p><p><span style="text-decoration:underline;">メンテナンスの影響時間は適用される更新プログラムやその内容により大きく左右されるため、一概にメンテナンス全体で 30 秒間影響を受けるものでは無く、また影響の大きなメンテナンス (メモリ保持メンテナンス) であった場合、多くのお客様で 30 秒以内にメンテナンスが収まっていたとしても、100 % のお客様で 30 秒以内にメンテナンスが完了することをお約束することは叶いません。</span></p><div class="alert is-info"><p class="alert-title">Note</p><p>Azure Virtual Machine の SLA も、これらのメンテナンスの改善と関連し向上しています。</p><p>Azure において、2022 年 10 月現在、過去最後に VM の再起動を伴う大規模なメンテナンスを行ったものは、2018 年 1 月 3 日頃のものとなっております。</p><p>※ 一部リージョンのハードウェアの更改に伴い、VM の再起動を伴うメンテナンスが発生することは局所的に存在します。</p><p>　</p><p>このような背景から、2018 年 3 月には、Azure Virtual Machine の SLA からメンテナンスに関連するダウンタイムの除外を削除しています。</p><p>つまり、たとえ計画されたメンテナンスであったとしても、お客様の VM に分単位のダウンタイムをもたらした場合には、合計 SLA に影響するということとなっています。　</p><blockquote><p>参考文献) Virtual Machines の SLA</p><p><a href="https://azure.microsoft.com/ja-jp/support/legal/sla/virtual-machines/v1_9/">https://azure.microsoft.com/ja-jp/support/legal/sla/virtual-machines/v1_9/</a></p><p>参照箇所: バージョン履歴</p><p>1.7 最終更新: 2018 年 3 月</p><p>リリース ノート:単一インスタンス仮想マシンメンテナンスに関連するダウンタイムの除外を削除</p></div></blockquote><div class="alert is-info"><p class="alert-title">Note</p><p>SLA ダウンタイムは分単位で計算されます。月間での合計 SLA がお客様の VM の稼働時間に対して 99.9 % (単一インスタンス / Premium SSD または Ultra ディスクの場合) を下回る場合に返金となります。　</p><blockquote><p>月間稼働率 (%) = (月内時間 (分) - ダウンタイム) / 月内時間 (分) x 100</p></div></blockquote><hr><h2 id="■-おわりに"><a href="#■-おわりに" class="headerlink" title="■ おわりに"></a>■ おわりに</h2><p>Azure では、引き続きメンテナンスに伴うお客様への影響時間短縮も含めたカスタマー エクスペリエンスの向上に尽力しています。また、将来を見据えて可用性と信頼性を確保するために機械学習ベースの洞察と自動化に多大な投資を行っています。</p><p>現時点では 30 秒程度との記載がございますが、このようなメンテナンスへの私たちの取り組みと、今後もより一層お客様が安心、信頼し Azure をご利用いただけるよう改善を続けていく思いを込めた記載であることをご理解いただけますと幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;Azure テクニカル サポートチームの鳥越です。&lt;/p&gt;
&lt;p&gt;Azure をご利用いただいているお客様の中にはメンテナンスによる影響を経験された方もいらっしゃるかと存じます。&lt;br&gt;クラウド環境として、新機能の導入や更なる安定稼働を進めていく上で、このメンテナンスは必要不可欠なものです。&lt;br&gt;しかしながら、このメンテナンスといった言葉の中には、どのようなメンテナンスなのかがよくわからないといったご不安もあるかと推察します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="maintenance" scheme="https://jpaztech.github.io/blog/tags/maintenance/"/>
    
  </entry>
  
  <entry>
    <title>AKS に問題が発生した際にお寄せいただきたい情報について</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-collect-logs/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-collect-logs/</id>
    <published>2022-10-13T00:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.067Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの山下です。</p><p>今回は、ご利用いただいている AKS に問題（Pod に接続できない、Pending の状態となっている、等) が発生し、弊サポートチームにお問い合わせをいただく際に採取いただきたい情報についてご紹介します。</p><span id="more"></span><hr><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>弊サポートチームでは、日々多くのお客様より AKS で発生した問題のご支援をしております。その際、状況の把握のためにいくつかのコマンドの実行をお願いしております。<br>本記事では、お問い合わせ前にお客様にて情報採取を可能とすることや、コマンドの内容に齟齬が生まれないようにすることを目的として、実行いただくコマンドをご紹介いたします。  </p><hr><h2 id="必要な権限について"><a href="#必要な権限について" class="headerlink" title="必要な権限について"></a>必要な権限について</h2><p>kubectl コマンドを実行し、各ネームスペースから関連するリソースを取得できる権限が必要になります。<br>具体的には、Kubernetes RBAC を使用している AKS クラスターであれば「Azure Kubernetes Service クラスター ユーザー ロール」、Azure RBAC を使用している AKS クラスターであれば「Azure Kubernetes Service RBAC 管理者」または「Azure Kubernetes Service RBAC クラスター管理者」の権限が必要となります。</p><blockquote><p>参考）</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/aks/concepts-identity">Azure Kubernetes Service (AKS) でのアクセスと ID オプション</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/aks/control-kubeconfig-access">Azure ロールベースのアクセス制御を使用して、Azure Kubernetes Service (AKS) 内の Kubernetes 構成ファイルへのアクセス権を定義する</a></li></ul></blockquote><p>お客様にて何らかの異常を検知されたことでお問い合わせをいただいた際に、コマンドの実行をご案内したところ、お問い合わせいただいた方はコマンドを実行するための権限をお持ちではなかったため、情報の採取ならびに解決までにお時間を要してしまったケースも残念ながら過去に複数ございました。</p><p>そのような時に、「サポートの方で基盤から確認してもらえないか」「代わりにコマンドを実行して確認してもらえないか」といったご相談をいただくこともございました。</p><p>しかしながら、Azure ではお客様のデータを保護する観点から、我々サポートチームからお客様環境にコマンドを実行して取得する、といった仕組みがございませんため、そのようなご相談をお受けすることが残念ながら叶いません。  </p><p>正常性を監視されている方には必要な権限を付与していただく、または情報のご取得ができる方へのエスカレーションができるよう、緊急時のプロセスをお客様内で確立していただくことを予めご検討くださいますよう、何卒お願い申し上げます。</p><hr><h2 id="取得いただきたい情報"><a href="#取得いただきたい情報" class="headerlink" title="取得いただきたい情報"></a>取得いただきたい情報</h2><p>それでは問題が発生している AKS クラスターより情報を採取するためのコマンドを以下にご案内いたします。お問い合わせいただく際には、下記コマンドの実行結果とともに、どのリソース (Pod/Service 等) で問題が発生しているかをお寄せください。問題の内容によっては必ずしも必要ではない情報もございますが、本記事では多くの状況に対応するという観点で網羅的に記載しておりますので、冗長な点はご容赦頂ければ幸いです。<br>実行した結果、何も出力されなかった場合や、kubectl コマンドの実行が失敗する場合には、その旨を弊サポートチームまでお知らせくださいますと幸いです。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl get nodes -o wide &gt; get_nodes.txt</span><br><span class="line">kubectl describe nodes &gt; describe_nodes.txt</span><br><span class="line">kubectl get pod -A -o wide &gt; get_pods.txt</span><br><span class="line">kubectl describe pods -A &gt; describe_pods.txt</span><br><span class="line">kubectl get svc -A &gt; get_svc.txt</span><br><span class="line">kubectl describe svc -A &gt; describe_svc.txt</span><br><span class="line">kubectl describe ep -A &gt; describe_ep.txt</span><br><span class="line">kubectl get ingress -A -o yaml &gt; ingress.yaml</span><br><span class="line">kubectl get networkpolicy -A -o yaml &gt; networkpolicy.yaml</span><br><span class="line">kubectl logs &lt;対象の pod 名&gt; -n &lt;pod の namespace&gt; --timestamps=true &gt; &lt;pod 名&gt;.log</span><br><span class="line">kubectl logs &lt;対象の pod 名&gt; -n &lt;pod の namespace&gt; --timestamps=true -p &gt; &lt;pod 名&gt;_p.log</span><br></pre></td></tr></table></figure><hr><h3 id="補足事項"><a href="#補足事項" class="headerlink" title="補足事項"></a>補足事項</h3><p>Azure Portal からお問い合わせをいただく際、ファイルを複数添付できないという制限がございます。ご提供いただく際には一つのファイルに圧縮したうえで添付いただく、もしくはお問い合わせ後に弊サポートチームよりお知らせするアップロードサイトにてご提供いただきますようお願い申し上げます。</p><p>本稿が少しでも皆様のご参考となれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの山下です。&lt;/p&gt;
&lt;p&gt;今回は、ご利用いただいている AKS に問題（Pod に接続できない、Pending の状態となっている、等) が発生し、弊サポートチームにお問い合わせをいただく際に採取いただきたい情報についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
    <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
  <entry>
    <title>アンマネージド ディスクを使用している仮想マシンのマネージド ディスクへの移行について</title>
    <link href="https://jpaztech.github.io/blog/vm/unmanaged-disk-retired/"/>
    <id>https://jpaztech.github.io/blog/vm/unmanaged-disk-retired/</id>
    <published>2022-10-12T03:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.415Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの木下です。<br>今回は、度々お問い合わせいただきます、アンマネージド ディスク (非管理ディスク) を使用している仮想マシンのマネージド ディスク (管理ディスク) への移行についてご紹介いたします。</p><span id="more"></span><hr><p>2017 年にマネージド ディスク (管理ディスク) がリリースされて以降、マネージド ディスクの機能強化が行われてきました。今後もマネージド ディスクの機能向上に備えるため、2022 年 9 月 30 日以降、アンマネージド ディスクは非推奨となり、2025 年 9 月 30 日をもちまして廃止が予定されております。</p><div class="alert is-important"><p class="alert-title">重要</p><p>Azure の更新情報や Tracking ID: JTP9-JD0 にて周知されている情報となります。</p><p>参考）Azure unmanaged disks will be retired on 30 September 2025</p><p><a href="https://azure.microsoft.com/ja-jp/updates/azure-unmanaged-disks-will-be-retired-on-30-september-2025/">https://azure.microsoft.com/ja-jp/updates/azure-unmanaged-disks-will-be-retired-on-30-september-2025/</a></p></div><p>上記の通り、2025 年 9 月 30 日以降、アンマネージド ディスクを使用している仮想マシンは利用できなくなりますので、この期日までにアンマネージド ディスクを使用している仮想マシンをマネージド ディスクへ移行する必要があります。</p><div class="alert is-info"><p class="alert-title">Note</p><p>Azure 更新情報 URL 内に記載の “Page blobs will not be affected by this change.” の箇所につきまして補足いたします。</p><p>アンマネージド ディスクは Azure ストレージ内にページ BLOB として格納した VHD ファイルであり、これを仮想マシンにて利用しております。</p><p>今回、アンマネージド ディスクは 2025 年 9 月 30 日をもって廃止となり、アンマネージド ディスクを使用している仮想マシンは利用できなくなりますが、Azure ストレージ内に格納されている VHD ファイル (ページ BLOB) 自体が削除されることはございません。この点はご安心くださいませ。</p></div><p>お客様のご利用の環境において、アンマネージド ディスクを使用した仮想マシンが存在するのかどうかを確認し、存在する場合は計画的にマネージド ディスクへの移行を行いましょう。</p><hr><h2 id="1-アンマネージド-ディスクを使用している仮想マシンが存在するかの確認"><a href="#1-アンマネージド-ディスクを使用している仮想マシンが存在するかの確認" class="headerlink" title="1. アンマネージド ディスクを使用している仮想マシンが存在するかの確認"></a>1. アンマネージド ディスクを使用している仮想マシンが存在するかの確認</h2><p>アンマネージド ディスクを使用している仮想マシンが存在するかどうかは Azure Portal や Azure CLI でご確認いただくことができます。</p><h3 id="▼-Azure-Portal-を使用する場合"><a href="#▼-Azure-Portal-を使用する場合" class="headerlink" title="▼ Azure Portal を使用する場合"></a>▼ Azure Portal を使用する場合</h3><p>[Azure Portal] &gt; [仮想マシン (Virtual Machines)] ＞ [ビューの管理] &gt; [列の編集] をクリックします。</p><p><img src="/blog/vm/unmanaged-disk-retired/01.png"></p><p>[+ 列の追加] をクリックします。</p><p><img src="/blog/vm/unmanaged-disk-retired/02.png"></p><p>[マネージド ディスクを使用する] を選択し、保存します。</p><p><img src="/blog/vm/unmanaged-disk-retired/03.png"></p><p>[マネージド ディスクを使用する] の項目が追加されます。</p><p><img src="/blog/vm/unmanaged-disk-retired/04.png"></p><p>マネージド ディスクを使用している場合は「はい」、アンマネージド ディスクを使用している場合は「いいえ」と表示されます。<br>この項目が「いいえ」の場合、アンマネージド ディスクを使用した仮想マシンとなりますので、マネージド ディスクへの移行が必要であるとご判断いただくことが可能です。</p><h3 id="▼-Azure-CLI-を使用する場合"><a href="#▼-Azure-CLI-を使用する場合" class="headerlink" title="▼ Azure CLI を使用する場合"></a>▼ Azure CLI を使用する場合</h3><p>コマンド例：</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ vmids=$(az vm list --query [].id -o tsv)</span><br><span class="line">$ az vm show --ids <span class="variable">$vmids</span> --query <span class="string">&quot;[].&#123;vmname:name, rgname:resourceGroup, unmanageddisk:storageProfile.osDisk.vhd.uri&#125;&quot;</span> -o table</span><br><span class="line">Vmname    Rgname    Unmanageddisk</span><br><span class="line">--------  --------  ----------------------------------------------------</span><br><span class="line">testvm01  testrg01</span><br><span class="line">testvm02  testrg02  https://sample.blob.core.windows.net/vhds/sample.vhd</span><br></pre></td></tr></table></figure><p>[Unmanageddisk] 項目に VHD ファイルの URL が表示されている仮想マシンは、マネージド ディスクを使用した仮想マシンとなります。</p><h3 id="▼-Azure-PowerShell-を使用する場合"><a href="#▼-Azure-PowerShell-を使用する場合" class="headerlink" title="▼ Azure PowerShell を使用する場合"></a>▼ Azure PowerShell を使用する場合</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PS /home/azureuser&gt; Get-AzVM -Status | Select-Object Name,ResourceGroupName,@&#123;Name=<span class="string">&quot;Unmanaged Disk&quot;</span>; Expression=&#123;<span class="variable">$_</span>.StorageProfile.OsDisk.Vhd.Uri&#125;&#125;</span><br><span class="line"></span><br><span class="line">Name                ResourceGroupName   Unmanaged Disk</span><br><span class="line">----                -----------------   --------------------------------</span><br><span class="line">testvm01            testrg01 </span><br><span class="line">testvm02            testrg02            https://sample.blob.core.windows.net/vhds/sample.vhd</span><br></pre></td></tr></table></figure><p>[Unmanaged Disk] 項目に VHD ファイルの URL が表示されている仮想マシンは、マネージド ディスクを使用した仮想マシンとなります。</p><hr><h2 id="2-マネージド-ディスクへの移行方法"><a href="#2-マネージド-ディスクへの移行方法" class="headerlink" title="2. マネージド ディスクへの移行方法"></a>2. マネージド ディスクへの移行方法</h2><p>アンマネージド ディスクからマネージド ディスクへの移行は、管理層を移行するという挙動となりますため、ディスクに格納されているデータ量に関わらず数分程度で完了することが想定となります。<br>ただし、移行操作に伴い VM の停止処理が発生しますので、この点は予めご留意いただきますようお願いいたします。</p><p>アンマネージド ディスクを使用した仮想マシンをマネージド ディスクへ移行する手順としては以下となります。</p><p>1.Azure Portal より対象の VM を選択します。</p><p>2.対象 VM の  OS・データ ディスクの VHD ファイルが格納されている Azure ストレージ アカウントを確認します。</p><p><img src="/blog/vm/unmanaged-disk-retired/05.png"></p><p>OS・データ ディスクの各 [VHD の URI] 箇所より Azure ストレージ アカウント名を確認することができます。</p><p><img src="/blog/vm/unmanaged-disk-retired/06.png"></p><p><img src="/blog/vm/unmanaged-disk-retired/07.png"></p><p>3.[ディスク] ブレードの上部 [マネージド ディスクに移行] 項目をクリックします。</p><p><img src="/blog/vm/unmanaged-disk-retired/08.png"></p><p>4.マネージド ディスクへの移行画面に遷移しますので、[移行] をクリックします。</p><p><img src="/blog/vm/unmanaged-disk-retired/09.png"></p><ol start="5"><li>VM が停止し、移行が開始されます。(約 2-3 分程度で完了します)</li></ol><p><img src="/blog/vm/unmanaged-disk-retired/10.png"></p><p>6.マネージド ディスクに変換されたことを確認します。</p><p><img src="/blog/vm/unmanaged-disk-retired/11.png"></p><p>7.1 で確認した対象の Azure ストレージ アカウントのコンテナー内から VHD ファイル自体は削除されていないことを確認します。</p><p><img src="/blog/vm/unmanaged-disk-retired/12.png"></p><p><img src="/blog/vm/unmanaged-disk-retired/13.png"></p><p>マネージド ディスクへの移行方法の詳細や注意事項については以下公開情報にておまとめしておりますのでご参考ください。<br>なお、マネージド ディスクへの移行は必ずテスト環境等で検証を行っていただいた上でご実施いただきますようお願いいたします。</p><blockquote><p>参考）</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/convert-unmanaged-to-managed-disks">Windows 仮想マシンをアンマネージド ディスクからマネージド ディスクに移行する</a></li><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/convert-unmanaged-to-managed-disks">Linux 仮想マシンをアンマネージド ディスクからマネージド ディスクに移行する</a></li></ul></blockquote><hr><h2 id="3-マネージド-ディスクを利用することの利点や価格"><a href="#3-マネージド-ディスクを利用することの利点や価格" class="headerlink" title="3. マネージド ディスクを利用することの利点や価格"></a>3. マネージド ディスクを利用することの利点や価格</h2><p>マネージド ディスクをご利用いただくことによって得られる利点や価格に関しましては以下におまとめしておりますので、必要に応じてこちらもご参照ください。</p><blockquote><p>参考）</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/managed-disks-overview#benefits-of-managed-disks">マネージド ディスクの利点</a></li><li><a href="https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/">Managed Disks の価格</a></li><li><a href="https://azure.microsoft.com/ja-jp/pricing/details/storage/page-blobs/">Unmanaged Disk Azure ページ BLOB の価格</a></li></ul></blockquote><p>なお、アンマネージド ディスクの Standard HDD では、実際に格納しているデータ量に応じた課金となっておりましたが、マネージド ディスクでは Standard HDD も含め、ディスク リソースとしてプロビジョニングされたディスク サイズに対して課金が発生いたします。移行に伴い課金額に差異が発生する可能性がある点について、予めご認識いただけますと幸いです。</p><p>マネージド ディスクについてよく寄せられるご質問をおまとめした公開情報のご用意もございますので、こちらも併せてご参考ください。</p><blockquote><p>参考）</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/faq-for-disks">Azure IaaS VM ディスクと Premium マネージド ディスクおよびアンマネージド ディスクについてよく寄せられる質問</a></li></ul></blockquote><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの木下です。&lt;br&gt;今回は、度々お問い合わせいただきます、アンマネージド ディスク (非管理ディスク) を使用している仮想マシンのマネージド ディスク (管理ディスク) への移行についてご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Managed Disk" scheme="https://jpaztech.github.io/blog/tags/Managed-Disk/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>Azureで仮想マシン名を変更する</title>
    <link href="https://jpaztech.github.io/blog/vm/how-to-rename-vm/"/>
    <id>https://jpaztech.github.io/blog/vm/how-to-rename-vm/</id>
    <published>2022-09-29T00:30:00.000Z</published>
    <updated>2022-12-22T05:56:35.283Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チーム、インターン生の杉野です。</p><p>お客様より、リソース管理の都合上、既存の仮想マシンのリソース名を変更したいというお問い合わせをいただくことがあります。</p><p>ゲスト OS 内のホスト名は、ゲスト OS 内よりすぐに変更いただくことが可能です。<br>しかしながら、Azure のリソース名である仮想マシン名は Azure Portal 等より変更することは叶わず、変更実施する場合には仮想マシンの再作成が必要となります。<br>そこで今回は、仮想マシン名を変更する方法およびその注意点についてご紹介いたします。</p><span id="more"></span><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ol><li>仮想マシン名とは</li><li>変更手順</li><li>[おまけ] 仮想マシン名の代わりにタグでも管理できる</li></ol><hr><h2 id="1-仮想マシン名とは"><a href="#1-仮想マシン名とは" class="headerlink" title="1. 仮想マシン名とは"></a>1. 仮想マシン名とは</h2><p>今回変更する “仮想マシン名” とは、Azure のリソースとして表示される名前を指しています。<br>Azure Portal にて仮想マシンを選択し、左メニュー [概要] を選択した画面に表示される “コンピューター名” や、ゲスト OS 内で表示される “コンピューター名”、”ホスト名” とは異なりますのでご注意ください。<br>ただし、Azure Marketplace や一般化されたイメージより、新規に仮想マシンを作成した場合には、仮想マシン名と同名にて “コンピューター名” や “ホスト名” が設定されます。</p><p><img src="/blog/vm/how-to-rename-vm/01.png"></p><p>ゲスト OS 内の “コンピューター名” や “ホスト名” は、管理のためにシステム名などに基づき命名されることが多いかと思います。<br>当該環境の用途が変更となった場合には、管理の観点から新しいシステムに応じて名前を変える必要がありますが、それにより、ゲスト OS 内の名前と Azure リソースとしての仮想マシン名が異なってしまった場合にも管理が複雑となってしまうことが想定されます。</p><hr><h2 id="2-変更手順"><a href="#2-変更手順" class="headerlink" title="2. 変更手順"></a>2. 変更手順</h2><p>冒頭に記載した通り、Azure のリソース名を簡単に変える方法はなく、今回の場合は仮想マシンの再作成が必要となります。<br>再作成手順の概要は以下の通りとなります。</p><ul><li>事前準備: 引き継ぎたい情報を確認する</li><li>手順 1: 仮想マシンを削除する</li><li>手順 2: 仮想マシンを新しい名前で作成する</li></ul><h3 id="事前準備-引き継ぎたい情報を確認する"><a href="#事前準備-引き継ぎたい情報を確認する" class="headerlink" title="事前準備: 引き継ぎたい情報を確認する"></a>事前準備: 引き継ぎたい情報を確認する</h3><p>再作成時には、元の仮想マシンと同様の設定を実施する必要があるかと思いますので、事前に構成を控えておくことをお勧めします。<br>下記に項目の例を紹介しますが、その他必要な設定および構成がある場合は、適宜控えておきましょう。</p><h4 id="仮想マシン-左メニュー-概要"><a href="#仮想マシン-左メニュー-概要" class="headerlink" title="仮想マシン - 左メニュー [概要]"></a>仮想マシン - 左メニュー [概要]</h4><p>[必須項目]</p><ul><li>リソース グループ名</li><li>場所 (リージョン)</li><li>仮想マシンのサイズ</li><li>パブリック IP アドレス (利用している場合)<br>※ IP アドレスが表示されている場合にはクリックし、リソース名を確認します。</li><li>仮想ネットワーク / サブネット名</li></ul><p><img src="/blog/vm/how-to-rename-vm/05.png"></p><p>[設定がある場合]</p><ul><li>可用性とスケーリング (可用性セットまたは可用性ゾーン)</li></ul><p><img src="/blog/vm/how-to-rename-vm/06.png"></p><h4 id="仮想マシン-左メニュー-ネットワーク"><a href="#仮想マシン-左メニュー-ネットワーク" class="headerlink" title="仮想マシン - 左メニュー [ネットワーク]"></a>仮想マシン - 左メニュー [ネットワーク]</h4><div class="alert is-warning"><p class="alert-title">警告</p><p>既存の VNET/ Subnet、NIC をご利用いただく場合、既存の NSG 等との紐づけが実施されたままとなりますので、再設定は不要となります。</p></div><p>[元の NIC を使う場合]</p><ul><li>ネットワーク インターフェイス名 (複数の場合はすべて) を控えます。</li></ul><div class="alert is-info"><p class="alert-title">Note</p><p><strong>NIC は引き継げる ?</strong></p><p>Azure PowerShell や Azure CLI を用いて仮想マシンを作成する場合には既存の NIC を指定することが可能ですが、Azure Portal から仮想マシンを作成いただく場合には指定することは現状叶いません。</p><p>Azure Portal から操作を行いたい場合には、仮想マシン作成後に NIC の付け替えを実施いただく必要があります。</p></div><p>[元の NIC を使わない場合]<br>NSG や負荷分散等の設定は必要に応じて控えておきましょう。</p><p><img src="/blog/vm/how-to-rename-vm/20.png"></p><h4 id="仮想マシン-左メニュー-ディスク"><a href="#仮想マシン-左メニュー-ディスク" class="headerlink" title="仮想マシン - 左メニュー [ディスク]"></a>仮想マシン - 左メニュー [ディスク]</h4><ul><li>OS ディスク名とデータ ディスク名 (複数の場合はすべて) を控えます。</li><li>全ディスクのホスト キャッシュ設定も忘れずに控えておきましょう。</li></ul><p><img src="/blog/vm/how-to-rename-vm/08.png"></p><h4 id="その他"><a href="#その他" class="headerlink" title="その他"></a>その他</h4><p>上記以外にも仮想マシンの再作成時に設定可能な項目は複数あります。必要な項目は控えておきましょう。</p><ul><li>Azure ハイブリッド特典の設定</li><li>近接配置グループ名</li><li>Azure Dedicated Host の使用の有無</li><li>容量予約の使用の有無</li><li>拡張機能名 (複数の場合はすべて)</li><li>VM アプリケーション (複数の場合はすべて)</li><li>自動シャットダウンの設定</li><li>バックアップの設定</li><li>ゲスト OS の更新プログラム</li><li>ゲスト OS 診断の設定</li><li>ブート診断の設定<br>など</li></ul><h3 id="手順-1-仮想マシンを削除する"><a href="#手順-1-仮想マシンを削除する" class="headerlink" title="手順 1: 仮想マシンを削除する"></a>手順 1: 仮想マシンを削除する</h3><div class="alert is-warning"><p class="alert-title">警告</p><p><strong>誤操作に備えて</strong></p><p>予期せぬご状況に備えるためにも、操作前には Azure Backup やディスクのスナップショット (要 OS シャットダウン) をご取得いただくことをお勧めします。</p><p>　</p><p>ご参考) Azure VM バックアップについて</p><p><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction</a></p><p>　</p><p>ご参考) 仮想ハード ディスクの Azure スナップショットを作成する</p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/snapshot-copy-managed-disk?tabs=portal">https://learn.microsoft.com/ja-jp/azure/virtual-machines/snapshot-copy-managed-disk?tabs=portal</a></p></div><p>以下の画面の通り、仮想マシンの [削除] をクリックします。</p><p><img src="/blog/vm/how-to-rename-vm/03.png"></p><p>[削除] をクリックした後に表示される確認画面にて、”強制削除の適用” や 各関連リソースの “VM で削除” のボックスにチェックが入っていないことを確認します。<br>問題がない場合には、削除について理解した文言にチェックを入れ、[削除] をクリックします。</p><p><img src="/blog/vm/how-to-rename-vm/02.png"></p><h3 id="手順-2-仮想マシンを新しい名前で作成する"><a href="#手順-2-仮想マシンを新しい名前で作成する" class="headerlink" title="手順 2: 仮想マシンを新しい名前で作成する"></a>手順 2: 仮想マシンを新しい名前で作成する</h3><p>削除した仮想マシンで使用していた OS ディスクより、控えた内容をもとに仮想マシンを作成します。</p><p>今回は、Azure Portal を使用して仮想マシンを作成し、その後、元の NIC を使用するために NIC の付け替えを実施する手順をご紹介します。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>今回の Azure Portal で仮想マシンを作成する手順の場合、新たな NIC が仮想マシンに接続されるため、MAC アドレスが変更されます。</p><p>Linux 仮想マシンの場合、設定ファイル内に MAC アドレスが含まれる可能性がありますので、ご注意いただけますと幸いです。</p><p>　</p><p>ご参考) ネットワーク インターフェイスの作成、変更、削除</p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-network-network-interface?tabs=network-interface-portal">https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-network-network-interface?tabs=network-interface-portal</a></p><p>抜粋：注意</p><blockquote><p>Azure では、ネットワーク インターフェイスの仮想マシンへのアタッチと、仮想マシンの初回起動の後にのみ、ネットワーク インターフェイスに MAC アドレスが割り当てられます。</p><p>Azure によってネットワーク インターフェイスに割り当てられる MAC アドレスは指定できません。</p><p>MAC アドレスがネットワーク インターフェイスに割り当てられると、そのネットワーク インターフェイスが削除されるか、プライマリ ネットワーク インターフェイスのプライマリ IP 構成に割り当てられたプライベート IP アドレスが変更されるまで、その状態は変わりません。</p><p>IP アドレスと IP 構成の詳細については、IP アドレスの管理に関するページをご覧ください。</p></div></blockquote><h4 id="仮想マシンの作成"><a href="#仮想マシンの作成" class="headerlink" title="仮想マシンの作成"></a>仮想マシンの作成</h4><ol><li><p>削除した仮想マシンで使用していた OS ディスク (控えていた OS ディスク名を参照) を選択します。<br><img src="/blog/vm/how-to-rename-vm/09.png"></p></li><li><p>OS ディスクの [概要] から [VM の作成] を選択します。<br><img src="/blog/vm/how-to-rename-vm/10.png"></p></li><li><p>先ほど控えた内容をもとに、仮想マシンを作成します。<br>以下に例を示しますが、各項目はご自身の環境に合わせて設定してください。</p><ul><li><p><strong>[基本] タブ</strong>：<br><img src="/blog/vm/how-to-rename-vm/19.png"></p><div class="alert is-warning"><p class="alert-title">警告</p><p>可用性オプション (可用性セットまたは可用性ゾーン) につきましては、仮想マシン作成時にのみ設定できる項目になりますので、ご利用いただく場合には忘れずにご設定ください。</p><p>　</p><p>可用性ゾーンをご指定いただく場合、ディスクで指定いただいているゾーンと同じゾーンを指定する必要がありますのでご注意ください。</p></div></li><li><p><strong>[ディスク] タブ</strong>：<br>既存のデータ ディスクを接続する場合は、 [ディスク] タブで [既存のディスクの接続] を選択します。<br>データ ディスクのホストのキャッシュ設定も控えたパラメータに設定します。<br><img src="/blog/vm/how-to-rename-vm/12.png"></p></li><li><p><strong>[ネットワーク] タブ</strong>：<br>既存のネットワーク インターフェースの接続は仮想マシン作成後に行います。そのため、この段階での “NIC ネットワーク セキュリティ グループ” の設定は不要です。<br>※ 既存の VNET/ Subnet、NIC をご利用いただく場合、既存の NSG との紐づけが実施されたままとなりますので、仮想マシン作成時に新たに NSG を設定いただく必要はございません。<br><img src="/blog/vm/how-to-rename-vm/13.png"></p></li><li><p>全ての設定が完了後、 [確認および作成] から[作成] をクリックします。<br><img src="/blog/vm/how-to-rename-vm/14.png"></p></li></ul></li><li><p>作成が完了すると新しく作成した仮想マシンを確認することができます。<br><img src="/blog/vm/how-to-rename-vm/15.png"></p></li></ol><h4 id="NIC-の付け替え"><a href="#NIC-の付け替え" class="headerlink" title="NIC の付け替え"></a>NIC の付け替え</h4><ol><li><p>仮想マシン作成後、既存 NIC を接続するため、仮想マシンを停止 (割り当て解除) します。<br><img src="/blog/vm/how-to-rename-vm/16.png"></p></li><li><p>仮想マシン停止 (割り当て解除) 後、仮想マシンのページから [ネットワーク] - [ネットワーク インターフェイスの接続] を選択し、削除した仮想マシンで使用していた NIC を接続します。<br><img src="/blog/vm/how-to-rename-vm/17.png"></p></li><li><p>既存の NIC の接続完了後も、仮想マシン作成時に作成された NIC がまだプライマリとなっているの状態なので、[ネットワーク インターフェイスのデタッチ] を選択し、分離する必要があります。<br><img src="/blog/vm/how-to-rename-vm/18.png"></p><p>NIC のデタッチを実施後、セカンダリとして接続した既存 NIC は自動的にプライマリとなります。<br>なお、デタッチした NIC については削除されても問題ありません。</p></li><li><p>仮想マシンを起動します。</p></li></ol><hr><h2 id="3-おまけ-仮想マシン名の代わりにタグでも管理できる"><a href="#3-おまけ-仮想マシン名の代わりにタグでも管理できる" class="headerlink" title="3. [おまけ] 仮想マシン名の代わりにタグでも管理できる"></a>3. [おまけ] 仮想マシン名の代わりにタグでも管理できる</h2><p>ここまでの内容の通り、Azure のリソースとしての仮想マシン名を変えるためには再作成が必要となり、構成の確認や再設定等、それなりの時間がかかることがお分かりいただけたかと思います。</p><p>そのため、仮想マシン名にすぐに変更されうる情報 (プロジェクト名や担当者名など) を使うと、後々に運用変更が発生した際に、異なる名前による管理の負荷や変更作業の負荷がかかる可能性があります。</p><p>それでは、どのように管理するのがよいのか。<br>Azure では、リソース管理に用いるタグという機能が用意されています。</p><blockquote><p>ご参考) リソースの名前付けとタグ付けの意思決定ガイド<br><a href="https://learn.microsoft.com/ja-jp/azure/cloud-adoption-framework/decision-guides/resource-tagging/?toc=/azure/azure-resource-manager/management/toc.json">https://learn.microsoft.com/ja-jp/azure/cloud-adoption-framework/decision-guides/resource-tagging/?toc=%2Fazure%2Fazure-resource-manager%2Fmanagement%2Ftoc.json</a></p></blockquote><blockquote><p>ご参考) タグを使用して Azure リソースと整理階層を整理する<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/resource-group-using-tags">https://docs.microsoft.com/ja-jp/azure/azure-resource-manager/resource-group-using-tags</a></p></blockquote><p><img src="/blog/vm/how-to-rename-vm/04.png"></p><p>変更されうる細かな情報をタグに記載しておけば、後からの変更も簡単にできます。<br>仮想マシンに付与するタグを変更する場合、仮想マシンの停止は不要であり、変更処理自体もお時間を要さないことが想定されています。(弊社環境での検証時には、数十秒程度で完了しました。)<br>リソースの管理手段として、ご参考となれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チーム、インターン生の杉野です。&lt;/p&gt;
&lt;p&gt;お客様より、リソース管理の都合上、既存の仮想マシンのリソース名を変更したいというお問い合わせをいただくことがあります。&lt;/p&gt;
&lt;p&gt;ゲスト OS 内のホスト名は、ゲスト OS 内よりすぐに変更いただくことが可能です。&lt;br&gt;しかしながら、Azure のリソース名である仮想マシン名は Azure Portal 等より変更することは叶わず、変更実施する場合には仮想マシンの再作成が必要となります。&lt;br&gt;そこで今回は、仮想マシン名を変更する方法およびその注意点についてご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Azure KMS の IP アドレスが変わります</title>
    <link href="https://jpaztech.github.io/blog/vm/azure-kms-update/"/>
    <id>https://jpaztech.github.io/blog/vm/azure-kms-update/</id>
    <published>2022-09-20T02:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.195Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの鳥越です。</p><p>近日中に新しい Azure KMS の IP アドレスがリリースされる予定となっております。<br>そこで本記事では、Azure KMS の IP アドレスに関する下記の資料の補足をご紹介します。</p><span id="more"></span><p>なお、下記ブログ記事も合わせてご参考いただけますと幸いです。</p><blockquote><p>ご参考) Azure Windows Virtual Machine Activation: two new KMS IP addresses (…and why you should care)<br><a href="https://techcommunity.microsoft.com/t5/azure-compute-blog/azure-windows-virtual-machine-activation-two-new-kms-ip/ba-p/3621189">https://techcommunity.microsoft.com/t5/azure-compute-blog/azure-windows-virtual-machine-activation-two-new-kms-ip/ba-p/3621189</a><br>ご参考) Generally available: New KMS DNS in Azure Global Cloud<br><a href="https://azure.microsoft.com/en-us/updates/new-kms-dns-in-azure-global-cloud/">https://azure.microsoft.com/en-us/updates/new-kms-dns-in-azure-global-cloud/</a></p></blockquote><hr><h2 id="〇-何が起こりますか"><a href="#〇-何が起こりますか" class="headerlink" title="〇 何が起こりますか?"></a>〇 何が起こりますか?</h2><p>2022 年 7 月に新しい Azure KMS の IP アドレスとして、20.118.99.224 と 40.83.235.53 の 2 つの新しい KMS IP アドレスを発表しました。</p><p>Azure グローバル クラウドの KMS サーバーの最初の DNS 名は azkms.core.windows.net で　20.118.99.224 および 40.83.235.53 を指し示します。<br>Azure グローバル クラウドの KMS サーバーの 2 番目の DNS 名は kms.core.windows.net で、IP アドレスは 23.102.135.246 です。</p><p>つまり、カスタム ルート構成を行っている環境では、Azure グローバル クラウドの 3 つの IP アドレスすべてをカスタム ルートに追加する必要があります。</p><hr><h2 id="〇-どのような影響がありますか"><a href="#〇-どのような影響がありますか" class="headerlink" title="〇 どのような影響がありますか?"></a>〇 どのような影響がありますか?</h2><p>ほとんどの仮想マシンについて影響はないと考えられますが、旧来の Azure KMS の IPアドレス(23.102.135.246) を UDR などで登録している、または、kms.core.windows.net に対する URL アクセスを限定している環境については、azkms のエンドポイントを追加いただく必要がございます。</p><p>追加されない場合、仮想マシンは Azure KMS サーバーにアクセスできないため、以下のようなエラーメッセージが記録されます。</p><blockquote><p>「エラー: 0xC004F074 ソフトウェア ライセンス サービスで、コンピューターのライセンス認証ができなかったことが報告されました。キー管理サービス (KMS) に接続できませんでした。詳細については、アプリケーション イベント ログを参照してください。」</p></blockquote><p>動作影響に関して、認証に失敗した場合のライセンスの猶予期間は 180 日間です。<br>つまり、お客様の構成の関係で、新しい azkms エンドポイントにアクセスできなかった場合、前回のアクセス認証から 180 日間の猶予がありますので、慌てて対策を行う必要はありません。</p><p>また、実際のライセンス切れが発生した場合には、通知モード (ライセンス認証切れ状態) となりますが、こちらは仮想マシンの稼働に大きな影響 (強制シャットダウン、ログオン不可、サーバー / クライアント機能の使用制限など) を与えるものではありません。<br>なお、通知モードは、再度 KMS 認証を行い成功した際に解除されます。</p><p>そのため、今回の通知からの変更で間に合わなかった場合には、180 日間の猶予において対策を実施いただけますと幸いです。</p><blockquote><p>ご参考) Windows ライセンス認証が期限切れになるとどうなりますか?<br><a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-activation-problems#what-happens-if-windows-activation-period-expires">https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/troubleshoot-activation-problems#what-happens-if-windows-activation-period-expires</a></p></blockquote><hr><h2 id="〇-どのような対応が必要ですか"><a href="#〇-どのような対応が必要ですか" class="headerlink" title="〇 どのような対応が必要ですか?"></a>〇 どのような対応が必要ですか?</h2><p>以下のお客様については、新しい Azure KMS エンドポイントへのアクセス許可を追加いただくようお願いいたします。</p><p><strong>対象の構成</strong></p><blockquote><ul><li>UDR にて旧来の Azure KMS の IP アドレス (23.102.135.246) を指定している</li><li>エンドポイントを kms.core.windows.net のみに限定している</li></ul></blockquote><p><strong>必要な対応</strong><br>新しい KMS エンドポイントへのアクセス許可を追加</p><blockquote><ul><li>エンドポイント : azkms.core.windows.net</li><li>新しいKMS IP アドレス : 20.118.99.224 と 40.83.235.53</li></ul></blockquote><hr><h2 id="〇-新しい-Azure-KMS-エンドポイントへの接続確認方法"><a href="#〇-新しい-Azure-KMS-エンドポイントへの接続確認方法" class="headerlink" title="〇 新しい Azure KMS エンドポイントへの接続確認方法"></a>〇 新しい Azure KMS エンドポイントへの接続確認方法</h2><p>以下のコマンドを実施し、疎通に問題がないかご確認お願いいたします。</p><ol><li>PowerShell を開く</li><li>次のコマンドを実施する<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test-netconnection</span> azkms.core.windows.net <span class="literal">-port</span> <span class="number">1688</span> </span><br><span class="line"><span class="built_in">test-netconnection</span> <span class="number">20.118</span>.<span class="number">99.224</span> <span class="literal">-port</span> <span class="number">1688</span> </span><br><span class="line"><span class="built_in">test-netconnection</span> <span class="number">40.83</span>.<span class="number">235.53</span> <span class="literal">-port</span> <span class="number">1688</span> </span><br></pre></td></tr></table></figure></li></ol><p>接続が可能であれば特に対処は必要ありません。<br>接続が失敗した場合には、前項の「どのような対応が必要ですか?」をご確認いただき、設定変更をお願いいたします。</p><hr><h2 id="〇-補足事項"><a href="#〇-補足事項" class="headerlink" title="〇 補足事項"></a>〇 補足事項</h2><p>今回の変更ですが、今後多くのお客様が Azure を利用していく上で、Azure KMS サーバーを増強し、負荷上昇による認証失敗を解消するための措置となります。<br>今後も弊社 Azure インフラストラクチャの安定した稼働に努めてまいりますので、お手数をおかけしますが、作業についてご理解給われますと幸いです。</p><br>ご紹介は以上となります。上記情報がお役に立てれば幸いです。]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの鳥越です。&lt;/p&gt;
&lt;p&gt;近日中に新しい Azure KMS の IP アドレスがリリースされる予定となっております。&lt;br&gt;そこで本記事では、Azure KMS の IP アドレスに関する下記の資料の補足をご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>Azure Storage Explorer を用いて、コマンド無しで VM を別のリージョン・サブスクリプション・テナントに移動/複製をしてみよう</title>
    <link href="https://jpaztech.github.io/blog/vm/copy-vm-with-storage-explorer/"/>
    <id>https://jpaztech.github.io/blog/vm/copy-vm-with-storage-explorer/</id>
    <published>2022-08-22T05:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.207Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br> <br>Azure 上の VM およびマネージド ディスクについて、  </p><ul><li><strong>別のリージョンに移動/複製をしたい</strong>  </li><li><strong>別のサブスクリプションに移動/複製をしたい</strong>  </li><li><strong>別のテナントにあるサブスクリプションに移動/複製をしたい</strong>  </li></ul><p>というご要望をいただくことがございます。<br> <br>これらを実現する手段は幾つかありますが、<br>Azure Storage Explorer を使うと、上記のご要望がコマンド不要で全て GUI で完結することが可能です！<br>今回はこの方法についてスクリーンショットを交えて紹介させていただきます。     </p><hr><h1 id="手順の概要について"><a href="#手順の概要について" class="headerlink" title="手順の概要について"></a>手順の概要について</h1><p> <br>まず、大まかな流れについてご説明させていただきます。     </p><ul><li>Azure Storage Explorer をインストールする  </li><li>Azure Storage Explorer で対象のサブスクリプションに接続する  </li><li>対象の VM を割り当て解除（停止）する  </li><li>VM 停止時間を最小にするために一時的にディスク コピーをする（任意のためスキップ可）  </li><li>Azure Storage Explorer でディスクを移行先に複製する  </li><li>複製したディスクから新規に VM を作成する  </li></ul><p>手順の概要図としては以下のようになります。<br>   <br><img src="/blog/vm/copy-vm-with-storage-explorer/image15.png"> </p><p>勿論この方法で、  </p><ul><li>マネージド ディスクだけを複製する  </li><li>データ ディスクも含めて複製する  </li><li>同一のサブスクリプション内に VM を複製する  </li></ul><p>といったことも可能です。  </p><p>なお、転送や作成したディスク等には所定の料金が発生したしますのでこの点はご了承くださいませ。<br>また、Windows VM を複製しそれをご利用いただく場合、基本的には「一般化したイメージから VM を複製」いただく必要がございます。<br>この詳細は <a href="https://jpaztech.github.io/blog/vm/vm-replica-1/#Windows-VM%E3%82%92%E8%A4%87%E8%A3%BD%E3%81%97%E3%82%88%E3%81%86%E3%81%A8%E3%81%97%E3%81%A6%E3%81%84%E3%82%8B%E6%96%B9%E3%81%B8%E3%81%AE%E6%B3%A8%E6%84%8F%E5%96%9A%E8%B5%B7">Windows-VM を複製しようとしている方への注意喚起</a> をご参照ください。  </p><p>それでは早速詳細な手順を見ていきましょう。  </p><hr><h1 id="Azure-Storage-Explorer-をインストールする"><a href="#Azure-Storage-Explorer-をインストールする" class="headerlink" title="Azure Storage Explorer をインストールする"></a>Azure Storage Explorer をインストールする</h1><p>Azure Storage Explorer は GUI でマネージド ディスクやストレージ アカウントのデータ管理を行える、<br>とても便利なソフトウェアとなります！  </p><p>まずは Azure Storage Explorer をインストールしましょう。<br>以下の URL より Azure Storage Explorer を入手することができます。<br> <br>■ご参考：Azure Storage Explorer<br><a href="https://azure.microsoft.com/ja-jp/features/storage-explorer/">https://azure.microsoft.com/ja-jp/features/storage-explorer/</a>     </p><hr><h1 id="Azure-Storage-Explorer-で対象のサブスクリプションに接続する"><a href="#Azure-Storage-Explorer-で対象のサブスクリプションに接続する" class="headerlink" title="Azure Storage Explorer で対象のサブスクリプションに接続する"></a>Azure Storage Explorer で対象のサブスクリプションに接続する</h1><p>インストールが完了したら、Azure Storage Explorer を開き、各種操作が可能な Azure ユーザーでログインをします。<br>コンセントのアイコンの「接続ダイアログを開く」を選択し、「サブスクリプション」を選択の上ログインを実施してください。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image2.png"><br> <br>なお、別のテナントに VM コピーを試みる場合は上記のログイン作業を、２回実施します。<br>「移行元サブスクリプション」「移行先サブスクリプション」と 2 つともログインしておきましょう。     </p><hr><h1 id="対象の-VM-を割り当て解除（停止）する"><a href="#対象の-VM-を割り当て解除（停止）する" class="headerlink" title="対象の VM を割り当て解除（停止）する"></a>対象の VM を割り当て解除（停止）する</h1><p>VM が割り当て解除（停止）状態でない場合は、ディスクの転送が叶いません。<br>転送を行うために、対象となる VM を Azure ポータル等で割り当て解除（停止）しましょう。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image3.png">   </p><p>また、転送するディスク名も確認しておきましょう。<br>VM の [ディスク] ブレードより、複製を行いたいディスク名が確認できます。  </p><p><img src="/blog/vm/copy-vm-with-storage-explorer/image4.png"> </p><hr><h1 id="VM-停止時間を最小にするために一時的にディスクコピーをする（任意のためスキップ可）"><a href="#VM-停止時間を最小にするために一時的にディスクコピーをする（任意のためスキップ可）" class="headerlink" title="VM 停止時間を最小にするために一時的にディスクコピーをする（任意のためスキップ可）"></a>VM 停止時間を最小にするために一時的にディスクコピーをする（任意のためスキップ可）</h1><p>こちらの手順は任意のためにスキップ可能です。<br>VM 停止時間を最小に抑えたい場合のみ実行をご検討ください。  </p><p>VM が割り当て解除状態であれば、そのまま VM にアタッチされているディスクの転送は開始は可能です。<br>しかしながら、転送が完了するまでは VM が起動できないという制約もあります。<br> <br>同一リージョン等では転送にそれほど時間がかからないものと存じますが、一概な転送時間はご案内が叶いません。<br>大容量のディスクをリージョン間コピーする際など、<br>転送に時間がかかる場合は元の VM 起動ができない期間が発生する可能性もございます。  </p><p>そのため、VM 停止時間を最小に抑えたい場合は、</p><ul><li>VM 停止後にディスクのスナップショットを取得する</li><li>スナップショット取得が完了したら元の VM 起動する</li><li>スナップショットから転送用ディスクを一時的に作成</li><li>転送用ディスクを転送する</li></ul><p> <br>といった手順を実施することで、VM 停止時間を最小に抑えることが可能です。<br>この場合は以下の図のような流れとなります。  </p><p><img src="/blog/vm/copy-vm-with-storage-explorer/image1.png"> </p><p>それでは、この実際の手順を説明させていただきます。<br>VM 停止が完了したら、VM の [ディスク] ブレードより、複製を行いたいディスクを選択します。<br> <br>なおスナップショット自体は、VM が起動状態でも取得可能ですが、<br>移行後の VM の不具合を防止するため VM 停止状態でスナップショットを取得することを強く推奨いたします。  </p><p><img src="/blog/vm/copy-vm-with-storage-explorer/image4.png"> </p><p>上部にある [スナップショットの作成] を選択します。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image5.png"><br> <br>スナップショット作成のオプションを選択します。<br>下記は一例とはなりますが、今回はスナップショットの種類は [フル] とし、記憶域の種類は [Standard HDD] としています。<br>設定が完了したら、[レビュー] を選択し、スナップショットを作成します。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image6.png"><br> <br>これでスナップショット取得が完了となります。<br>なお、スナップショット取得の所要時間は一概には言えませんが、手元の Windws OS ディスク 128 GB では十数秒で完了しました。<br>スナップショット取得が完了したら、VM を起動頂いて大丈夫です。<br> <br>先ほど取得したスナップショットから一時的に転送用ディスクを作成します。<br>まずは、ポータル上部の検索ボックスで [スナップショット] を検索し、選択します。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image7.png"><br> <br>先ほど取得したスナップショットを一覧より選択します。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image8.png"><br> <br>上部に表示される [ディスクの作成] を選択します。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image9.png"><br> <br>「転送用ディスク」としてマネージド ディスクを作成します。<br>基本的には、デフォルトの設定で問題無いかと思いますが、下記例ではサイズにて [Standard HDD] のディスクを作成するように設定しています。<br>設定が完了したら [確認および作成] を選択し、マネージド ディスクを作成します。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image10.png"><br> <br>不要な課金を無くすためにも、この手順で一時的に作成した「スナップショット」および「転送用のマネージド ディスク」は後ほど削除しましょう。<br>では「転送用ディスク」が作成できましたので、続きの手順に沿って Azure Storage Explorer でディスクを移行先に複製しましょう。<br>（任意のためスキップ可）の手順はここまでです。  </p><hr><h1 id="Azure-Storage-Explorer-でディスクを移行先に複製する"><a href="#Azure-Storage-Explorer-でディスクを移行先に複製する" class="headerlink" title="Azure Storage Explorer でディスクを移行先に複製する"></a>Azure Storage Explorer でディスクを移行先に複製する</h1><p>それでは、OS ディスク（または任意のディスク）を転送先にコピーしましょう。<br> <br>Azure Storage Explorer にて、<br>左側のエクスプローラーより転送対象となるディスクが存在するリソース グループを選択します。<br>そして、対象のディスクを選択し「コピー」を選択します。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image11.png"><br> <br>次に、エクスプローラーで複製先となるリソース グループを選択の上、「貼り付け」を選択します。<br>この際、別テナントや別サブスクリプション上のリソース グループも選択が可能です。<br>以下のように複製先のリージョンを選ぶことが可能となっております。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image12.png"><br> <br>同一リソース グループ内に同一名のマネージド ディスクは作成が叶いませんので、その際は上記画面でディスク名を変更くださいませ。<br>なお、転送状況は以下の通り Azure Storage Explorer 下部のアクティビティ タブにてご確認が可能です。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image13.png"><br> <br>なお、データ ディスクも合わせて複製する必要がある場合は同様の手順で、OS ディスクと合わせて複製を行ってください。     </p><hr><h1 id="複製した-OS-ディスクから新規に-VM-を作成する"><a href="#複製した-OS-ディスクから新規に-VM-を作成する" class="headerlink" title="複製した OS ディスクから新規に VM を作成する"></a>複製した OS ディスクから新規に VM を作成する</h1><p>Azure ポータルで、移行先の複製した OS ディスクのリソースを表示します。<br>複製した OS ディスクから以下の通り VM 作成が可能です。<br> <br><img src="/blog/vm/copy-vm-with-storage-explorer/image14.png"><br> <br>データ ディスクがある場合は、この VM 作成時にデータ ディスクをアタッチしましょう。<br>また VM 複製でなく VM 移動の場合は、複製完了後に移行元の VM および不要なリソースを削除いただくようにお願いいたします。  </p><hr><p>以上が Azure Storage Explorer を用いて、コマンド無しで VM を別のリージョン・サブスクリプション・テナントに移動/複製する方法でした。<br>こちらの内容が皆様のお役に立てれば幸いでございます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt; &lt;br&gt;Azure 上の VM およびマネージド ディスクについて、  &lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;別のリージョンに移動/複製をしたい&lt;/strong&gt;  &lt;/li&gt;
&lt;li&gt;&lt;str</summary>
      
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Azure 上でデプロイした Windows の VM に DVD ドライブが表示される</title>
    <link href="https://jpaztech.github.io/blog/vm/what-is-this-dvd-drive/"/>
    <id>https://jpaztech.github.io/blog/vm/what-is-this-dvd-drive/</id>
    <published>2022-08-19T06:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.447Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの富田です。<br><strong>Azure 上でデプロイした Windows の VM に D ドライブ や E ドライブとして CD / DVD ドライブが表示される</strong><br>というお問い合わせをいただくことがあるため、これについて解説させていただきます。  </p><p><img src="/blog/vm/what-is-this-dvd-drive/what-is-this-dvd-drive.png"> </p><p>結論から申し上げますと、 <strong>これは仮想マシン作成後の予期された動作であり、VM を割り当て解除することで消えます。</strong><br>以下に解説させていただきます。  </p><p>Azure の Marketplace から Windows の仮想マシンを作成した場合、初回起動の際に DVD ドライブ がマウントされる動作となります。<br>一時ディスクの無い VM サイズの場合は D ドライブに、<br>一時ディスクのある VM サイズの場合は E ドライブとして規定でマウントされると存じます。  </p><p>このドライブは、Windows 環境をデプロイする際にセットアップに必要な情報を読み込むためにマウントされますが、<br>お客様が仮想マシンを停止 (割り当て解除) された場合や、Azure 側のメンテナンスなどに伴ってホスト サーバーの変更が発生した際に切断されます。  </p><p>仮想マシンの停止 (割り当て解除) / 起動または再デプロイ、仮想マシンのサイズ変更などにより、仮想マシンへのリソースの割り当てを<br>一度解除いただくことで、次回起動時からはこの DVD ドライブ はマウントされません。  </p><p>なお、再起動や OS からのシャットダウンの場合は、仮想マシンへのリソースの割り当て解除が行われません。<br>そのため、Azure Portal 等より仮想マシンの停止 (割り当て解除) や再デプロイ等を行うようにお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの富田です。&lt;br&gt;&lt;strong&gt;Azure 上でデプロイした Windows の VM に D ドライブ や E ドライブとして CD / DVD ドライブが表示される&lt;/strong&gt;&lt;br&gt;というお問い合わせをいた</summary>
      
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>「仮想マシン エージェントの状態が準備できていません」について</title>
    <link href="https://jpaztech.github.io/blog/vm/vmagent-notready/"/>
    <id>https://jpaztech.github.io/blog/vm/vmagent-notready/</id>
    <published>2022-08-18T06:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.443Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの大野です。</p><p>今回は、度々お問合せいただきます、こちらのメッセージについて、<br>想定される原因およびその判断ポイント、対処についてご紹介いたします。</p><span id="more"></span><p>結論からお伝えすると、このメッセージが表示されることが、<br>必ずしも対象仮想マシンへのネットワーク疎通が取れないことを意味するわけではありません。</p><p><img src="/blog/vm/vmagent-notready/vmagent-notready01.png"> </p><p>想定されるシナリオについては、以下 4 つに分類されるかと思います。</p><h2 id="「仮想マシンエージェントの状態が準備できていません」の想定シナリオ"><a href="#「仮想マシンエージェントの状態が準備できていません」の想定シナリオ" class="headerlink" title="「仮想マシンエージェントの状態が準備できていません」の想定シナリオ"></a>「仮想マシンエージェントの状態が準備できていません」の想定シナリオ</h2><table><thead><tr><th>シナリオ番号</th><th>想定されるシナリオ</th><th>SSH / RDP 接続可否</th></tr></thead><tbody><tr><td>1</td><td>仮想マシン エージェントが停止している</td><td>可</td></tr><tr><td>2</td><td>Wire Server (168.63.129.16) への疎通がゲストOS でブロックされている</td><td>可</td></tr><tr><td>3</td><td>ネットワーク インターフェースが無効化されている</td><td>不可</td></tr><tr><td>4</td><td>ゲスト OS がハング等により稼働していない</td><td>不可</td></tr></tbody></table><h2 id="シナリオ1-仮想マシン-エージェントが停止している"><a href="#シナリオ1-仮想マシン-エージェントが停止している" class="headerlink" title="シナリオ1 : 仮想マシン エージェントが停止している"></a>シナリオ1 : 仮想マシン エージェントが停止している</h2><p>意図的に仮想マシン エージェントのプロセスを停止されている他、<br>仮想マシン エージェントに内在する不具合によって起動していないケースもございます。</p><p>この場合、対象仮想マシンへの SSH 接続は引き続き可能ですが、<br>影響としては、仮想マシン エージェントが拡張機能の管理も兼ねているため、<br>拡張機能のインストールや動作に問題が生じることが想定されます。</p><p>それでは、Linux (Red Hat Enterprise Linux 8.6) で試してみます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel86 ~]<span class="comment"># systemctl status waagent.service </span></span><br><span class="line">● waagent.service - Azure Linux Agent</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/waagent.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /usr/lib/systemd/system/waagent.service.d</span><br><span class="line">           └─10-Slice.conf, 11-CPUAccounting.conf, 12-CPUQuota.conf</span><br><span class="line">   Active: active (running) since Sun 2022-08-14 15:09:14 UTC; 3min 6s ago</span><br><span class="line"> Main PID: 1484 (python3.6)</span><br><span class="line">    Tasks: 6 (<span class="built_in">limit</span>: 49437)</span><br><span class="line">   Memory: 40.8M</span><br><span class="line">      CPU: 6.239s</span><br><span class="line">   CGroup: /azure.slice/waagent.service</span><br><span class="line">           ├─1484 /usr/bin/python3.6 -u /usr/sbin/waagent -daemon</span><br><span class="line">           └─1719 /usr/bin/python3.6 -u bin/WALinuxAgent-2.7.3.0-py2.7.egg -run-exthandlers</span><br><span class="line"></span><br><span class="line">...(省略)...</span><br><span class="line"></span><br><span class="line">[root@rhel86 ~]<span class="comment"># systemctl stop waagent.service </span></span><br><span class="line">[root@rhel86 ~]<span class="comment"># systemctl status waagent.service</span></span><br><span class="line">● waagent.service - Azure Linux Agent</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/waagent.service; enabled; vendor preset: disabled)</span><br><span class="line">  Drop-In: /usr/lib/systemd/system/waagent.service.d</span><br><span class="line">           └─10-Slice.conf, 11-CPUAccounting.conf, 12-CPUQuota.conf</span><br><span class="line">   Active: inactive (dead) since Sun 2022-08-14 15:12:35 UTC; 6s ago</span><br><span class="line">  Process: 1484 ExecStart=/usr/bin/python3.6 -u /usr/sbin/waagent -daemon (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 1484 (code=exited, status=0/SUCCESS)</span><br><span class="line">      CPU: 6.318s</span><br><span class="line"></span><br><span class="line">...(省略)...</span><br></pre></td></tr></table></figure><p>しばらくしてから、対象仮想マシンの概要欄を確認すると、エラーになっていることがご確認いただけるかと思います。<br>一方、この状態では特段問題なく、SSH 接続いただけるかと思います。</p><p><img src="/blog/vm/vmagent-notready/vmagent-notready02.png"> </p><h3 id="判断いただくポイント"><a href="#判断いただくポイント" class="headerlink" title="判断いただくポイント"></a>判断いただくポイント</h3><p>このシナリオでは、SSH / RDP 接続が可能なため、<br>まずは対象仮想マシンにアクセスいただき、仮想マシン エージェントのサービスが起動しているか確認いただければと思います。</p><h3 id="想定される対処について"><a href="#想定される対処について" class="headerlink" title="想定される対処について"></a>想定される対処について</h3><p>仮想マシン エージェントが停止している場合には、手動で起動を実施いたします。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/linux-azure-guest-agent#troubleshoot-a-not-ready-status">準備ができていない状態のトラブルシューティング - Azure Linux エージェントのトラブルシューティング</a></li></ul><p>もし、手動で起動してもエラーとなるようでしたら、仮想マシン エージェントを更新し、<br>再度お試しいただき、起動いただけるか、ご確認ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/update-linux-agent">VM で Azure Linux エージェントを更新する方法</a></li></ul><h2 id="シナリオ2-Wire-Server-168-63-129-16-への疎通がゲストOS-でブロックされている"><a href="#シナリオ2-Wire-Server-168-63-129-16-への疎通がゲストOS-でブロックされている" class="headerlink" title="シナリオ2 : Wire Server (168.63.129.16) への疎通がゲストOS でブロックされている"></a>シナリオ2 : Wire Server (168.63.129.16) への疎通がゲストOS でブロックされている</h2><p>Wire Server (168.63.129.16) は、仮想マシン内からのみアクセス可能な仮想パブリック IP アドレスになります。<br>仮想マシン エージェントからこの IP アドレスに対して正常性の通知を行っています。</p><p>この IP アドレスへの通信は、ネットワーク セキュリティ グループ (NSG) で制限することはできませんが、<br>ゲスト OS のファイアウォール機能にて制限は可能です。</p><p>試してみます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel86 ~]<span class="comment"># curl http://168.63.129.16/?comp=versions</span></span><br><span class="line">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span><br><span class="line">&lt;Versions&gt;</span><br><span class="line">  &lt;Preferred&gt;</span><br><span class="line">    &lt;Version&gt;2015-04-05&lt;/Version&gt;</span><br><span class="line">  &lt;/Preferred&gt;</span><br><span class="line">  &lt;Supported&gt;</span><br><span class="line">    &lt;Version&gt;2015-04-05&lt;/Version&gt;</span><br><span class="line">    &lt;Version&gt;2012-11-30&lt;/Version&gt;</span><br><span class="line">    &lt;Version&gt;2012-09-15&lt;/Version&gt;</span><br><span class="line">    &lt;Version&gt;2012-05-15&lt;/Version&gt;</span><br><span class="line">    &lt;Version&gt;2011-12-31&lt;/Version&gt;</span><br><span class="line">    &lt;Version&gt;2011-10-15&lt;/Version&gt;</span><br><span class="line">    &lt;Version&gt;2011-08-31&lt;/Version&gt;</span><br><span class="line">    &lt;Version&gt;2011-04-07&lt;/Version&gt;</span><br><span class="line">    &lt;Version&gt;2010-12-15&lt;/Version&gt;</span><br><span class="line">    &lt;Version&gt;2010-28-10&lt;/Version&gt;</span><br><span class="line">  &lt;/Supported&gt;</span><br><span class="line">&lt;/Versions&gt;</span><br></pre></td></tr></table></figure><p>168.63.129.16 に対して、アウトバウンド方向の通信を遮断します。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel86 ~]<span class="comment"># firewall-cmd --direct --add-rule ipv4 filter OUTPUT 0 -d  168.63.129.16/32 -j DROP</span></span><br><span class="line">success</span><br><span class="line">[root@rhel86 ~]<span class="comment"># firewall-cmd --direct --get-all-rules</span></span><br><span class="line">ipv4 filter OUTPUT 0 -d 168.63.129.16/32 -j DROP</span><br></pre></td></tr></table></figure><p>遮断されていることを確認します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel86 ~]# curl http://168.63.129.16/?comp=versions</span><br><span class="line">curl: (7) Failed to connect to 168.63.129.16 port 80: Connection timed out</span><br></pre></td></tr></table></figure><p>しばらく経つと、こちらの場合も、Azure ポータルから仮想マシン エージェントに問題がある旨ご確認いただけるかと思います。</p><h3 id="判断いただくポイント-1"><a href="#判断いただくポイント-1" class="headerlink" title="判断いただくポイント"></a>判断いただくポイント</h3><p>シナリオ1 と同様に、SSH 接続は引き続き可能なため、<br>対象仮想マシンに SSH 接続いただき、シナリオ1 の点を確認いただければと思います。</p><p>こちらが問題なければ、168.63.129.16 に対してネットワーク疎通が取れているか確認いただくことで、<br>ご判断いただけるかと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/what-is-ip-address-168-63-129-16#troubleshoot-connectivity">接続のトラブルシューティング - IP アドレス 168.63.129.16 とは</a></li></ul><p>その他ご判断いただく点といたしましては、仮想マシン エージェントのログ (<code>/var/log/waagent.log</code>) にて、<br>以下のようなログの出力からも Wire Server への疎通に問題があるということをご判断いただけるかと思います。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2022-08-11T07:27:33.509406Z ERROR SendTelemetryHandler ExtHandler Event: name=WALinuxAgent, op=ReportEventErrors, message=DroppedEventsCount: 1</span><br><span class="line">Reasons (first 5 errors): [ProtocolError] [Wireserver Exception] [HttpError] [HTTP Failed] POST http://168.63.129.16/machine -- IOError timed out -- 6 attempts made: Traceback (most recent call last):</span><br></pre></td></tr></table></figure><h3 id="想定される対処について-1"><a href="#想定される対処について-1" class="headerlink" title="想定される対処について"></a>想定される対処について</h3><p>上記の例では、ゲスト OS 内のファイアウォールの対象ルールを無効化いただくことで、<br>対処いただけますが、一概にこの点だけ確認すればよいというご案内ができないため、<br>適宜どのような制限が設定されているかご確認ください。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel86 ~]<span class="comment"># firewall-cmd --direct --remove-rule ipv4 filter OUTPUT 0 -d  168.63.129.16/32 -j DROP</span></span><br><span class="line">success</span><br><span class="line">[root@rhel86 ~]<span class="comment"># firewall-cmd --direct --get-all-rules</span></span><br><span class="line">[root@rhel86 ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>また、特段制限をされていない場合、Wire Server 側に問題があることが想定されますので、<br>該当仮想マシンのご利用に影響がない時間を調整いただき、仮想マシンの再デプロイをご実施いただければと思います。</p><h2 id="シナリオ3-ネットワークインターフェースが無効化されている"><a href="#シナリオ3-ネットワークインターフェースが無効化されている" class="headerlink" title="シナリオ3 : ネットワークインターフェースが無効化されている"></a>シナリオ3 : ネットワークインターフェースが無効化されている</h2><p>こちらが仮想マシン エージェントが稼働していない = ネットワーク接続できないと思われてしまうシナリオになります。<br>これは反対で、アウトバウンド方向のネットワーク疎通が取れないために、結果として仮想マシン エージェントから Wire Server にアクセスができず、<br>仮想マシン エージェントの状態が Not Ready となります。</p><p>試しにネットワーク インターフェース eth0 を無効化してみます。<br>しばらく待つと、SSH 接続が途切れます。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@rhel86 ~]<span class="comment"># ifconfig eth0 down</span></span><br><span class="line">client_loop: send disconnect: Broken pipe</span><br></pre></td></tr></table></figure><p>その後再度 SSH 接続を試みますが、失敗します。</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">❯ ssh azureuser@xx.xxx.xxx.xxx</span><br><span class="line">ssh: connect to host xx.xxx.xxx.xxx port 22: Connection timed out</span><br></pre></td></tr></table></figure><p>また、仮想マシン エージェントが準備できていない旨のエラー メッセージが Azure ポータル上でご確認いただけるかと思います。</p><h3 id="判断いただくポイント-2"><a href="#判断いただくポイント-2" class="headerlink" title="判断いただくポイント"></a>判断いただくポイント</h3><p>こちらは対象仮想マシンのブート診断から参照可能なシリアル ログにて、下記のようにログイン プロンプトが表示されているかご確認いただければと思います。<br>(Windows の場合には、ブート診断機能で、スクリーンショットにロック画面が表示いただけるかの確認になります)。</p><p><img src="/blog/vm/vmagent-notready/vmagent-notready03.png"> </p><p>上記より、ゲスト OS としては稼働しているものの、ネットワークとして疎通が取れていないということが想定されます (シナリオ4 との切り分け)。</p><h3 id="想定される対処について-2"><a href="#想定される対処について-2" class="headerlink" title="想定される対処について"></a>想定される対処について</h3><p>ゲスト OS にてネットワークの疎通の問題においても、種々原因が上げられますため、<br>必ずこれを行えば解決するというものではございませんが、以下のネットワーク インターフェースのリセットや、<br>IP アドレスの固定化が設定されていないかご確認いただければと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/reset-network-interface-azure-linux-vm">Azure Linux VM のネットワーク インターフェイスをリセットする</a></li></ul><p> 上記と併せ、下記ドキュメントの “VM に接続できない” より、Linux / Windows それぞれ特化したトラブルシューティング手順をご確認ください。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/welcome-virtual-machines">Azure Virtual Machinesトラブルシューティングのドキュメント</a></li></ul><h2 id="シナリオ4-ゲスト-OS-がハング等により稼働していない"><a href="#シナリオ4-ゲスト-OS-がハング等により稼働していない" class="headerlink" title="シナリオ4 : ゲスト OS がハング等により稼働していない"></a>シナリオ4 : ゲスト OS がハング等により稼働していない</h2><p>ゲスト OS が動作しておらず、結果その上で仮想マシン エージェントが動作していないというシナリオになります。</p><h3 id="判断いただくポイント-3"><a href="#判断いただくポイント-3" class="headerlink" title="判断いただくポイント"></a>判断いただくポイント</h3><p>シナリオ3 と同様、シリアル ログをご確認いただき、ログイン プロンプトが返ってきているかご確認いただき、<br>もしそうなっていないのであれば、ゲスト OS で正常にブートしていない可能性があります<br>(Windows の場合には、ブート診断機能で、スクリーンショットにロック画面が表示いただけるかの確認になります)。</p><p>下記の例では、存在しないマウントポイントをブート時にマウントしようとしてしまい、<br>Emergency モードで起動している状況になります。</p><p><img src="/blog/vm/vmagent-notready/vmagent-notready04.png"> </p><h3 id="想定される対処について-3"><a href="#想定される対処について-3" class="headerlink" title="想定される対処について"></a>想定される対処について</h3><p>再起動/再デプロイにより、復旧いただけるかまずはご確認いただくことと、<br>取得済みのバックアップ データから復旧いただくこととなります。</p><p>もし上記施策が当てはまらない場合は、下記仮想マシンのトラブルシューティング ガイドにあります、”VM のデプロイ、アップグレード、移行” の “VM がブートしていない” に、<br>Linux / Windows それぞれ特化したトラブルシューティング手順があるので、ご参考いただければと思います。<br>また、シリアルコンソール機能のご利用が必要となりましたら、同じく下記ドキュメントの “リモート トラブルシューティング ツール” の “シリアル コンソール” を併せてご確認いただければと思います。</p><ul><li><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/welcome-virtual-machines">Azure Virtual Machinesトラブルシューティングのドキュメント</a></li></ul><p>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの大野です。&lt;/p&gt;
&lt;p&gt;今回は、度々お問合せいただきます、こちらのメッセージについて、&lt;br&gt;想定される原因およびその判断ポイント、対処についてご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="VM Agent" scheme="https://jpaztech.github.io/blog/tags/VM-Agent/"/>
    
  </entry>
  
  <entry>
    <title>Azure Firewall の各ルールの動作について</title>
    <link href="https://jpaztech.github.io/blog/network/firewall-rules/"/>
    <id>https://jpaztech.github.io/blog/network/firewall-rules/</id>
    <published>2022-08-16T03:30:00.000Z</published>
    <updated>2022-12-22T05:56:35.107Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チーム檜山です。</p><p>今回は Azure Firewall の各ルールの動作についてよくあるお問い合わせを紹介させていただきます。</p><hr><p><span id="apprule-block"></span></p><h2 id="Azure-Firewall-のアプリケーションルールで許可されているように見える動作について"><a href="#Azure-Firewall-のアプリケーションルールで許可されているように見える動作について" class="headerlink" title="Azure Firewall のアプリケーションルールで許可されているように見える動作について"></a><a href="#apprule-block">Azure Firewall のアプリケーションルールで許可されているように見える動作について</a></h2><p>HTTP (80), HTTPS (443) の通信において、ネットワークルール、アプリケーションルールで明示的に拒否していない場合、ルールの処理順序に従って、Azure Firewall の既定の動作として、アプリケーションルールで拒否されることが想定される動作となります。</p><p>この動作について Windows の Test-Netconnection や Linux の curl, nc コマンド等 (以下に記載) で TCP の 3way handshake による接続確認を実施した場合はアプリケーションルールで許可していないにもかかわらず、3way handshake が確立され、許可されたように見える動作となります。この動作の詳細を以下に記載します。</p><ul><li>Powershell Test-NetConnection コマンド (Windows)</li></ul><blockquote><p>Test-NetConnection -port 443 <a href="http://www.micorosoft.com/">www.micorosoft.com</a></p><p>ComputerName     : <a href="http://www.micorosoft.com/">www.micorosoft.com</a><br>RemoteAddress    : 40.76.4.15<br>RemotePort       : 443<br>InterfaceAlias   : Ethernet 2<br>SourceAddress    : 10.0.1.5<br><span style="color: red">TcpTestSucceeded : True</span></p></blockquote><ul><li>nc コマンド (linux)</li></ul><blockquote><p>$ nc -vz <a href="http://www.microsoft.com/">www.microsoft.com</a> 443<br>Ncat: Version 7.50 ( <a href="https://nmap.org/ncat">https://nmap.org/ncat</a> )<br><span style="color: red">Ncat: Connected to 23.33.181.181:443.</span><br>Ncat: 0 bytes sent, 0 bytes received in 0.02 seconds.</p></blockquote><h3 id="Azure-Firewall-のアプリケーションルールの動作の詳細について"><a href="#Azure-Firewall-のアプリケーションルールの動作の詳細について" class="headerlink" title="Azure Firewall のアプリケーションルールの動作の詳細について"></a>Azure Firewall のアプリケーションルールの動作の詳細について</h3><p>上述の通り、TCP 80, 443 宛の通信について、ネットワークルールで明示的な拒否、許可がない場合、アプリケーションルールで評価され、許可ルールがない場合は既定の動作としてアプリケーションルールにて拒否されます。<br>アプリケーションルールでは HTTP のホストヘッダ、HTTPS の SNI の Server Name をもとにアプリケーションルール内の FQDN とマッチするかを確認して評価が行われます。</p><p>アプリケーションルールは L7 で動作しますので、内部的には クライアントと Azure Firewall 間で 3way handshake を確立し、HTTP , HTTPS の情報に基づいて通信を制御しますので、3way handshake が確立されることは想定される動作となります。</p><p>NSG にて接続が拒否されている Web サーバーにアクセスした際も、宛先アドレスと 3way handshake は確立可能で、HTTP, HTTPS のレイヤーで拒否されていることから、Azure Firewall が送信元を変換してパケットを返送するような動作であることが確認できます。</p><p><strong>そのため、アプリケーションルールで実際に通信が拒否されるかどうかを確認する際は、ブラウザや curl コマンド等で Web サイトへアクセスし、エラーによりクライアントへ期待される応答 (Status 200 等) が返らないことをご確認ください。</strong></p><p>アプリケーションルールにて拒否されている場合はブラウザや curl コマンドだと以下のような動作となります。</p><ul><li>Chrome [HTTP]</li></ul><table><thead><tr><th align="center"><img src="/blog/network/firewall-rules/http-deny-browser.png" alt="HTTP拒否"></th></tr></thead></table><ul><li>Chrome [HTTPS]</li></ul><table><thead><tr><th align="center"><img src="/blog/network/firewall-rules/https-deny-browser.png" alt="HTTPS拒否"></th></tr></thead></table><ul><li>curl コマンド (HTTP)</li></ul><blockquote><p>$ curl -v <a href="http://www.microsoft.com/">http://www.microsoft.com</a></p><p>About to connect() to <a href="http://www.microsoft.com/">www.microsoft.com</a> port 80 (#0)<br>   Trying 23.33.181.181…<br>Connected to <a href="http://www.microsoft.com/">www.microsoft.com</a> (23.33.181.181) port 80 (#0)<br>GET / HTTP/1.1<br>User-Agent: curl/7.29.0<br>Host: <a href="http://www.microsoft.com/">www.microsoft.com</a><br>Accept: <em>/</em></p><p>HTTP/1.1 470 status code 470<br>Date: Mon, 29 Mar 2021 04:29:57 GMT<br>Content-Length: 144<br>Content-Type: text/plain; charset=utf-8<br>Connection #0 to host <a href="http://www.microsoft.com/">www.microsoft.com</a> left intact<br><span style="color: red">HTTP  request from 10.0.1.4:53460 to <a href="http://www.microsoft.com/">www.microsoft.com:80</a>. Url: <a href="http://www.microsoft.com/">www.microsoft.com</a>. Action: Deny. No rule matched. Proceeding with default action</span></p></blockquote><ul><li>curl コマンド (HTTPS)</li></ul><blockquote><p>$ curl -v <a href="https://www.microsoft.com/">https://www.microsoft.com</a></p><p>About to connect() to <a href="http://www.microsoft.com/">www.microsoft.com</a> port 443 (#0)<br>  Trying 23.33.181.181…<br>Connected to <a href="http://www.microsoft.com/">www.microsoft.com</a> (23.33.181.181) port 443 (#0)<br>Initializing NSS with certpath: sql:/etc/pki/nssdb<br>  CAfile: /etc/pki/tls/certs/ca-bundle.crt<br>CApath: none<br><span style="color: red">NSS error -5938 (PR_END_OF_FILE_ERROR)</span><br><span style="color: red">Encountered end of file</span><br><span style="color: red">Closing connection 0</span><br><span style="color: red">curl: (35) Encountered end of file</span></p></blockquote><p><span id="difference-net-app"></span></p><h2 id="ネットワークルールと、アプリケーションルールの動作の違いについて"><a href="#ネットワークルールと、アプリケーションルールの動作の違いについて" class="headerlink" title="ネットワークルールと、アプリケーションルールの動作の違いについて"></a><a href="#difference-net-app">ネットワークルールと、アプリケーションルールの動作の違いについて</a></h2><h3 id="ネットワークルールの動作について"><a href="#ネットワークルールの動作について" class="headerlink" title="ネットワークルールの動作について"></a>ネットワークルールの動作について</h3><p>ネットワークルールは L4 で動作します。TCP の通信で宛先アドレス、宛先ポートが拒否されている場合、Azure Firewall は SYN/ACK を返しませんので、3way handshake に失敗し、通信が拒否される動作となります。</p><h3 id="アプリケーションルールとネットワークルールの動作の違いについて"><a href="#アプリケーションルールとネットワークルールの動作の違いについて" class="headerlink" title="アプリケーションルールとネットワークルールの動作の違いについて"></a>アプリケーションルールとネットワークルールの動作の違いについて</h3><p>上述の通り、ネットワークルールは L4 で動作し、アプリケーションルールは L7 で動作します。<br>どちらのルールを使用すべきかについては以下がベストプラクティスとなりますので、ご確認いただけますと幸いです。</p><ol><li>HTTP, HTTPS の通信において FQDN ベースで通信を制御できるものはアプリケーションルールを利用する</li><li>HTTP, HTTPS の通信において FQDN ベースで通信を制御できないものはネットワークルールを利用する</li><li>HTTP, HTTPS, MSSQL 以外の通信はネットワークルールを利用する</li></ol><h3 id="アプリケーションルールとネットワークルールの-FQDN-のフィルタリングについて"><a href="#アプリケーションルールとネットワークルールの-FQDN-のフィルタリングについて" class="headerlink" title="アプリケーションルールとネットワークルールの FQDN のフィルタリングについて"></a>アプリケーションルールとネットワークルールの FQDN のフィルタリングについて</h3><p>現在はアプリケーションルール、ネットワークルールどちらでも FQDN のフィルタリングが可能です。<br>ベストプラクティスは上述の通りとなりますが、HTTP, HTTPS の通信でアプリケーションルールの利用を推奨する理由としては以下もございます。</p><ul><li>IP アドレスが同一になるような FQDN でも制御可能 (CDN や AppService 等の同一 IP アドレスを複数のユーザーが利用する基盤が宛先となっている場合でも制御が可能)</li><li>ワイルドカードによる FQDN の指定が可能</li><li>DNS Proxy の利用が不要 (クライアント側の DNS の設定変更も不要)</li><li>Web トラフィックに対する今後の機能追加が優先的に行われる可能性がある </li></ul><p>ネットワークルールでの FQDN のフィルタリングは以下もご一読ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/fqdn-filtering-network-rules">ネットワーク ルールでの FQDN フィルタリング</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/dns-settings">Azure Firewall の DNS 設定</a></p><h2 id="Azure-Firewall-のルールの処理順序-フローチャート"><a href="#Azure-Firewall-のルールの処理順序-フローチャート" class="headerlink" title="Azure Firewall のルールの処理順序 (フローチャート)"></a>Azure Firewall のルールの処理順序 (フローチャート)</h2><p>Azure Firewall のルールの処理順序がわかりにくいというお問い合わせをいただくことがございます。以下のフローチャートにて詳細を記載しておりますのでご確認ください。</p><p><img src="/blog/network/firewall-rules/FWdefault-flow.png" alt="フローチャート"></p><p><span id="faq"></span></p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a><a href="#faq">FAQ</a></h2><h4 id="設定変更時に既存接続への影響はありますか。"><a href="#設定変更時に既存接続への影響はありますか。" class="headerlink" title="- 設定変更時に既存接続への影響はありますか。"></a>- 設定変更時に既存接続への影響はありますか。</h4><p>DNAT ルール, ネットワークルール, アプリケーションルールの設定変更において、既存の接続に影響が出るような設定変更でなければ既存の接続に影響がでない動作となることを確認しております。</p><h4 id="戻りのパケットは診断ログに記録されますか。"><a href="#戻りのパケットは診断ログに記録されますか。" class="headerlink" title="- 戻りのパケットは診断ログに記録されますか。"></a>- 戻りのパケットは診断ログに記録されますか。</h4><p>ネットワークルールでは TCP の SYN パケットに対して許可/拒否が記録されますが、戻りのパケット (SYN/ACK) は診断ログには記録されない動作となります。</p><h4 id="「Action-Deny-Reason-SNI-TLS-extension-was-missing」で拒否される理由を教えてください。"><a href="#「Action-Deny-Reason-SNI-TLS-extension-was-missing」で拒否される理由を教えてください。" class="headerlink" title="- 「Action: Deny. Reason: SNI TLS extension was missing」で拒否される理由を教えてください。"></a>- 「Action: Deny. Reason: SNI TLS extension was missing」で拒否される理由を教えてください。</h4><p>アプリケーションルールでは TLS の通信を評価する際に Client Hello に含まれる SNI の Server Name を参照し、評価を行っております。そのため、SNI が利用されない通信はアプリケーションルールで制御することができません。</p><p>例えば、<a href="https://1.2.3.4/">https://1.2.3.4</a> のような IP アドレスでアクセスするような方法ですと、SNI が含まれるずにアプリケーションルールで拒否されることが想定されます。対応策としてはネットワークルールにて制御する必要があります。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/overview#known-issues">既知の問題</a></p><h4 id="NAT-ルールで拒否のログが記録されません。"><a href="#NAT-ルールで拒否のログが記録されません。" class="headerlink" title="- NAT ルールで拒否のログが記録されません。"></a>- NAT ルールで拒否のログが記録されません。</h4><p>NAT ルールで指定されている宛先ポート以外の通信のログは出力されない動作となります。NAT ルールが構成されている宛先ポートに対して通信を行い、拒否のログが出力されるかをご確認ください。</p><h4 id="NAT-ルールの処理順序をおしえてください。"><a href="#NAT-ルールの処理順序をおしえてください。" class="headerlink" title="- NAT ルールの処理順序をおしえてください。"></a>- NAT ルールの処理順序をおしえてください。</h4><ul><li>NAT ルールはネットワークルールより優先的に評価されます。</li><li>NAT ルールが適用されたトラフィックは暗黙的なネットワークルールにより許可されますが、この暗黙的なルールの優先度は明示的なネットワークルールの優先度よりも低くなります。</li></ul><h4 id="ブラックリスト形式でルールを設定できますか。"><a href="#ブラックリスト形式でルールを設定できますか。" class="headerlink" title="- ブラックリスト形式でルールを設定できますか。"></a>- ブラックリスト形式でルールを設定できますか。</h4><p>Azure Firewall は既定でホワイトリスト形式ですが、優先度が低いルールで広い範囲で許可するルールコレクションを設定し、優先度が高いルールコレクションで特定の通信を拒否するルールを設定することでブラックリスト形式で対応することができます。</p><p>以下は設定例です。</p><table><thead><tr><th>優先度</th><th>ネットワーク ルールコレクション</th><th>プロトコル</th><th>送信元</th><th>宛先</th><th>宛先ポート</th><th>アクション</th></tr></thead><tbody><tr><td>100</td><td>Deny-SSH</td><td>TCP</td><td>10.0.0.0/8</td><td>1.2.3.4/32</td><td>22</td><td>Deny</td></tr><tr><td>200</td><td>Allow-ALL</td><td>TCP</td><td>Any</td><td>Any</td><td>*</td><td>Allow</td></tr></tbody></table><p><em><strong>ただし、拒否ルールを作成する際は TCP の戻りのパケット (SYN/ACK) を拒否しないように考慮する必要があります。</strong></em><br>以下のドキュメントにも記載がありますが、TCP の戻りのパケット (SYN/ACK) を拒否するようなルールがある場合、SYN パケットが許可された後も、SYN/ACK パケットが Azure Firewall で拒否されてしまい通信を確立することができません。<br>診断ログにも出力されない動作であることを確認しているため、注意が必要です。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/rule-processing#three-way-handshake-behavior">https://docs.microsoft.com/ja-jp/azure/firewall/rule-processing#three-way-handshake-behavior</a></p><blockquote><p>ステートフル サービスとして、Azure Firewall では、送信元から送信先への許可されたトラフィックに対する TCP 3 方向ハンドシェイクを行います。 たとえば、VNet-A から VNet-B などです。<br>VNet-A から VNet-B への許可規則を作成しても、VNet-B から VNet-A への新たに開始される接続が許可されるわけではありません。<br>そのため、VNet-B から VNet-A への明示的な拒否規則を作成する必要はありません。 この拒否規則を作成すると、VNet-A から VNet-B への最初の許可規則の 3 方向ハンドシェイクを中断することになります。</p></blockquote><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><p>Azure Firewall の概要や機能については以下にも記載がありますのでご一読ください。</p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/overview">Azure Firewall とは</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/features">Azure Firewall の機能</a></p><p><a href="https://docs.microsoft.com/ja-jp/azure/firewall/firewall-faq">Azure Firewall FAQ</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チーム檜山です。&lt;/p&gt;
&lt;p&gt;今回は Azure Firewall の各ルールの動作についてよくあるお問い合わせを紹介させていただきます。&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;&lt;span id=&quot;apprule-block&quot;&gt;&lt;/span</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
  </entry>
  
  <entry>
    <title>イベント ログ Service Control Manage 7031 - RdAgent サービスの再起動について</title>
    <link href="https://jpaztech.github.io/blog/vm/7031-rdagent-restart/"/>
    <id>https://jpaztech.github.io/blog/vm/7031-rdagent-restart/</id>
    <published>2022-05-23T08:30:00.000Z</published>
    <updated>2022-12-22T05:56:35.191Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの前田です。</p><p>Azure 上の Windows 仮想マシンをご利用のお客様から、RdAgent サービスの再起動を示すイベント ログ Service Control Manager 7031 の原因や影響についてお問い合わせいただくことがあります。そのため、本記事では当該イベントについてご紹介します。</p><span id="more"></span><p><img src="/blog/vm/7031-rdagent-restart/01.png"></p><blockquote><p>ログの名前:   System<br>ソース:       Service Control Manager<br>日付:         yyyy/mm/dd hh:mm:ss<br>イベント ID:  7031<br>レベル:       エラー<br>キーワード:   クラシック<br>説明:<br>RdAgent サービスは予期せぬ原因により終了しました。<br>このサービスの終了は 1 回目です。<br>次の修正操作が 0 ミリ秒以内に実行されます: サービスの再開。</p></blockquote><hr><h2 id="イベント-ログ-Service-Control-Manage-7031"><a href="#イベント-ログ-Service-Control-Manage-7031" class="headerlink" title="イベント ログ Service Control Manage 7031"></a>イベント ログ Service Control Manage 7031</h2><p>RdAgent サービスの予期せぬ終了を示すイベント ログ Service Control Manager 7031 は、一般的に、Windows Azure ゲスト エージェントのアップデート時に実施されるエージェントの再起動に起因して記録されるメッセージとなります。<br>※アップデートは必要に応じて不定期に実施されます。</p><p>アップデート時には新しいバージョンで Windows Azure ゲスト エージェントを起動する必要があるため、サービスの再起動が発生します。そのため、アップデート時に本イベントのエラー メッセージが記録されることは想定通りの動作となります。</p><p>イベント記録後に RdAgent サービスが再開されており、エラー メッセージが継続して出力されていないような場合には、静観いただいて問題ありません。RdAgent サービスが再開された場合には、イベント ログ Service Control Manager 7036 が記録されますのでご確認いただけますと幸いです。</p><p><img src="/blog/vm/7031-rdagent-restart/02.png"></p><blockquote><p>ログの名前:   System<br>ソース:       Service Control Manager<br>日付:         yyyy/mm/dd hh:mm:ss<br>イベント ID:  7036<br>レベル:       情報<br>キーワード:   クラシック<br>説明:<br>RdAgent サービスは 実行中 状態に移行しました。</p></blockquote><h2 id="仮想マシン-エージェントのアップデートと-RdAgent-サービスの再起動"><a href="#仮想マシン-エージェントのアップデートと-RdAgent-サービスの再起動" class="headerlink" title="仮想マシン エージェントのアップデートと RdAgent サービスの再起動"></a>仮想マシン エージェントのアップデートと RdAgent サービスの再起動</h2><p>アップデートの有無についてはイベント ログから判断することは叶わず、C:\WindowsAzure\Logs 配下に出力される WaAppAgent.log を確認する必要があります。</p><h3 id="WaAppAgent-log"><a href="#WaAppAgent-log" class="headerlink" title="WaAppAgent.log"></a>WaAppAgent.log</h3><p>Windows Azure ゲスト エージェントのアップデート時には、C:\WindowsAzure\Logs 配下に出力される WaAppAgent.log に下記のようなログが記録されます。</p><blockquote><p>(前のバージョンでの起動を示すログ)<br><em>[000000XX] [XX/XX/XXXX XX:XX:XX.XX] [INFO]  WindowsAzureGuestAgent starting.  Version X.X.XXXXX.XXX</em><br>…<br>(アップデート処理により停止処理が開始されたことを示すログ)<br><em>[000000XX] [XX/XX/XXXX XX:XX:XX.XX] [WARN]  Stopping from update</em><br>…<br>(エージェントが停止して新しいバージョンでの起動を示すログ)<br><em>[000000XX] [XX/XX/XXXX XX:XX:XX.XX] [INFO]  WindowsAzureGuestAgent stopped successfully.</em><br><em>[000000XX] [XX/XX/XXXX XX:XX:XX.XX] [INFO]  WindowsAzureGuestAgent starting. Version X.X.XXXXX.YYY</em></p></blockquote><h3 id="確認の結果アップデート起因ではない場合"><a href="#確認の結果アップデート起因ではない場合" class="headerlink" title="確認の結果アップデート起因ではない場合"></a>確認の結果アップデート起因ではない場合</h3><p>アップデートの有無にかかわらず、イベント記録後に RdAgent サービスが再開されており、エラー メッセージが継続して出力されていないような場合には、静観いただいて問題ありません。<br>もし、仮想マシン エージェント自体の動作に問題がある場合には、後述の「<a href="https://jpaztech.github.io/blog/vm/7031-rdagent-restart/#%E3%81%8A%E3%81%BE%E3%81%91-%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3-%E3%82%A8%E3%83%BC%E3%82%B8%E3%82%A7%E3%83%B3%E3%83%88%E3%81%AE%E7%8A%B6%E6%85%8B%E7%A2%BA%E8%AA%8D%E6%96%B9%E6%B3%95">[おまけ] 仮想マシン エージェントの状態確認方法</a>」をご確認の上、切り分けいただけますと幸いです。</p><hr><h2 id="補足情報"><a href="#補足情報" class="headerlink" title="補足情報"></a>補足情報</h2><h3 id="仮想マシン-エージェントとは"><a href="#仮想マシン-エージェントとは" class="headerlink" title="仮想マシン エージェントとは"></a>仮想マシン エージェントとは</h3><p>仮想マシン エージェントとは、仮想マシンと Azure 基盤側とのやり取りを管理するプロセスであり、仮想マシンの拡張機能の管理や仮想マシンのステータスの報告などを実施しています。<br>Windows 仮想マシンには Windows Azure ゲスト エージェントが、Linux 仮想マシンには Azure Linux エージェント (waagent) があります。</p><blockquote><p>ご参考) [Windows] Azure 仮想マシン エージェントの概要<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-windows">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-windows</a></p></blockquote><blockquote><p>ご参考) [Linux] Azure Linux エージェントの理解と使用<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-linux">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-linux</a></p></blockquote><h3 id="Windows-仮想マシンの仮想マシン-エージェント-Windows-Azure-ゲスト-エージェント"><a href="#Windows-仮想マシンの仮想マシン-エージェント-Windows-Azure-ゲスト-エージェント" class="headerlink" title="Windows 仮想マシンの仮想マシン エージェント (Windows Azure ゲスト エージェント)"></a>Windows 仮想マシンの仮想マシン エージェント (Windows Azure ゲスト エージェント)</h3><p>Windows Azure ゲスト エージェントは、Azure Marketplace イメージからデプロイされたすべての Windows 仮想マシンに既定でインストールされます。<br>Windows インストーラー パッケージを使用して、手動でインストールすることも可能であり、カスタム イメージを用いて仮想マシンを作成するときやオンプレミス環境を移行いただく際には、手動でのインストールが必要な場合があります。</p><p>Windows 仮想マシンに Windows Azure ゲスト エージェントが正常にインストールされると、次のサービスが 仮想マシンの services.msc に一覧表示されます。</p><ul><li>Windows Azure ゲスト エージェント サービス</li><li>テレメトリ サービス (バージョン 2.7.41491.971 以降のバージョンでは表示されません)</li><li>RdAgent サービス</li></ul><h3 id="RdAgent-とは"><a href="#RdAgent-とは" class="headerlink" title="RdAgent とは"></a>RdAgent とは</h3><p>RdAgent とは、Windows Azure ゲスト エージェント (Windows OS 用の仮想マシン エージェント) のサービスの 1 つであり、RdAgent サービスはゲスト エージェントのインストールや、仮想マシンから物理ホスト上のホスト エージェントにハートビートを送信する役割を担っています。</p><h3 id="RdAgent-が停止している場合の影響"><a href="#RdAgent-が停止している場合の影響" class="headerlink" title="RdAgent が停止している場合の影響"></a>RdAgent が停止している場合の影響</h3><p>RdAgent サービスが実行されていない場合、Windows Azure ゲスト エージェントが正しく動作しません。<br>ゲスト OS 内の動作 (システムやご利用のアプリケーション) には影響しませんが、Azure 基盤側でゲスト OS の状態を取得できずに、プロビジョニングがタイムアウトとなるまで完了しない、拡張機能が正しくご利用いただけない、といったことが発生します。</p><h3 id="おまけ-仮想マシン-エージェントの状態確認方法"><a href="#おまけ-仮想マシン-エージェントの状態確認方法" class="headerlink" title="[おまけ] 仮想マシン エージェントの状態確認方法"></a>[おまけ] 仮想マシン エージェントの状態確認方法</h3><p>仮想マシン エージェントの状態は Azure Portal より確認することが可能です。<br>[Virtual Machines] - [&lt;当該仮想マシン&gt;] のページを開き、左メニュー [概要] の下記画面にて “エージェントの状態” が “Ready” であれば問題なく稼働していると判断できます。</p><p><img src="/blog/vm/7031-rdagent-restart/03.png"></p><p>なお、仮想マシン エージェントが正しく稼働していないように見受けられる場合のトラブルシューティングは、下記公開情報をご確認ください。</p><blockquote><p>ご参考) Azure ゲスト Windowsのトラブルシューティング<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/windows-azure-guest-agent">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/windows-azure-guest-agent</a></p></blockquote><blockquote><p>ご参考) Windows ゲスト エージェント (WinGA) の再インストール方法<br><a href="https://jpaztech.github.io/blog/vm/re-install-windows-azure-guest-agent/">https://jpaztech.github.io/blog/vm/re-install-windows-azure-guest-agent/</a></p></blockquote><br>いかがでしたでしょうか。イベント ログでエラーが記録されていると、影響や対処の有無などでご心配いただくことも多いかと存じますが、RdAgent サービスの予期せぬ終了を示すイベント ログに関して、上記情報がお役に立てれば幸いです。]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの前田です。&lt;/p&gt;
&lt;p&gt;Azure 上の Windows 仮想マシンをご利用のお客様から、RdAgent サービスの再起動を示すイベント ログ Service Control Manager 7031 の原因や影響についてお問い合わせいただくことがあります。そのため、本記事では当該イベントについてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Windows" scheme="https://jpaztech.github.io/blog/tags/Windows/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM からストレージ アカウントへアクセスする際の挙動とアクセス元制御</title>
    <link href="https://jpaztech.github.io/blog/storage/storageFirewall-accesscontroll/"/>
    <id>https://jpaztech.github.io/blog/storage/storageFirewall-accesscontroll/</id>
    <published>2022-05-06T01:30:00.000Z</published>
    <updated>2022-12-22T05:56:35.191Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの木下です。<br>今回は、Azure VM からストレージ アカウントへアクセスする際の挙動とアクセス元制御ついてご案内します。</p><span id="more"></span><h2 id="Azure-VM-からストレージ-アカウントへアクセスする際の挙動"><a href="#Azure-VM-からストレージ-アカウントへアクセスする際の挙動" class="headerlink" title="Azure VM からストレージ アカウントへアクセスする際の挙動"></a>Azure VM からストレージ アカウントへアクセスする際の挙動</h2><p>VM からストレージ アカウントへアクセスを行う場合、両者のリージョンが異なる場合と、同じ場合ではアクセス元の IP アドレスが異なる点に、ご注意ください。</p><h3 id="VM-とストレージ-アカウントが同一リージョンに存在する場合"><a href="#VM-とストレージ-アカウントが同一リージョンに存在する場合" class="headerlink" title="VM とストレージ アカウントが同一リージョンに存在する場合"></a>VM とストレージ アカウントが同一リージョンに存在する場合</h3><p><strong>パブリック エンドポイント または サービス エンドポイントを使用</strong></p><p>VM からストレージ アカウントへアクセスすると、アクセス元 IP は VM のパブリック IP とならず、Azure 内部で使用しているプライベート IP となります。</p><h3 id="VM-とストレージ-アカウントが異なるリージョンに存在する場合"><a href="#VM-とストレージ-アカウントが異なるリージョンに存在する場合" class="headerlink" title="VM とストレージ アカウントが異なるリージョンに存在する場合"></a>VM とストレージ アカウントが異なるリージョンに存在する場合</h3><p><strong>パブリック エンドポイントを使用</strong></p><p>VM からストレージ アカウントへアクセスすると、アクセス元 IP は VM のパブリック IP となります。</p><p><strong>サービス エンドポイントを使用</strong></p><p>VM からストレージ アカウントへアクセスすると、アクセス元 IP は VM のパブリック IP とならず、Azure 内部で使用しているプライベート IP となります。</p><p>(ご留意)<br>サービス エンドポイントがある仮想ネットワークのリージョンがペア リージョンではない他のリージョンである場合、アクセス元 IP は VM のパブリック IP となります。<br>ただ、現在、プレビュー段階ではありますが、ペア リージョン以外の他のリージョンにある仮想ネットワークからのアクセスにおいてもサービス エンドポイントを利用することが可能となりましました。<br>つまり、サービス エンドポイントを有効化することで、他のリージョンからのアクセスの際にパブリック IP ではなく、Azure 内部で使用しているプライベート IP を利用することができるようになりました。</p><p>参考）すべての地域の Azure リージョン間レプリケーションのペアリング<br><a href="https://docs.microsoft.com/ja-jp/azure/availability-zones/cross-region-replication-azure#azure-cross-region-replication-pairings-for-all-geographies">https://docs.microsoft.com/ja-jp/azure/availability-zones/cross-region-replication-azure#azure-cross-region-replication-pairings-for-all-geographies</a><br>※ペア リージョン例: 東日本リージョンと西日本リージョン</p><p>参考）Azure Storage ファイアウォールおよび仮想ネットワークを構成する &gt; 他のリージョンの仮想ネットワークへのアクセスを有効にする (プレビュー)<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-network-security?tabs=azure-powershell#enabling-access-to-virtual-networks-in-other-regions-preview">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-network-security?tabs=azure-powershell#enabling-access-to-virtual-networks-in-other-regions-preview</a></p><blockquote><p>&lt;抜粋&gt;</p><p>別のリージョンにある仮想ネットワークからのアクセスを有効にするには、仮想ネットワークのサブスクリプションに AllowGlobalTagsForStorage 機能を登録します。 ストレージ サービス エンドポイントを備えた他のリージョンにあるサブネットでは、ストレージ アカウントとの通信にパブリック IP アドレスを使用しなくなりました。 トラフィックはすべてプライベート IP アドレスから送信され、それらのサブネットからのトラフィックを許可する IP ネットワーク ルールはいずれも影響を受けなくなりました。</p></blockquote><h3 id="VM-からストレージアカウントへのアクセス検証"><a href="#VM-からストレージアカウントへのアクセス検証" class="headerlink" title="VM からストレージアカウントへのアクセス検証"></a>VM からストレージアカウントへのアクセス検証</h3><p>・VM (東日本) から、ストレージ アカウント (東日本) に対して AzCopy を実施した結果</p><p>[ VM の構成 ]</p><p>パブリック IP : 40.115.XX.XX<br>プライベート IP : 10.1.0.4</p><p>[ ストレージ アカウントの診断ログ] ※1 、※2</p><p>サービス エンドポイント無効、パブリック エンドポイント経由のアクセス</p><blockquote><p>1.0;2022-05-01T09:19:01.3225693Z;GetBlobProperties;SASSuccess;200;4;4;sas;;storageaccountname;blob;”<a href="https://storageaccountname.blob.core.windows.net/container01/test.csv?sas&quot;;&quot;/storageaccountname/container01/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;10.1.0.4:50100;2019-12-12;413;0;543;0;0;;;&quot;&quot;0x8DXXXXXXXXXXXXX&quot;&quot;;Sunday">https://storageaccountname.blob.core.windows.net:443/container01/test.csv?sas&quot;;&quot;/storageaccountname/container01/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;10.1.0.4:50100;2019-12-12;413;0;543;0;0;;;&quot;&quot;0x8DXXXXXXXXXXXXX&quot;&quot;;Sunday</a>, 01-May-22 09:19:01 GMT;;”AzCopy/10.6.0 Azure-Storage/0.10 (go1.13; Windows_NT)”;;”XXXXXXXXXXXXXXXXXXXXXXXX”</p></blockquote><p>アクセス元 IP は 10.1.0.4 であることが分かります。</p><p>サービス エンドポイント有効、サービス エンドポイント経由のアクセス</p><blockquote><p>1.0;2022-05-01T10:43:08.5058732Z;PutBlob;SASSuccess;201;12;12;sas;;akstor001;blob;”<a href="https://storageaccountname.blob.core.windows.net/container01/test.csv?sas&quot;;&quot;/storageaccountname/container01/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;10.1.0.4:50636;2019-12-12;624;806;337;0;806;;&quot;XXXXXXXXXXXXXXXXXXXXXXXX&quot;;&quot;&quot;0x8DXXXXXXXXXXXXX&quot;&quot;;Sunday">https://storageaccountname.blob.core.windows.net:443/container01/test.csv?sas&quot;;&quot;/storageaccountname/container01/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;10.1.0.4:50636;2019-12-12;624;806;337;0;806;;&quot;XXXXXXXXXXXXXXXXXXXXXXXX&quot;;&quot;&quot;0x8DXXXXXXXXXXXXX&quot;&quot;;Sunday</a>, 01-May-22 10:43:08 GMT;;”AzCopy/10.6.0 Azure-Storage/0.10 (go1.13; Windows_NT)”;;”XXXXXXXXXXXXXXXXXXXXXXXX”</p></blockquote><p>アクセス元 IP は 10.1.0.4 であることが分かります。</p><p>・VM (西日本) から、ストレージ アカウント (東日本) に対して AzCopy を実施した結果</p><p>[ VM の構成 ]</p><p>パブリック IP : 20.89.XX.XX<br>プライベート IP : 10.4.0.4</p><p>[ ストレージ アカウントの診断ログ ] ※1 、※2</p><p>サービス エンドポイント無効、パブリック エンドポイント経由のアクセス</p><blockquote><p>1.0;2022-05-01T09:20:17.4989380Z;GetBlobProperties;SASSuccess;200;3;3;sas;;storageaccountname;blob;”<a href="https://storageaccountname.blob.core.windows.net/container02/test.csv?sas&quot;;&quot;/storageaccountname/container02/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;20.89.XX.XX:49842;2019-12-12;413;0;543;0;0;;;&quot;&quot;0x8DXXXXXXXXXXXXX&quot;&quot;;Sunday">https://storageaccountname.blob.core.windows.net:443/container02/test.csv?sas&quot;;&quot;/storageaccountname/container02/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;20.89.XX.XX:49842;2019-12-12;413;0;543;0;0;;;&quot;&quot;0x8DXXXXXXXXXXXXX&quot;&quot;;Sunday</a>, 01-May-22 09:20:17 GMT;;”AzCopy/10.6.0 Azure-Storage/0.10 (go1.13; Windows_NT)”;;”XXXXXXXXXXXXXXXXXXXXXXXX”</p></blockquote><p>アクセス元 IP は 20.89.XX.XX であることが分かります。</p><p>サービス エンドポイント有効、サービス エンドポイント経由のアクセス</p><blockquote><p>1.0;2022-05-01T10:42:56.2621284Z;PutBlob;SASSuccess;201;11;11;sas;;akstor001;blob;”<a href="https://storageaccountname.blob.core.windows.net/container02/test.csv?sas&quot;;&quot;/storageaccountname/container02/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;10.4.0.4:50461;2019-12-12;624;806;337;0;806;;&quot;XXXXXXXXXXXXXXXXXXXXXXXX&quot;;&quot;&quot;0x80x8DXXXXXXXXXXXXX&quot;&quot;;Sunday">https://storageaccountname.blob.core.windows.net:443/container02/test.csv?sas&quot;;&quot;/storageaccountname/container02/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;10.4.0.4:50461;2019-12-12;624;806;337;0;806;;&quot;XXXXXXXXXXXXXXXXXXXXXXXX&quot;;&quot;&quot;0x80x8DXXXXXXXXXXXXX&quot;&quot;;Sunday</a>, 01-May-22 10:42:56 GMT;;”AzCopy/10.6.0 Azure-Storage/0.10 (go1.13; Windows_NT)”;;”XXXXXXXXXXXXXXXXXXXXXXXX”</p></blockquote><p>アクセス元 IP は 10.4.0.4 であることが分かります。</p><p>・VM (米国中部) から、ストレージ アカウント (東日本) に対して AzCopy を実施した結果</p><p>[ VM の構成 ]</p><p>パブリック IP :  40.122.XX.XX<br>プライベート IP : 10.3.0.4</p><p>[ ストレージ アカウントの診断ログ] ※1 、※2</p><p>サービス エンドポイント無効、パブリック エンドポイント経由のアクセス</p><blockquote><p>1.0;2022-05-01T09:19:12.0009834Z;GetBlobProperties;SASSuccess;200;4;4;sas;;akstor001;blob;”<a href="https://storageaccountname.blob.core.windows.net/container03/test.csv?sas&quot;;&quot;/storageaccountname/container03/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;40.122.XX.XX:50144;2019-12-12;413;0;543;0;0;;;&quot;&quot;0x8DXXXXXXXXXXXXX&quot;&quot;;Sunday">https://storageaccountname.blob.core.windows.net:443/container03/test.csv?sas&quot;;&quot;/storageaccountname/container03/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;40.122.XX.XX:50144;2019-12-12;413;0;543;0;0;;;&quot;&quot;0x8DXXXXXXXXXXXXX&quot;&quot;;Sunday</a>, 01-May-22 09:19:11 GMT;;”AzCopy/10.6.0 Azure-Storage/0.10 (go1.13; Windows_NT)”;;”XXXXXXXXXXXXXXXXXXXXXXXX”</p></blockquote><p>アクセス元 IP は 40.122.XX.XX であることが分かります。</p><p>サービス エンドポイント有効、サービスエ ンドポイント経由のアクセス</p><blockquote><p>1.0;2022-05-01T12:10:54.1043116Z;GetBlobProperties;SASSuccess;200;5;5;sas;;akstor001;blob;”<a href="https://storageaccountname.blob.core.windows.net/container03/test.csv?sas&quot;;&quot;/storageaccountname/container03/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;10.3.0.4:51283;2019-12-12;413;0;543;0;0;;;&quot;&quot;0x8DXXXXXXXXXXXXX&quot;&quot;;Sunday">https://storageaccountname.blob.core.windows.net:443/container03/test.csv?sas&quot;;&quot;/storageaccountname/container03/test.csv&quot;;XXXXXXXXXXXXXXXXXXXXXXX;0;10.3.0.4:51283;2019-12-12;413;0;543;0;0;;;&quot;&quot;0x8DXXXXXXXXXXXXX&quot;&quot;;Sunday</a>, 01-May-22 12:10:53 GMT;;”AzCopy/10.6.0 Azure-Storage/0.10 (go1.13; Windows_NT)”;;”XXXXXXXXXXXXXXXXXXXXXXXX”</p></blockquote><p>アクセス元 IP は 10.3.0.4 であることが分かります。</p><p>VM のリージョンとストレージ アカウントのリージョンがペア リージョンでない場合、サービス エンドポイントを利用する際は、以下公開ドキュメントの手順を実施する必要があります。</p><p>参考）他のリージョンの仮想ネットワークへのアクセスを有効にする (プレビュー)<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-network-security?tabs=azure-powershell#enabling-access-to-virtual-networks-in-other-regions-preview">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-network-security?tabs=azure-powershell#enabling-access-to-virtual-networks-in-other-regions-preview</a></p><p>※1 ストレージ アカウントの診断ログは、BLOB コンテナーの $logs 配下に格納されます。<br>※2 ストレージ アカウントの診断ログ フォーマット</p><p>参考）Storage分析ログの形式<br><a href="https://docs.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-log-format">https://docs.microsoft.com/ja-jp/rest/api/storageservices/storage-analytics-log-format</a></p><h3 id="Azure-VM-からストレージ-アカウントへアクセスする際の挙動についてのまとめ"><a href="#Azure-VM-からストレージ-アカウントへアクセスする際の挙動についてのまとめ" class="headerlink" title="Azure VM からストレージ アカウントへアクセスする際の挙動についてのまとめ"></a>Azure VM からストレージ アカウントへアクセスする際の挙動についてのまとめ</h3><p>ストレージ アカウントのアクセス制御について、現段階では、仮想ネットワーク/サブネット単位、もしくは外部からのパブリック IP 単位での制御のみが可能です。<br>そのため、VM とストレージ アカウントが同一リージョンである場合、パブリック エンドポイント、サービス エンドポイントいずれを使用する場合も仮想ネットワーク/サブネット単位での制御までとなります。<br>VM とストレージ アカウントが異なるリージョンにある場合、パブリックエンドポイントを使用する際は、パブリック IP 単位での制御、サービスエンドポイントを使用する際は、仮想ネットワーク/サブネット単位での制御となります。</p><h2 id="ストレージアカウントへのアクセス制御について"><a href="#ストレージアカウントへのアクセス制御について" class="headerlink" title="ストレージアカウントへのアクセス制御について"></a>ストレージアカウントへのアクセス制御について</h2><p>先述の通り、ストレージ アカウントのファイアウォールでは、仮想ネットワーク/サブネット単位、もしくは外部からのパブリック IP 単位での制御のみとなりますが、<br>「ストレージ アカウントへのアクセス制御を VM 単位で行う方法はあるか」というお問い合わせをいただくことがあります。<br>VM 単位でのアクセス元制御を行いたい場合、プレビュー段階の機能とはなりますが、プライベート エンドポイントに対する NSG を利用することで、プライベート エンドポイントの IP アドレスに対して NSG でアクセス制御を行うことが可能となります。</p><p>参考）プライベート エンドポイントのネットワーク ポリシーを管理する<br><a href="https://docs.microsoft.com/ja-jp/azure/private-link/disable-private-endpoint-network-policy">https://docs.microsoft.com/ja-jp/azure/private-link/disable-private-endpoint-network-policy</a></p><blockquote><p>&lt;抜粋&gt;<br>プライベート エンドポイントに対する NSG と UDR のサポートは、一部のリージョンでパブリック プレビュー段階です。 詳細については、「Private Link UDR のサポートのパブリック プレビュー」と「Private Link ネットワーク セキュリティ グループのサポートのパブリック プレビュー」を参照してください。 このプレビュー バージョンはサービス レベル アグリーメントなしで提供されています。運用環境のワークロードに使用することはお勧めできません。 特定の機能はサポート対象ではなく、機能が制限されることがあります。 詳しくは、Microsoft Azure プレビューの追加使用条件に関するページをご覧ください。</p></blockquote><h3 id="VM-単位でのストレージアカウントへのアクセス制御検証"><a href="#VM-単位でのストレージアカウントへのアクセス制御検証" class="headerlink" title="VM 単位でのストレージアカウントへのアクセス制御検証"></a>VM 単位でのストレージアカウントへのアクセス制御検証</h3><p>1.ストレージ アカウントに対して、プライベート エンドポイントを構成します。※3<br><img src="/blog/storage/storageFirewall-accesscontroll/storageFW-ac01.png"></p><p><img src="/blog/storage/storageFirewall-accesscontroll/storageFW-ac02.png"></p><p>2.プライベート エンドポイントのプレビュー機能 (AllowPrivateEndpointNSG) を有効化します。※4</p><p>プライベート エンドポイントのプレビュー機能の有効化状況の確認</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-AzProviderFeature -ProviderNamespace Microsoft.Network -FeatureName AllowPrivateEndpointNSG</span><br></pre></td></tr></table></figure><p>プライベート エンドポイントのプレビュー機能の有効化</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Register-AzProviderFeature -FeatureName AllowPrivateEndpointNSG -ProviderNamespace Microsoft.Network</span><br></pre></td></tr></table></figure><p>本機能の有効化には少しお時間を要しますが、RegistrationState が Registered となれば有効化完了です。</p><p>3.対象の仮想ネットワーク/サブネットに対してプライベート エンドポイントの NSG を有効にします。※5</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">$</span><span class="bash">SubnetName = <span class="string">&quot;default&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">VnetName = <span class="string">&quot;myVNet&quot;</span></span></span><br><span class="line"><span class="meta">$</span><span class="bash">RGName = <span class="string">&quot;myResourceGroup&quot;</span></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">$</span><span class="bash">virtualNetwork= Get-AzVirtualNetwork -Name <span class="variable">$VnetName</span> -ResourceGroupName <span class="variable">$RGName</span></span></span><br><span class="line"><span class="meta">($</span><span class="bash">virtualNetwork | Select -ExpandProperty subnets | Where-Object  &#123;<span class="variable">$_</span>.Name -eq <span class="variable">$SubnetName</span>&#125;).PrivateEndpointNetworkPolicies = <span class="string">&quot;Enabled&quot;</span></span>  </span><br><span class="line"><span class="meta">$</span><span class="bash">virtualNetwork | Set-AzVirtualNetwork</span></span><br></pre></td></tr></table></figure><p>4.NSG を設定します。</p><p>ソース IP アドレス/CIDR 範囲：アクセス元 VM のプライベート IP を登録</p><p>宛先 IP アドレス/CIDR 範囲：ストレージ アカウントのプライベート エンドポイントが構成されている仮想ネットワークのアドレス空間から割り振られたプライベート IP を登録</p><p><img src="/blog/storage/storageFirewall-accesscontroll/storageFW-ac03.png"></p><p>5.アクセス拒否した端末よりストレージアカウント内コンテナ―へアクセスします。</p><p>NSG にてアクセス拒否した VM からストレージアカウント内コンテナ―へアクセスできないことを確認します。<br><img src="/blog/storage/storageFirewall-accesscontroll/storageFW-ac04.png"></p><p>上記のようにプライベート エンドポイントに対する NSG を利用することで VM 単位でのアクセス元制御を実現することは可能です。<br>ただし、公開ドキュメントに記載の通り、プライベート エンドポイントに対する NSG のサポートは現時点でプレビュー段階となり、商用環境での運用が正式にサポートされるものではございません。公開ドキュメント上の情報は予告なく変更される可能性がありますので、あらかじめご了承の上、ご利用をご検討くださいませ。</p><p>参考）<br>※3<br>チュートリアル:Azure プライベート エンドポイントを使用してストレージ アカウントに接続する<br><a href="https://docs.microsoft.com/ja-jp/azure/private-link/tutorial-private-endpoint-storage-portal">https://docs.microsoft.com/ja-jp/azure/private-link/tutorial-private-endpoint-storage-portal</a><br>Azure Storage のプライベート エンドポイントを使用する<br><a href="https://docs.microsoft.com/ja-jp/azure/storage/common/storage-private-endpoints">https://docs.microsoft.com/ja-jp/azure/storage/common/storage-private-endpoints</a></p><p>※4<br>Public preview of Private Link Network Security Group Support<br><a href="https://azure.microsoft.com/ja-jp/updates/public-preview-of-private-link-network-security-group-support/">https://azure.microsoft.com/ja-jp/updates/public-preview-of-private-link-network-security-group-support/</a></p><p>※5<br>プライベート エンドポイントのネットワーク ポリシーを管理する<br><a href="https://docs.microsoft.com/ja-jp/azure/private-link/disable-private-endpoint-network-policy#azure-powershell">https://docs.microsoft.com/ja-jp/azure/private-link/disable-private-endpoint-network-policy#azure-powershell</a></p><hr><p>本稿は以上となりますが、いかがでしたでしょうか。 本稿が皆様のお役に立てれば幸いです。</p><p>※本情報の内容（添付文書、リンク先などを含む）は、作成日時点でのものであり、予告なく変更される場合があります。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの木下です。&lt;br&gt;今回は、Azure VM からストレージ アカウントへアクセスする際の挙動とアクセス元制御ついてご案内します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Storage" scheme="https://jpaztech.github.io/blog/tags/Storage/"/>
    
  </entry>
  
  <entry>
    <title>お問い合わせの発行方法について</title>
    <link href="https://jpaztech.github.io/blog/information/How-to-inquiry-to-the-Azure-Support/"/>
    <id>https://jpaztech.github.io/blog/information/How-to-inquiry-to-the-Azure-Support/</id>
    <published>2022-03-14T08:30:00.000Z</published>
    <updated>2022-12-22T05:56:35.083Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームです。</p><p>私たちは、Azure をご利用いただいているお客様に、Azure を正常かつ快適にご利用いただくためのご支援を差し上げています。<br>この度、Azure サポートを効果的に利用するやり方について知りたい、というご要望を頂戴しましたので、以下にサポートへのお問い合わせ方法をご案内させていただきます。</p><span id="more"></span><p>本資料は、以下のようなお客様にお読みいただくことを想定しています。  </p><ul><li>お問い合わせを起票するための契約や、お問い合わせ発行から連絡をもらえるまでの応答時間などのルールと流れを知りたい</li><li>マイクロソフトのサポートからどのような内容を対応してもらえるのか知っておきたい</li><li>Azure サポートを利用する際にどのように起票すれば効率的に成果が得られるか知りたい</li></ul><p>なお、以下に記載しました内容はあくまで 「一般的なお問合せの流れ」 をご紹介していますので、もしこちらに記載がなくお悩みの点がございましたら、一旦お問合せを起票いただくか、既に対応させていただいている件があればそちらの担当サポートエンジニアまで、お気兼ねなくご相談をいただければ幸いです。</p><hr><h2 id="サポート-リクエスト-お問い合わせ-の作成"><a href="#サポート-リクエスト-お問い合わせ-の作成" class="headerlink" title="サポート リクエスト (お問い合わせ) の作成"></a>サポート リクエスト (お問い合わせ) の作成</h2><p><a href="https://portal.azure.com/">Azure Portal</a> の画面右上、クエスチョン マークから [ヘルプとサポート] に遷移し、続いて [サポート リクエストの作成] をクリックすることで、Azure のサポート リクエストを作成できます。</p><p><img src="/blog/information/How-to-inquiry-to-the-Azure-Support/help_and_support.png"></p><p><img src="/blog/information/How-to-inquiry-to-the-Azure-Support/help_and_support2.png"></p><blockquote><p>ご参考) Azure サポート要求を作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request">https://docs.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request</a></p></blockquote><hr><h3 id="サポート-リクエスト作成画面-1-問題の説明-ページ"><a href="#サポート-リクエスト作成画面-1-問題の説明-ページ" class="headerlink" title="サポート リクエスト作成画面 - 1. 問題の説明 ページ"></a>サポート リクエスト作成画面 - 1. 問題の説明 ページ</h3><p>まず問題の種類を選択します。<br>サブスクリプションの管理、サービスとサブスクリプションの制限 (クォータ)、課金、に関しては無償でお問い合わせいただけます。</p><p><img src="/blog/information/How-to-inquiry-to-the-Azure-Support/sr_creation.png"></p><p>技術的なお問い合わせについては、有償サポート契約が必要であり、”技術 (各種 Azure サービスについて)” を選択します。<br>ここでは、技術的なお問い合わせをされる際のフローについて説明します。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p><strong>課金・サブスクリプション・クォータのサポートについての参考資料はこちらです</strong></p><p>Japan Azure 課金 サブスクリプション サポート ブログ - サポートにお問い合わせする方法について</p><p><a href="https://jpazasms.github.io/blog/AzureSubscriptionManagement/20131030a/">https://jpazasms.github.io/blog/AzureSubscriptionManagement/20131030a/</a></p></div><p><img src="/blog/information/How-to-inquiry-to-the-Azure-Support/sr_creation2.png"></p><h4 id="サブスクリプション"><a href="#サブスクリプション" class="headerlink" title="サブスクリプション"></a>サブスクリプション</h4><p>問題が発生しているリソースを含むサブスクリプションを正しく選ぶことは非常に重要なステップです。</p><ul><li>この画面にて、自動的に、今回の画面を開いているユーザーアカウント (Azure Portal の右上に表示) がお問い合わせ可能なサブスクリプションが検索され、選択可能となります。<br>サポート リクエストでは、ご利用されている環境のヒアリングをしており、サポートからの情報の提示を行う場合があります。<br>お問い合わせされる際には、本アカウントが、対象サブスクリプションの所有者・共同作成者・サービス リクエスト共同作成者のいずれかのセキュリティ ロールが付与されている必要があり、これによってお客様の環境について情報を漏洩していないことを確認しています。</li><li>有償サポート契約との紐付きはサブスクリプション単位で行っています。<br>このため、適切なサポート レベルにてサービス提供が受けられます。</li></ul><div class="alert is-important"><p class="alert-title">重要</p><p><strong>異なるサブスクリプション上のリソースの調査について</strong></p><p>サポートリクエストを発行される際、調査対象リソースのサブスクリプションからお問い合わせくださいますようお願いいたします。</p><p>異なるサブスクリプション上のリソースの調査は、セキュリティ上の問題が発生します。詳しくは以下をご参照ください。</p><p>　</p><p>ご参考) お問い合わせ発行時と「異なる」サブスクリプションの調査依頼に対してのセキュリティ チェックが強化されます</p><p><a href="https://jpaztech.github.io/blog/information/Different-subscriptions-research/">https://jpaztech.github.io/blog/information/Different-subscriptions-research/</a></p><p>ご参考) 電話経由における Azure サブスクリプションの調査のセキュリティ チェックが厳格化されます</p><p><a href="https://jpaztech.github.io/blog/information/Security-check-stricter/">https://jpaztech.github.io/blog/information/Security-check-stricter/</a></p></div><h4 id="サービス-サービスの種類"><a href="#サービス-サービスの種類" class="headerlink" title="サービス (サービスの種類)"></a>サービス (サービスの種類)</h4><p>サービスとは、Azure におけるそれぞれのサービス名のことです。<br>できる限り正確に、どのサービスに対してのお問い合わせであるか選択していただくようお願いします。  </p><p>「Azure」はひとつのサービスではなく、数百種類も存在する様々なサービスのプラットフォームとなっています。<br>Azure サポート チームでは、この膨大なサービスを個々のチームで分担し、より専門的な回答を差し上げられるよう研鑽を積んでおります。<br>適切なサービスを選択していただくことで、専門的な知識を持つサポートエンジニアからの正確なご案内をスムーズに行うことができます。  </p><p>「使用中のサービス」ボタンを選択していると、そのサブスクリプションですでに作成済みのリソースのみがリストアップされるため、絞り込みやすくなります。  </p><h4 id="概要、問題の種類と、サブタイプ"><a href="#概要、問題の種類と、サブタイプ" class="headerlink" title="概要、問題の種類と、サブタイプ"></a>概要、問題の種類と、サブタイプ</h4><p>概要については、簡潔に問題の概要を記載下さい。<br>このキーワードをもとに、問題の種類がリストアップされますので、ここからお客様が直面している問題に近いものを選択します。<br>これは、適切な専任チームにお問合せがルーティングされるための貴重な情報として使われます。<br>厳密な表現が難しい場合には、後続のページにてテキスト フォーマットで詳細を記載可能となりますので、ご安心ください。  </p><div class="alert is-success"><p class="alert-title">ヒント</p><p><strong>起票の単位 (サービスごと、リソースごと)</strong></p><p>サポートをご利用いただく際には、問題の最小単位を切りだしたものを 1 件としてお問合せください。</p><p>これは、お問合せの量に応じて適切なサポート人員を配置し、また必要に応じて複数人での対応によりスピーディなご連絡を差し上げるためであり、サポートご利用の皆様にお願いさせて頂いております。</p><p>分割いただくことが適切な例は以下の通りです。</p><p><ul><li>同じサービスで複数のリソースにて問題が発生しているが、発生パターンが異なるなど同じ原因によるものか不明な場合</li><li>1 つの問題と考えられるが、複数のサービス間にわたって問題が発生しており、どちらに問題があるかそれぞれから見解を受けたい場合 (※ 専任部門がことなるそれぞれのエンジニアから対応が受けられるため。お問い合わせ番号を相互にご連絡いただけましたら、内部で連携を取って調査します。)</li><li>お問い合わせの過程で、関連した質問が発生したが元のお問い合わせ内容と異なる場合</li></ul></p></div><p>なお、複数のお問合せを起票した方が良いか分からない、どのサービスとどのサービスが別々なのか判断がつかない、一問一答にしてしまうと膨大な量になってしまう、といった場合には、まず一件起票いただき、担当のサポートエンジニアとご相談をいただけますと助かります。</p><h3 id="サポート-リクエスト作成画面-2-推奨される解決策-ページ"><a href="#サポート-リクエスト作成画面-2-推奨される解決策-ページ" class="headerlink" title="サポート リクエスト作成画面 - 2. 推奨される解決策 ページ"></a>サポート リクエスト作成画面 - 2. 推奨される解決策 ページ</h3><p>この画面は、特に入力が必要な部分は無く、関連する可能性のある情報が提示される箇所です。</p><p><img src="/blog/information/How-to-inquiry-to-the-Azure-Support/sr_creation3.png"></p><p>Azure においては、お問い合わせによるやりとりにてお手間をかけず、極力お客様ご自身で必要な情報にアクセスが出来るよう、公開情報の刷新を続けております。<br>対象ページでは、1ページ目で記載いただいたトピックにて関連する可能性のある技術資料やトラブルシューティング方法など、お客様での解決をお手伝いする資料を検索し、提示します。</p><p>また、最近発生した大規模な障害の情報も自動的に表示される場合があり、お問い合わせのやりとりを待つ事なく情報が得られる可能性もあります。<br>情報を参照された結果、該当していない、もしくはサポート エンジニアからの対応が必要な場合、次へをクリックして進みます。</p><h3 id="サポート-リクエスト作成画面-3-追加の詳細-ページ"><a href="#サポート-リクエスト作成画面-3-追加の詳細-ページ" class="headerlink" title="サポート リクエスト作成画面 - 3. 追加の詳細 ページ"></a>サポート リクエスト作成画面 - 3. 追加の詳細 ページ</h3><p>サポート リクエストの依頼内容の詳細を入力するページとなります。</p><p><img src="/blog/information/How-to-inquiry-to-the-Azure-Support/sr_creation4.png"></p><p><img src="/blog/information/How-to-inquiry-to-the-Azure-Support/sr_creation5.png"></p><h4 id="問題の詳細"><a href="#問題の詳細" class="headerlink" title="問題の詳細"></a>問題の詳細</h4><p>ここでは、お客様のご利用のサービスやリソースについて、いつから問題が発生したのかや、問題の説明について詳細な記載をお願いしております。<br>サポート エンジニアが迅速に問題内容を把握し、調査を行うためにご協力をいただけますと助かります。</p><p><strong>日時 欄</strong><br>エラーや問題が最初に発生した時間について記載してください。</p><p><strong>説明 欄</strong><br>以下を参考に、問題の詳細について記載してください。</p><ul><li>お問い合わせにおけるゴール</li><li>問題、あるいはご質問内容</li><li>再現の手順 (どのような操作を行うことで問題が発生するか)</li><li>問題の頻度 (○時間に一度、定期的/不定期 など)</li><li>問題が出る直前に、構成や設定面で変更を加えたものがあれば、可能な限り詳細に記載ください。</li><li>詳細なエラー メッセージ。ログファイルや画面ショットなどが準備できる場合、アップロードしていただくことも可能です。(エラーと分かった一部分のみに省略せず、コマンドや操作を行ったところからエラーになるまでの全体を抜粋いただくことが確実です)</li><li>お客様にてお試しいただいた対策や、実施された調査内容、既知の回避策の有無</li><li>(すでに他のサポート リクエストを起票済みで関連している場合) 関連するお問合せ番号と当該件の担当者名</li><li>お問い合わせのやりとりに追加されたい他のご担当者様の連絡先</li></ul><div class="alert is-success"><p class="alert-title">ヒント</p><p>その他の一般的なヒアリング事項については、<a href="https://aka.ms/jpazsupportform">https://aka.ms/jpazsupportform</a> に EXCEL シートをご用意しております。</p><p>起票の際のポイントとして参考にしていただけますと幸いです。</p><p>(本テンプレートを埋めてアップロードしていただいても OK です。)</p></div><div class="alert is-success"><p class="alert-title">ヒント</p><p><strong>過度な略語やプロジェクト固有文言の使用は避けましょう</strong></p><p>一般的に Azure の製品名や機能であるものをのぞき、略称やプロジェクト固有の文言の使用により齟齬が発生する可能性があります。</p><p>例: 「PoC 環境」「プライマリ/セカンダリ」など。</p><p>「PoC ではエラーが出なかったが、本番環境では問題が発生している」 =&gt; PoC 環境、本番環境がどのようなリソース名と構成であるかを明記したり、利用方法などの違いについてもご説明いただくことで、比較調査に役立つ場合があります。</p></div><h4 id="高度な診断情報"><a href="#高度な診断情報" class="headerlink" title="高度な診断情報"></a>高度な診断情報</h4><p>Azure サポートでは、お客様のデータ プライバシーに配慮をしつつ、一部リソースのトラブルシューティングに必要な範囲で基盤ログの抽出を行うといった、高度な診断情報へアクセスを行うことができます。<br>これにより、お客様にて手動で情報を抽出し、弊社に送信いただくといった手間が省けます。<br>基本的には、こちらで「はい」を選択していただくことをお勧めしております。<br>アクセス許可を付与することで Azure サポートが参照できる情報は以下の通りとなります。  </p><blockquote><p>ご参考) Data we use to deliver Azure support<br><a href="https://azure.microsoft.com/en-us/support/legal/support-diagnostic-information-collection/">https://azure.microsoft.com/en-us/support/legal/support-diagnostic-information-collection/</a><br>(※ お問い合わせのクローズと共にアクセス許可は削除されます)</p></blockquote><h4 id="サポート方法"><a href="#サポート方法" class="headerlink" title="サポート方法"></a>サポート方法</h4><p><strong>重要度 (重大度)</strong><br>問題の状況によって、3 種類の重要度が設定可能です。<br>お客様がご利用されている契約と、この緊急度に応じて、初回応答時間が設定されています。<br>初回応答時間は、Microsoft のサポートエンジニアがお客様と連絡を取り、サポートが開始されるまでの時間です。重大度 A 以外は営業時間内でのご連絡となります。</p><ul><li>事業に軽微な影響が及ぶ場合 (重大度 C):<br>Standard サポート契約の場合 8 時間以内</li><li>事業に部分的な影響が発生する場合 (重大度 B):<br>Standard サポート契約の場合 4 時間以内</li><li>事業に大きな影響が発生する場合 (重大度 A):<br>Standard サポート契約の場合 1 時間以内</li></ul><p>詳しくは、<a href="https://azure.microsoft.com/ja-jp/support/plans/response/">サポート プラン—サポート内容と応答性</a> のページを参照してください。</p><div class="alert is-important"><p class="alert-title">重要</p><p><strong>重要度 A について</strong></p><p>平日の夜間と休日も含めた 24x7 (24 時間体制) でのご支援であり、具体的には以下のような「今すぐに対応が必要」という場合の利用を想定しております。</p><p><ul><li>原則として、事業が停止しているような危機的障害 (例 : 全社員のメール送受信が失敗、全社員がアプリケーションへのアクセスに失敗、など) からの復旧を目指したサポートとなります。</p><p>このため、以下のような場合は重要度 B 以下を選択してください。</li><ul><li>復旧済みの問題についての原因の調査</li><li>環境の構築中やこれまでと異なる設定への変更に伴う問題発生で切り戻しによって解消可能</li><li>プロジェクトの進捗に影響が出ているので対応を加速</li></ul><li>即時の情報提供などが必要なため、お客様にも常にご連絡がつく体制の維持をお願いしております</li><li>障害からの復旧後には、お客様とのご相談の上で重要度を変更させていただきます</li></ul></p></p><p></blockquote><blockquote><p><strong>対応中の案件の緊急度 を A (24x7 対応) に上昇させたい場合</strong></p><p>お問い合わせの件について緊急性が上昇した結果、重要度を A に変更されたい場合には、お手数ですが別途新規に重要度 A のお問い合わせの起票をお願いいたします。</p><p>新規のお問合せを起票いただくことで、そのタイミングの緊急対応担当へ呼び出しが行われます。</p><p>その際、既存のお問い合わせのお問合せ番号を文中に記載いただくことで、関連のお問い合わせの経緯も参考にしつつ対応します。</p></div><p><strong>ご希望の連絡方法</strong><br>メールか電話、ご希望の連絡方法をご選択ください。選択した方法で初回のご連絡をさせていただきます。<br>なお、2 回目以降のご連絡はサポートエンジニアが状況に応じて異なるご連絡方法のお願いをさせて頂く場合がございます。<br>もし、より細かいご要望がございましたら、是非お問合せ説明欄にいただけますと助かります。<br>緊急度 A については電話のみでの対応となります。  </p><p><strong>サポート言語</strong><br>対応を要望される言語をご選択ください。  </p><div class="alert is-success"><p class="alert-title">ヒント</p><p><strong>英語でのお問い合わせについて</strong></p><p>英語での対応をご要望の際には、お手数ですがお問合せ本文等もすべて英文での記載をお願いいたします。</p><p>また、緊急度 B かつ 24x7 のお問合せは、現在のところ英語のみの対応となりますのでご注意ください。</p></div><h4 id="連絡先情報"><a href="#連絡先情報" class="headerlink" title="連絡先情報"></a>連絡先情報</h4><p>お客様の連絡先を記載します。<br>「編集」ボタンをクリックすることで、任意のメール アドレスやご担当者名に変更することが可能ですので、お間違え無いよう今一度有効なメールアドレスおよび電話番号かをご確認ください。</p><h3 id="サポート-リクエスト作成画面-4-確認と作成-ページ"><a href="#サポート-リクエスト作成画面-4-確認と作成-ページ" class="headerlink" title="サポート リクエスト作成画面 - 4. 確認と作成 ページ"></a>サポート リクエスト作成画面 - 4. 確認と作成 ページ</h3><p>最後に、お問い合わせの作成確認画面となります。<br>これまでに入力いただいた内容に漏れがないことをご確認の上、チケット作成を完了します。<br>その後、初回応答時間内に、サポート エンジニアからのご連絡差し上げます。  </p><hr><h2 id="お問い合わせの完了-サポート-リクエストのクローズ"><a href="#お問い合わせの完了-サポート-リクエストのクローズ" class="headerlink" title="お問い合わせの完了 (サポート リクエストのクローズ)"></a>お問い合わせの完了 (サポート リクエストのクローズ)</h2><h3 id="お問い合わせの終了方法について"><a href="#お問い合わせの終了方法について" class="headerlink" title="お問い合わせの終了方法について"></a>お問い合わせの終了方法について</h3><p>弊社のサポート エンジニアからの回答によって、お問い合わせに記載頂いた問題が解決した場合や、お客様ご自身で問題が解決した場合は、解決した旨を Azure ポータルやメール、お電話にてご連絡頂きますようお願い致します。<br>その後、弊社のサポート エンジニアにてお問い合わせ対応の終了 (クローズ) を実施します。<br>なお、一定期間お客様からご連絡を頂けなかった場合は、弊社のサポート エンジニアにてお問い合わせのクローズを実施します。  </p><h3 id="クローズ済みのお問い合わせの再開方法について"><a href="#クローズ済みのお問い合わせの再開方法について" class="headerlink" title="クローズ済みのお問い合わせの再開方法について"></a>クローズ済みのお問い合わせの再開方法について</h3><p>お客様のサポート契約が有効な場合は、クローズ済みのお問い合わせに関する追加のご質問や調査を再開することが可能ですので、お問い合わせ内容に対象のお問い合わせ番号を明記の上、新規でお問い合わせを起票頂きますようお願い致します。  </p><h3 id="サポート-リクエストのクローズ後のアンケートについて"><a href="#サポート-リクエストのクローズ後のアンケートについて" class="headerlink" title="サポート リクエストのクローズ後のアンケートについて"></a>サポート リクエストのクローズ後のアンケートについて</h3><p>サポート リクエストをクローズ時にメールでアンケートを送付しています。<br>サポート対応の品質向上を目的として、各サポート リクエストでのサポート エンジニアによる対応品質をお客様にご評価いただいております。<br>回答内容については担当したサポート エンジニアならびに担当チームメンバーで共有し、次回以降のより良い対応に繋げたり、励みとさせていただいております。 </p><h3 id="Azure-への製品へのフィードバックや機能追加の要望"><a href="#Azure-への製品へのフィードバックや機能追加の要望" class="headerlink" title="Azure への製品へのフィードバックや機能追加の要望"></a>Azure への製品へのフィードバックや機能追加の要望</h3><p>Azure における製品自体の品質のフィードバック、機能追加・変更といったご要望については、以下の「アイデア」ページにて集約しております。<br>こちらのサイトから投稿していただくことで、開発部門に直接お声を届けることが可能となっています。  </p><blockquote><p>ご参考) <a href="https://feedback.azure.com/d365community/">https://feedback.azure.com/d365community/</a>  </p></blockquote><div class="alert is-important"><p class="alert-title">重要</p><p><strong>サポートと機能要望の違いについて</strong></p><p>Azure サポートは、現在進行形の問題に対して対処を行い、製品を使い続けられるような支援を行うことに注力しています。Azure などのクラウド製品においては、中・長期的に見た機能改善や追加のご要望、一過性の問題に対しての修正完了までの追跡はサポートでは行っておりません。上記フィードバック サイトでは、製品がより良くなるようなご要望について、その賛同意見や技術的な実現正とメリットを考え、今後の開発ロードマップに活かすべく開発者が直接参照しておりますので、ぜひとも積極的に投稿をお願いいたします。</p><p>なお、このような機能改善へのご要望について、中・長期的ではあっても、お客様にとって Azure を継続利用するにあたって極めて大きな障壁となるようでしたら、プレミア サポートの契約をいただいている場合、担当の CSAM (カスタマー サクセス アカウント マネージャー) までご連絡をお願いします。</p></div><p>以上が Azure サポートを効果的にご利用いただくためのお問い合わせ方法、および流れとなります。  </p><p>なお、お問い合わせをされるお客様には様々なご要望があり、また様々なご事情を抱えていらっしゃると拝察しております。<br>「すぐに電話が欲しい」、「電話は絶対にして欲しくない」、「メールはテキストが良い」、「いや HTML で図が入っていた方が読みやすい」などなど、日々対応させて頂いているなかで、頂戴するご要望は多岐に渡り、正反対のものもございます。</p><p>私たち Azure サポートでは、まずお客様と対話させて頂くことが必要であり、Q を入れたら A が出てくるような機械的なサポートではなく、ご要望をお聞きして、それに寄り添ったご支援を差し上げられればと考えています。<br>もし、上記にうまくあてはめられないようなご要望やお悩みがございましたら、まずは一件お問合せをお送りいただき、その中でお気兼ねなく担当サポートエンジニアまでご相談ください。  </p><p>Azure をサポートサービスの質でお選び頂けるよう、チーム一同努めてまいりますので、これからも、弊社 Azure サービスならびに Azure サポートをご愛顧賜りますと幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;私たちは、Azure をご利用いただいているお客様に、Azure を正常かつ快適にご利用いただくためのご支援を差し上げています。&lt;br&gt;この度、Azure サポートを効果的に利用するやり方について知りたい、というご要望を頂戴しましたので、以下にサポートへのお問い合わせ方法をご案内させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>Linux の 時刻同期設定について</title>
    <link href="https://jpaztech.github.io/blog/vm/linux-time-sync/"/>
    <id>https://jpaztech.github.io/blog/vm/linux-time-sync/</id>
    <published>2022-02-25T07:30:00.000Z</published>
    <updated>2022-12-22T05:56:35.375Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの橋本です。</p><p>本記事では　Azure 環境下での Linux OS での時刻同期に関してご紹介します。<br>公式ドキュメントのみではわかりづらい部分があるかと思いますので、<br>よくご質問いただく内容を踏まえ、本記事で設定方法や、デフォルトの状態に関しての<br>情報を纏めてご紹介させていただければと考えております。<br>時刻同期の設計、環境構築などで今回の情報が皆様のお役に立てれば幸いです。</p><h2 id="関連ドキュメント"><a href="#関連ドキュメント" class="headerlink" title="関連ドキュメント"></a>関連ドキュメント</h2><p>公式ドキュメント上では以下の URL 情報にご案内があります。</p><blockquote><p><strong>Azure での Linux VM の時刻同期</strong><br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/time-sync">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/time-sync</a></p></blockquote><h2 id="ご案内の概要"><a href="#ご案内の概要" class="headerlink" title="ご案内の概要"></a>ご案内の概要</h2><p>本記事では以下の情報をご紹介します。</p><ol><li>デフォルトの時刻同期設定について</li><li>Azure 時刻同期サーバー、サービスの有無</li><li>PTP を利用した Azure ホストとの時刻同期</li></ol><h2 id="1-デフォルトの時刻同期設定について"><a href="#1-デフォルトの時刻同期設定について" class="headerlink" title="1. デフォルトの時刻同期設定について"></a>1. デフォルトの時刻同期設定について</h2><p>デフォルトの時刻同期設定は、ご利用のイメージによって異なり、一律の設定となっているわけではありません。<br>基本的には以下のいずれかの設定となっています。</p><ul><li>時刻同期サービスが未構成</li><li>NTP を利用した外部 NTP サーバーとの時刻同期が構成されている<br>(OS イメージ提供元にて提供されている NTP サーバーが指定されている)</li><li>PTP を利用した Azure ホストとの時刻同期が構成されている</li></ul><h2 id="2-Azure-時刻同期サーバー、時刻同期サービスの有無"><a href="#2-Azure-時刻同期サーバー、時刻同期サービスの有無" class="headerlink" title="2. Azure 時刻同期サーバー、時刻同期サービスの有無"></a>2. Azure 時刻同期サーバー、時刻同期サービスの有無</h2><p>時刻同期のプロトコルとしてよくご利用されている NTP サーバーについては、<br>お客様向けに Azure サービスとしてご用意はありません。</p><p>NTP をご利用いただくことについて制限などはありませんが、ご利用される場合には、外部の NTP サーバーをご指定いただく必要があります。</p><p>なお、Azure 上の Windows 仮想マシンの既定値に定義されている time.windows.com ですが、こちらはインターネット上のパブリックな NTP サーバーであり、Azure サービスとして提供しているものではなく、動作サポートをしているものではありませんのでご注意ください。</p><p>時刻同期のための Azure サービスとしては、 Azure ホストと同期する PTP を提供しています。<br>Azure Marketplace の最新の Linux イメージでは徐々に仮想マシンの時刻同期として PTP を利用するように変更されており、仮想マシンを作成した初期状態ですでに Azure ホストと同期されるように構成されているものもあります。</p><p>Azure ホスト自体は内部で Microsoft のタイムサーバーと同期しており、GPS アンテナを使用して、Microsoft が所有する Stratum 1 デバイスから時刻を取得しています。</p><h2 id="3-PTP-を利用した-Azure-ホストとの時刻同期"><a href="#3-PTP-を利用した-Azure-ホストとの時刻同期" class="headerlink" title="3. PTP を利用した Azure ホストとの時刻同期"></a>3. PTP を利用した Azure ホストとの時刻同期</h2><p>Azure ホストとの時刻同期を行う際の手順についてご紹介します。<br>以下の例では SUSE 環境での検証結果を前提として記載させていただきますが、パッケージインストールコマンド以外は基本的どのディストリビューションでも流れとしては同じとなります。</p><ol><li><p>NTP など他の時刻同期のサービスが起動している場合は停止</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo su –</span><br><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">systemctl stop ntp</span><br><span class="line">systemctl <span class="built_in">disable</span> ntp</span><br><span class="line">systemctl status ntp</span><br></pre></td></tr></table></figure></li><li><p>chrony をインストール</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">zypper install chrony</span><br></pre></td></tr></table></figure></li><li><p>インストールされた chrony パッケージが表示されることを確認</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">rpm -qa | grep chrony</span><br></pre></td></tr></table></figure></li><li><p>lsmod コマンドを実行し、hv_utils が表示結果に存在するか確認</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">lsmod | grep hv_utils</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果の例</span></span><br><span class="line">hv_utils               32768  1 </span><br><span class="line">ptp                    20480  1 hv_utils</span><br><span class="line">hv_vmbus              106496  7 hv_storvsc,hv_utils,hid_hyperv,hv_balloon,hv_netvsc,hyperv_keyboard,hyperv_fb</span><br></pre></td></tr></table></figure></li><li><p>PTP クロックソースを確認<br>高速ネットワークの利用有無など、環境によって出力結果が異なるため、後続の手順で正しいデバイス ファイルを選択するように hyperv の ptp クロックソースの情報を確認します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">ls /dev/ptp*</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果の例</span></span><br><span class="line">ptp0 ptp1 ptp_hyperv</span><br></pre></td></tr></table></figure><p><strong>ptp_hyperv ファイルが存在する場合</strong><br>→　手順 6 にて /dev/ptp_hyperv を指定します。</p><p><strong>ptp0 のみが表示された場合</strong><br>→　手順 6  にて /dev/ptp0 を指定します。</p><p><strong>ptp0 と ptp1 ファイルのみが存在する場合</strong><br>→　この場合 udev ルールファイルを作成する方法がございますが、詳細につきましてはサポートにお問合せください。</p></li></ol><ol start="6"><li><p>chrony を利用しPTP クロックソースを利用した時刻同期を構成<br>以下の例は手順 5 の確認の結果、ptp0 が正しい PTP クロックソースと確認できた場合の設定となります。<br>手順 5 の確認の結果、ptp_hyperv が正しい PTP クロックソースの場合、差し替えて設定をお願いします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">vi /etc/chrony.conf</span><br></pre></td></tr></table></figure><p>ファイル末尾に以下行を追加</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">refclock PHC /dev/ptp0 poll 3 dpoll -2 offset 0</span><br></pre></td></tr></table></figure></li><li><p>chrony を起動し、さらにシステム起動時に自動実行</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">systemctl start chronyd</span><br><span class="line">systemctl <span class="built_in">enable</span> chronyd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果の例</span></span><br><span class="line">Created symlink from /etc/systemd/system/multi-user.target.wants/chronyd.service to /usr/lib/systemd/system/chronyd.service.</span><br></pre></td></tr></table></figure></li><li><p>chrony による時刻同期状況を確認する ※PHC0 が存在すること</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限にて実施</span></span><br><span class="line">chronyc sources</span><br><span class="line"></span><br><span class="line"><span class="comment"># 実行結果の例</span></span><br><span class="line">210 Number of sources = 1</span><br><span class="line">MS Name/IP address         Stratum Poll Reach LastRx Last sample</span><br><span class="line">===============================================================================</span><br><span class="line"><span class="comment">#* PHC0                          0   3   377     3  +2401ns[+5304ns] +/- 2032ns</span></span><br></pre></td></tr></table></figure></li></ol><p>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの橋本です。&lt;/p&gt;
&lt;p&gt;本記事では　Azure 環境下での Linux OS での時刻同期に関してご紹介します。&lt;br&gt;公式ドキュメントのみではわかりづらい部分があるかと思いますので、&lt;br&gt;よくご質問いただく内容を踏</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>復旧 VM を使った Linux VM の Noboot 復旧手順</title>
    <link href="https://jpaztech.github.io/blog/vm/linux-noboot-recovery-managed-disk/"/>
    <id>https://jpaztech.github.io/blog/vm/linux-noboot-recovery-managed-disk/</id>
    <published>2022-02-17T09:30:00.000Z</published>
    <updated>2022-12-22T05:56:35.371Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの橋本です。</p><p>Linux OS にて設定変更後、または新たにアプリケーションなどをインストールした後で OS が起動しなくなり困ったことはないでしょうか。<br>今回は OS 設定変更後に正常に起動せず、ログインができなくなってしまったケースを想定し、問題の OS ディスクのクローンを作成し、復旧作業用の別の VM (以降復旧 VM) にて OS ディスクの修正対応をする方法をご案内させていただきます。</p><span id="more"></span> <h2 id="関連ドキュメント"><a href="#関連ドキュメント" class="headerlink" title="関連ドキュメント"></a>関連ドキュメント</h2><p>公式ドキュメント上では以下の URL 情報にご案内があります。</p><blockquote><p><strong>Azure Virtual Machine の修復コマンドを使用して Linux VM を修復する</strong><br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/repair-linux-vm-using-azure-virtual-machine-repair-commands">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/repair-linux-vm-using-azure-virtual-machine-repair-commands</a></p><p><strong>Linux レスキュー VM の Chroot 環境</strong><br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/chroot-environment-linux">https://docs.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/chroot-environment-linux</a></p></blockquote><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>本記事では、VM (testvm) (リソースグループ rg-test) の /etc/fstab 修正、rpm パッケージのアプリケーション インストールを行った後で　VM が起動できなくなったことを想定し、復旧手順について上記 2 つの公式ドキュメント記載内容を纏めた形で一連の流れをご紹介します。<br>また、復旧のために利用した復旧 VM 関連のリソースを、作業後に削除する方法も併せてご紹介します。</p><h2 id="作業概要"><a href="#作業概要" class="headerlink" title="作業概要"></a>作業概要</h2><ol><li>Azure CLI にて問題の VM を指定し、復旧 VM を作成</li><li>復旧 VM にて、問題の VM の OS ディスクをマウント</li><li>復旧 VM にて、修復操作を実施</li><li>復旧 VM で修正した OS ディスクのコピーを、問題の VM の OS ディスクとスワップ</li><li>不要となった復旧 VM のリソースグループを削除</li></ol><h2 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h2><h3 id="1-Azure-CLI-にて問題の-VM-を指定し、復旧-VM-を作成"><a href="#1-Azure-CLI-にて問題の-VM-を指定し、復旧-VM-を作成" class="headerlink" title="1. Azure CLI にて問題の VM を指定し、復旧 VM を作成"></a>1. Azure CLI にて問題の VM を指定し、復旧 VM を作成</h3><ul><li><p>Azure 環境へログイン</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az login</span><br></pre></td></tr></table></figure></li><li><p>復旧 VM 作成コマンドを実行<br>このコマンドを実行し、問題の VM の OS ディスクのコピー (自動で作成されます) をデータ ディスクとしてマウントした復旧 VM を作成します。復旧 VM は元の仮想マシンと同一サイズで作成され、通常の仮想マシンと同様にコストが掛かります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm repair create -g rg-test -n testvm</span><br></pre></td></tr></table></figure><p>下記のように実行結果が表示されるため、復旧 VM のログイン アカウントおよびパスワードを入力します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 省略 #</span></span><br><span class="line">The vm-repair extension is not up to date, please update with az extension update -n vm-repair</span><br><span class="line">Repair VM admin username:  <span class="comment"># 復旧 VM のログイン アカウントを入力</span></span><br><span class="line">Repair VM admin password:  <span class="comment"># 復旧 VM のログイン パスワードを入力</span></span><br><span class="line">Confirm Repair VM admin password:  <span class="comment"># パスワードを再入力</span></span><br><span class="line"><span class="comment"># 省略 #</span></span><br><span class="line">  <span class="string">&quot;repair_resource_group&quot;</span>: <span class="string">&quot;repair-testvm-20211127104931.115258&quot;</span>,</span><br><span class="line">  <span class="string">&quot;repair_vm_name&quot;</span>: <span class="string">&quot;repair-testvm_&quot;</span>,</span><br><span class="line">  <span class="string">&quot;resource_tag&quot;</span>: <span class="string">&quot;repair_source=rg-test/testvm&quot;</span>,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;SUCCESS&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-復旧-VM-にて、問題の-VM-の-OS-ディスクをマウント"><a href="#2-復旧-VM-にて、問題の-VM-の-OS-ディスクをマウント" class="headerlink" title="2. 復旧 VM にて、問題の VM の OS ディスクをマウント"></a>2. 復旧 VM にて、問題の VM の OS ディスクをマウント</h3><ul><li><p>Azure ポータルから復旧 VM “repair-testrh0_” の パブリック IP アドレスを確認</p><p><img src="/blog/vm/linux-noboot-recovery-managed-disk/01.png"></p></li><li><p>上記確認したパブリック IP アドレス、手順 1 で作成したユーザ、パスワードで SSH ログインし、VM (testvm) のディスクをマウントし、chroot コマンドを実行します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo su - </span><br><span class="line"></span><br><span class="line"><span class="comment"># root 権限で実行</span></span><br><span class="line">lsblk</span><br></pre></td></tr></table></figure><p>コマンド表示結果例<br><img src="/blog/vm/linux-noboot-recovery-managed-disk/02.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限で実行</span></span><br><span class="line">lsblk -f</span><br></pre></td></tr></table></figure><p>コマンド実行例<br><img src="/blog/vm/linux-noboot-recovery-managed-disk/03.png"></p><p>lsblk コマンドでは、復旧 VM に接続されたデータ ディスクのパーティション構成を確認します。<br>パーティション構成はお客様環境に依存するため、必ずしも今回の例と同じとは限りません。<br>今回の例では論理ボリューム名より各ファイルシステム判断し、sdc1 が 500M であることから /boot 、sdc15 が vfat であることから /boot/efi と判断しマウントをします。</p></li><li><p>各ファイル システムのマウント<br>本手順例では LVM 構成を前提とした手順となります。<br>非 LVM 構成の場合にも基本的な操作は同じとなりますが、ご不明な場合、公式ドキュメントに 非 LVM 構成を前提とした手順がございますので、ご参考にしていただければと思います。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限で実行</span></span><br><span class="line">mkdir /rescue</span><br><span class="line">mount /dev/mapper/rootvg-rootlv /rescue</span><br><span class="line">mount /dev/mapper/rootvg-varlv /rescue/var</span><br><span class="line">mount /dev/mapper/rootvg-homelv /rescue/home</span><br><span class="line">mount /dev/mapper/rootvg-usrlv /rescue/usr</span><br><span class="line">mount /dev/mapper/rootvg-tmplv /rescue/tmp</span><br><span class="line">mount /dev/sdc1 /rescue/boot/</span><br><span class="line">mount /dev/sdc15 /rescue/boot/efi</span><br><span class="line"><span class="built_in">cd</span> /rescue</span><br><span class="line">mount -t proc proc proc</span><br><span class="line">mount -t sysfs sys sys/</span><br><span class="line">mount -o <span class="built_in">bind</span> /dev dev/</span><br><span class="line">mount -o <span class="built_in">bind</span> /dev/pts dev/pts/</span><br><span class="line">mount -o <span class="built_in">bind</span> /run run/</span><br><span class="line">chroot /rescue</span><br></pre></td></tr></table></figure><p>※ chroot コマンド実行後プロンプトに [] が付与されます。<br><img src="/blog/vm/linux-noboot-recovery-managed-disk/04.png"></p></li></ul><h3 id="3-復旧-VM-にて、修復操作を実施"><a href="#3-復旧-VM-にて、修復操作を実施" class="headerlink" title="3.　復旧 VM にて、修復操作を実施"></a>3.　復旧 VM にて、修復操作を実施</h3><ul><li><p>手順 2 で /rescue ディレクトリにマウントした VM (testvm) の root ファイル システムにアクセスし、修正対応を行います。<br>ここでは例としまして /etc/fstab を修正し、直前にインストールしたパッケージをアンインストールします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ルートディレクトリ変更後の状態で実行</span></span><br><span class="line"><span class="built_in">cd</span> /etc</span><br><span class="line">vi fstab</span><br><span class="line"></span><br><span class="line">rpm --erase アプリケーションパッケージ</span><br><span class="line"><span class="comment"># Running in chroot, ignoring request: daemon-reload</span></span><br><span class="line"><span class="comment"># こちらのメッセージが出力される可能性がございますが、無視いただいて問題ありません。</span></span><br></pre></td></tr></table></figure></li><li><p>作業完了後、chroot から抜けて、ファイル システムをすべてアンマウントします。<br>その後ポータルから復旧 VM を停止します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ルートディレクトリ変更後の状態で実行</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><p>※ exit コマンド実行後プロンプトから [] が外れます<br><img src="/blog/vm/linux-noboot-recovery-managed-disk/05.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root 権限で実行</span></span><br><span class="line">umount /rescue/proc/</span><br><span class="line">umount /rescue/sys/</span><br><span class="line">umount /rescue/dev/pts</span><br><span class="line">umount /rescue/dev/</span><br><span class="line">umount /rescue/run</span><br><span class="line"><span class="built_in">cd</span> /</span><br><span class="line">umount /rescue/boot/efi</span><br><span class="line">umount /rescue/boot</span><br><span class="line">umount /rescue/home</span><br><span class="line">umount /rescue/var</span><br><span class="line">umount /rescue/usr</span><br><span class="line">umount /rescue/tmp</span><br><span class="line">umount /rescue</span><br></pre></td></tr></table></figure><p>※ ファイルシステムがプロセス利用中のためアンマウントできない場合がありますが、後続の復旧 VM のシャットダウン操作でアンマウントされますので問題ありません。</p></li><li><p>Azure ポータルから復旧 VM “repair-testrh0_” を停止<br><img src="/blog/vm/linux-noboot-recovery-managed-disk/06.png"></p></li></ul><h3 id="4-復旧-VM-で修正した-OS-ディスクのコピーを、問題の-VM-の-OS-ディスクとスワップ"><a href="#4-復旧-VM-で修正した-OS-ディスクのコピーを、問題の-VM-の-OS-ディスクとスワップ" class="headerlink" title="4. 復旧 VM で修正した OS ディスクのコピーを、問題の VM の OS ディスクとスワップ"></a>4. 復旧 VM で修正した OS ディスクのコピーを、問題の VM の OS ディスクとスワップ</h3><ul><li><p>“az vm repair restore” コマンドにて、問題の VM の OS ディスクを、修復した OS ディスクとスワップします。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">az vm repair restore -g rg-test -n testvm --verbose</span><br><span class="line"><span class="comment"># 省略 #</span></span><br><span class="line">Continue with clean-up and delete resources? (y/n): n ※復旧 VM 作成時に作成されたリソースを削除するかの選択。</span><br><span class="line">今回ご紹介の手順では n を選択し、後続の手順にて関連リソースを削除します。</span><br><span class="line">y を選択いただいても問題ありません。</span><br></pre></td></tr></table></figure><p>コマンドが完了すると、復旧 VM にアタッチされていたディスクが自動的に問題の仮想マシンの OS ディスクとしてアタッチされます。</p></li><li><p>問題の VM をポータルから起動し、ログインができるか確認</p></li></ul><h3 id="5-不要となった復旧-VM-のリソースグループを削除"><a href="#5-不要となった復旧-VM-のリソースグループを削除" class="headerlink" title="5. 不要となった復旧 VM のリソースグループを削除"></a>5. 不要となった復旧 VM のリソースグループを削除</h3><p>ポータル上からリソース グループ内のリソースを確認した後で削除する流れをご紹介します。</p><ul><li><p>復旧 VM のリソース グループ削除<br>ポータルのリソース グループのメニューより、<br>「repair-tesetvg-yyyymmdd・・・」の名称のリソース グループを選択。リソースグループ内のリソースが業務で利用していないことを確認して削除します。</p><p><img src="/blog/vm/linux-noboot-recovery-managed-disk/10.png"></p></li></ul><ul><li><p>問題の VM の元ディスクの削除</p><p>管理ディスク環境と非管理ディスク環境で手順が異なります。<br>【管理ディスクをご利用環境の場合】、【非管理ディスクをご利用環境の場合】<br>手順をそれぞれ用意しておりますので、環境に合わせてご対応ください。</p><p>【管理ディスクをご利用環境の場合】</p><p>VM のリソースグループより、元々利用していたディスクを選択し、<br>ディスクの状態が　Unattached（どの VM からも利用されていない）であることを確認し、削除を行います。</p><p><img src="/blog/vm/linux-noboot-recovery-managed-disk/11.png"><br><img src="/blog/vm/linux-noboot-recovery-managed-disk/12.png"></p><p>【非管理ディスクをご利用環境の場合】</p><p>VM のディスク情報より、現在 VM が利用している vhd ファイルを確認し、<br>仮想マシンの vhd ファイルが格納されているストレージアカウントのコンテナーをご確認ください。<br>現在 VM が利用していない VHD ファイル、<br>尚且つディスクの状態が利用可能（どの VM からも利用されていない）であることを確認し、削除を行います。</p><p><img src="/blog/vm/linux-noboot-recovery-managed-disk/13.png"><br><img src="/blog/vm/linux-noboot-recovery-managed-disk/14.png"></p></li></ul><p>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの橋本です。&lt;/p&gt;
&lt;p&gt;Linux OS にて設定変更後、または新たにアプリケーションなどをインストールした後で OS が起動しなくなり困ったことはないでしょうか。&lt;br&gt;今回は OS 設定変更後に正常に起動せず、ログインができなくなってしまったケースを想定し、問題の OS ディスクのクローンを作成し、復旧作業用の別の VM (以降復旧 VM) にて OS ディスクの修正対応をする方法をご案内させていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Noboot" scheme="https://jpaztech.github.io/blog/tags/Noboot/"/>
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>yum/dnf update に失敗する場合の原因と解決方法</title>
    <link href="https://jpaztech.github.io/blog/vm/rhui-yum-update/"/>
    <id>https://jpaztech.github.io/blog/vm/rhui-yum-update/</id>
    <published>2022-02-14T02:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.403Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは！Azure テクニカル サポート チームの高橋です。<br>今回はよく、お問い合わせを頂く<br>Azure Marketplace から作成した Red Hat Enterprise Linux (RHEL) の仮想マシンにおいて<br>yum / dnf update やパッケージのインストールに失敗する場合の<br>よくある原因とその解決方法についてご紹介いたします。</p><span id="more"></span><hr><h2 id="Azure-RHUI-リポジトリ-とは？"><a href="#Azure-RHUI-リポジトリ-とは？" class="headerlink" title="Azure RHUI (リポジトリ) とは？"></a>Azure RHUI (リポジトリ) とは？</h2><p>Azure RHUI  (Red Hat Update Infrastructure) は、Azure Marketplace にある<br>Red Hat Enterprise Linux (RHEL) の従量課金 (PAYG) イメージから作成した VM を更新するために<br>提供されているリポジトリサーバーです。</p><p>Azure Marketplace から 作成した RHEL VM は、規定で Azure RHUI へのアクセスする構成が設定されているため<br>追加の設定は不要となります。</p><p>VM から、Azure RHUI にアクセスするためには、下記の IP アドレスに対する送信規則の 443 ポートの通信許可を設定する必要があります。<br>Azure RHUI の IP アドレスは下記公開ドキュメントにおまとめしておりますのでご確認ください。</p><blockquote><p> □ 参考 : RHUI コンテンツ配信サーバーの IP アドレス<br>   <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui#the-ips-for-the-rhui-content-delivery-servers">https://docs.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui#the-ips-for-the-rhui-content-delivery-servers</a></p></blockquote><div class="alert is-important"><p class="alert-title">重要</p><p>※Azure RHUI へのアクセスは、弊社バックボーンネットワーク経由にて接続されており、</p><p>Azure VM から、オンプレミスのネットワークインフラストラクチャや、プロキシ、NVA (仮想アプライアンス) 経由でのアクセスはサポートされておらず、</p><p>Azure VM から直接、Azure RHUI に接続する必要がある点に注意してください。</p></div><hr><h2 id="Azure-RHUI-への接続確認"><a href="#Azure-RHUI-への接続確認" class="headerlink" title="Azure RHUI への接続確認"></a>Azure RHUI への接続確認</h2><p>yum / dnf update やパッケージのインストールに失敗する場合、<br>Azure RHUI への接続ができていない可能性がございます。<br>Azure VM 内から、curl コマンド等を使うことで、Azure RHUI への接続状況を確認することができます。<br>下記のコマンドをお試しください。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># curl -v https://rhui-1.microsoft.com:443</span></span><br><span class="line"><span class="comment"># curl -v https://rhui-2.microsoft.com:443</span></span><br><span class="line"><span class="comment"># curl -v https://rhui-3.microsoft.com:443</span></span><br></pre></td></tr></table></figure><p>&lt; 実行結果例 (成功時) &gt;</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">[root@rheltest ~]<span class="comment"># curl -v https://rhui-1.microsoft.com:443</span></span><br><span class="line">* Rebuilt URL to: https://rhui-1.microsoft.com:443/</span><br><span class="line">*   Trying 52.187.75.218...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* Connected to rhui-1.microsoft.com (52.187.75.218) port 443 (<span class="comment">#0)</span></span><br><span class="line">* ALPN, offering h2</span><br><span class="line">* ALPN, offering http/1.1</span><br><span class="line">* successfully <span class="built_in">set</span> certificate verify locations:</span><br><span class="line">*   CAfile: /etc/pki/tls/certs/ca-bundle.crt</span><br><span class="line">CApath: none</span><br><span class="line">* TLSv1.3 (OUT), TLS handshake, Client hello (1):</span><br><span class="line">* TLSv1.3 (IN), TLS handshake, Server hello (2):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Certificate (11):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Server key exchange (12):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Server finished (14):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Client key exchange (16):</span><br><span class="line">* TLSv1.2 (OUT), TLS change cipher, Change cipher spec (1):</span><br><span class="line">* TLSv1.2 (OUT), TLS handshake, Finished (20):</span><br><span class="line">* TLSv1.2 (IN), TLS handshake, Finished (20):</span><br><span class="line">* SSL connection using TLSv1.2 / ECDHE-RSA-AES256-GCM-SHA384</span><br><span class="line">* ALPN, server did not agree to a protocol</span><br><span class="line">* Server certificate:</span><br><span class="line">*  subject: C=US; ST=WA; L=Redmond; O=Microsoft Corporation; CN=rhui-1.microsoft.com</span><br><span class="line">*  start date: Dec  7 11:14:49 2021 GMT</span><br><span class="line">*  expire date: Dec  2 11:14:49 2022 GMT</span><br><span class="line">*  subjectAltName: host <span class="string">&quot;rhui-1.microsoft.com&quot;</span> matched cert<span class="string">&#x27;s &quot;rhui-1.microsoft.com&quot;</span></span><br><span class="line"><span class="string">*  issuer: C=US; O=Microsoft Corporation; CN=Microsoft Azure TLS Issuing CA 01</span></span><br><span class="line"><span class="string">*  SSL certificate verify ok.</span></span><br><span class="line"><span class="string">&gt; GET / HTTP/1.1</span></span><br><span class="line"><span class="string">&gt; Host: rhui-1.microsoft.com</span></span><br><span class="line"><span class="string">&gt; User-Agent: curl/7.61.1</span></span><br><span class="line"><span class="string">&gt; Accept: */*</span></span><br><span class="line"><span class="string">&gt;</span></span><br><span class="line"><span class="string">&lt; HTTP/1.1 200 OK</span></span><br><span class="line"><span class="string">&lt; Date: Mon, 24 Jan 2022 06:51:00 GMT</span></span><br><span class="line"><span class="string">&lt; Server: Apache/2.4.6 (Red Hat Enterprise Linux)</span></span><br><span class="line"><span class="string">&lt; X-Served-By: southeastasia-cds0</span></span><br><span class="line"><span class="string">&lt; X-Content-Type-Options: nosniff</span></span><br><span class="line"><span class="string">&lt; Last-Modified: Thu, 20 Jun 2019 06:37:48 GMT</span></span><br><span class="line"><span class="string">&lt; ETag: &quot;0-58bbb9592306b&quot;</span></span><br><span class="line"><span class="string">&lt; Accept-Ranges: bytes</span></span><br><span class="line"><span class="string">&lt; Content-Length: 0</span></span><br><span class="line"><span class="string">&lt; Connection: close</span></span><br><span class="line"><span class="string">&lt; Content-Type: text/html</span></span><br><span class="line"><span class="string">&lt;</span></span><br><span class="line"><span class="string">* Closing connection 0</span></span><br><span class="line"><span class="string">* TLSv1.2 (OUT), TLS alert, close notify (256):</span></span><br></pre></td></tr></table></figure><p>&lt; 実行結果例 (失敗時) &gt; </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@rhelvm ~]<span class="comment"># curl -v https://rhui-1.microsoft.com:443</span></span><br><span class="line">* Rebuilt URL to: https://rhui-1.microsoft.com:443/</span><br><span class="line">*   Trying 52.187.75.218...</span><br><span class="line">* TCP_NODELAY <span class="built_in">set</span></span><br><span class="line">* connect to 52.187.75.218 port 443 failed: Connection timed out</span><br><span class="line">* Failed to connect to rhui-1.microsoft.com port 443: Connection timed out</span><br><span class="line">* Closing connection 0</span><br><span class="line">curl: (7) Failed to connect to rhui-1.microsoft.com port 443: Connection timed out</span><br></pre></td></tr></table></figure><p>Azure RHUI への接続確認が失敗する場合には、NSG やプロキシ等のネットワーク設定を確認する必要がございます。<br>よくお問い合わせを頂くエラー原因と解決方法は、以下のようになります。</p><hr><h2 id="エラーの原因その-1-Azure-RHUI-への接続ができない-NSG"><a href="#エラーの原因その-1-Azure-RHUI-への接続ができない-NSG" class="headerlink" title="エラーの原因その 1 : Azure RHUI への接続ができない (NSG)"></a>エラーの原因その 1 : Azure RHUI への接続ができない (NSG)</h2><p>セキュリティ上の理由から、Network Security Group (NSG) を利用して、<br>Azure VM からインターネットへのアクセスを制限を設定している場合がございます。<br>Azure portal から対象の仮想マシンを選択後、[ネットワーク] から確認することができます。<br>下記画像の例では、送信ポートの規則で、インターネットへの接続を拒否しています。</p><p><img src="/blog/vm/rhui-yum-update/01.png"></p><p>本設定がある場合には、Azure RHUI への接続確認は、失敗することが想定され、<br>yum update を実施した際や、パッケージのインストール時にはタイムアウトエラーが発生します。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@rhelvm ~]<span class="comment"># yum update</span></span><br><span class="line">Red Hat Enterprise Linux 8 <span class="keyword">for</span> x86_64 - BaseOS - Extended Update Support from RHUI (RPMs)                                                              0.0  B/s |   0  B     01:30</span><br><span class="line">Failed to download metadata <span class="keyword">for</span> repo <span class="string">&#x27;rhel-8-for-x86_64-baseos-eus-rhui-rpms&#x27;</span></span><br><span class="line">Error: Failed to download metadata <span class="keyword">for</span> repo <span class="string">&#x27;rhel-8-for-x86_64-baseos-eus-rhui-rpms&#x27;</span></span><br></pre></td></tr></table></figure><p><img src="/blog/vm/rhui-yum-update/02.png"></p><p>この場合の解決方法としては、Azure RHUI へアクセスできるように、<br>Azure RHUI サーバーの IP アドレスに対する送信規則の 443 ポートの通信許可を設定する必要があります。<br>下記画像の通り、”送信セキュリティ規則の追加” から、通信許可の設定を追加する必要があります。<br>また、優先度は、DenyInternet (インターネットへの制限規則) より高くする必要がある点にご注意ください。</p><p><img src="/blog/vm/rhui-yum-update/03.png"></p><hr><h2 id="エラーの原因その-2-Azure-RHUI-への接続ができない-Proxy-等"><a href="#エラーの原因その-2-Azure-RHUI-への接続ができない-Proxy-等" class="headerlink" title="エラーの原因その 2 : Azure RHUI への接続ができない (Proxy 等)"></a>エラーの原因その 2 : Azure RHUI への接続ができない (Proxy 等)</h2><p>Azure VM から、オンプレミスのネットワークインフラストラクチャや、プロキシ、NVA (仮想アプライアンス) 経由での Azure RHUI へのアクセスはサポートされていないため、<br>Azure VM から直接、Azure RHUI に接続する必要があります。</p><p>この場合の解決方法としては、Azure VM が Azure RHUI の IP アドレスに直接接続できるようユーザー定義のルートテーブル UDR (User Defined Route) を作成する必要があります。<br>下記画像のように、RHUI コンテンツ配信サーバーの IP アドレス全てに対して、<br>次ホップ (Next hops) の種類に “Internet” を指定した UDR を作成頂く必要があります。</p><p><img src="/blog/vm/rhui-yum-update/04.png"></p><p>Azure VM のルートテーブルの作成手順については、下記公開ドキュメントをご確認ください。</p><blockquote><p>  □ 参考 : ルート テーブルの作成、変更、削除 | ルートの作成<br>   <a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/manage-route-table#create-a-route-table">https://docs.microsoft.com/ja-jp/azure/virtual-network/manage-route-table#create-a-route-table</a></p></blockquote><div class="alert is-success"><p class="alert-title">ヒント</p><p>※プロキシの設定を実施している場合は、/etc/yum.conf 内の “proxy=” のプロキシ設定がないかご確認ください。</p><p>  プロキシ設定があった場合、コメントアウト等で無効にしてください。</p></div><hr><h2 id="エラーの原因その-3-クライアント証明書の期限切れ"><a href="#エラーの原因その-3-クライアント証明書の期限切れ" class="headerlink" title="エラーの原因その 3 : クライアント証明書の期限切れ"></a>エラーの原因その 3 : クライアント証明書の期限切れ</h2><p>古い RHEL VM イメージを利用している際には、 TLS/SSL クライアント証明書の期限が切れているために、<br>Azure RHUI に接続できない問題が発生することがあります。<br>クライアント証明書の期限が切れた際には、yum update を実施した際に下記のようなエラーが出力されることがあります。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@rhelvm ~]<span class="comment"># yum update</span></span><br><span class="line">Loaded plugins: langpacks, product-id, search-disabled-repos</span><br><span class="line">rhui-microsoft-azure-rhel7-eus                                                                   | 2.1 kB  00:00:00</span><br><span class="line">https://rhui-1.microsoft.com/pulp/repos//content/dist/rhel/rhui/server/7/7Server/x86_64/dotnet/1/os/repodata/repomd.xml: [Errno 14] curl<span class="comment">#58 - &quot;SSL peer rejected your certificate as expired.&quot;</span></span><br><span class="line">Trying other mirror.</span><br><span class="line">https://rhui-2.microsoft.com/pulp/repos//content/dist/rhel/rhui/server/7/7Server/x86_64/dotnet/1/os/repodata/repomd.xml: [Errno 14] curl<span class="comment">#58 - &quot;SSL peer rejected your certificate as expired.&quot;</span></span><br><span class="line">Trying other mirror.</span><br><span class="line">https://rhui-3.microsoft.com/pulp/repos//content/dist/rhel/rhui/server/7/7Server/x86_64/dotnet/1/os/repodata/repomd.xml: [Errno 14] curl<span class="comment">#58 - &quot;SSL peer rejected your certificate as expired.&quot;</span></span><br><span class="line">Trying other mirror.</span><br></pre></td></tr></table></figure><p>この場合の解決方法としては、下記コマンドを実施頂き、<br>クライアント証明書を更新頂くことで、Azure RHUI へのアクセスができるようになることが想定されます。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum update -y --disablerepo=<span class="string">&#x27;*&#x27;</span> --enablerepo=<span class="string">&#x27;*microsoft*&#x27;</span></span><br></pre></td></tr></table></figure><p>※本コマンドは、ruhi の rpm のみを更新するコマンドとなります。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>解消しない場合には、下記コマンドも併せてお試しください</p><p>sudo yum clean all</p><p>sudo yum makecache</p></div><hr><h2 id="補足情報"><a href="#補足情報" class="headerlink" title="補足情報"></a>補足情報</h2><p>今回ご紹介した方法でも、事象が解消しない場合には、<br>yum repolist all コマンドを実行頂き、有効なリポジトリをご確認頂ければと思います。</p><p>カスタムイメージや、ゴールドイメージの BYOS イメージをご利用されている場合には、<br>RHSM や サテライトに接続する必要があります。</p><blockquote><p>□ 参考 : Azure のオンデマンド Red Hat Enterprise Linux VM 用 Red Hat Update Infrastructure<br>   <a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui">https://docs.microsoft.com/ja-jp/azure/virtual-machines/workloads/redhat/redhat-rhui</a></p></blockquote><p>本稿が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは！Azure テクニカル サポート チームの高橋です。&lt;br&gt;今回はよく、お問い合わせを頂く&lt;br&gt;Azure Marketplace から作成した Red Hat Enterprise Linux (RHEL) の仮想マシンにおいて&lt;br&gt;yum / dnf update やパッケージのインストールに失敗する場合の&lt;br&gt;よくある原因とその解決方法についてご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Linux" scheme="https://jpaztech.github.io/blog/tags/Linux/"/>
    
    <category term="RHEL" scheme="https://jpaztech.github.io/blog/tags/RHEL/"/>
    
    <category term="RHUI" scheme="https://jpaztech.github.io/blog/tags/RHUI/"/>
    
  </entry>
  
  <entry>
    <title>強制トンネリング利用時の VPN ゲートウェイの動作変更についてのアナウンス</title>
    <link href="https://jpaztech.github.io/blog/network/vpn-defaultsite-update-2022feb/"/>
    <id>https://jpaztech.github.io/blog/network/vpn-defaultsite-update-2022feb/</id>
    <published>2022-02-02T05:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.115Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>Azure の仮想ネットワーク ゲートウェイ (以下「ゲートウェイ」) を用いたサイト間 VPN 接続について、2022 年 2 月 24 日以降に、強制トンネリングに関する一部の動作の変更が行われることがアナウンスされました。</p><p>影響が生じる可能性のあるお客様には通知がすでに送信されているか、近日中に送信されることが想定されます。しかしながら、通知に含まれる説明は要点のみとなっているため、本記事にてその補足をさせていただきます。</p><span id="more"></span><p><br><br></p><h2 id="本記事の内容"><a href="#本記事の内容" class="headerlink" title="本記事の内容"></a>本記事の内容</h2><p>本記事では、動作変更の影響を受ける条件やその合致確認の方法、動作変更の内容および変更の影響を受けないようにする対処方法ついてまとめております。本記事を参考に影響有無を確認するとともに、影響が想定される場合は 2 月 24 日までにあらかじめ対処を実施いただければと思います。</p><p>前半ではリソース マネージャー モデル（新しいモデル）のための手順、後半ではクラシック モデル（古いモデル）のための手順をおまとめしておりますので、それぞれご利用の環境に合わせて確認ください。</p><p><br><br></p><h2 id="今回の動作変更の背景"><a href="#今回の動作変更の背景" class="headerlink" title="今回の動作変更の背景"></a>今回の動作変更の背景</h2><p>Azure のゲートウェイには、「SKU」と呼ばれるパラメーターがあり、ゲートウェイの性能や冗長構成を指定することができます。ゲートウェイの SKU には、大きくわけて以下の 2 種類があります。</p><ul><li>末尾に AZ がつく SKU: VpnGw1AZ、VpnGw2AZ、VpnGw3AZ、VpnGw4AZ、VpnGw5AZ<br></li><li>末尾に AZ がつかない SKU: VpnGw1、VpnGw2、VpnGw3、VpnGw4、VpnGw5、Basic、Standard、HighPerformance</li></ul><p>AZ がつく SKU とつかない SKU では、冗長性確保のためのデータセンター内部の配置が少し違うのみで、そのほかに機能面での基本的な違いはありません。</p><p>しかし今回、特定の条件下において、AZ がつく SKU と AZ がつかない SKU で強制トンネリングに関する一部の動作 (詳細は後述) に差異があることが判明しました。AZ がつかない SKU を対象に動作変更を行い、AZ がつく SKU の動作を正として動作を揃えるというのが、今回のアナウンスの内容です。</p><p><br><br></p><h2 id="動作変更の内容"><a href="#動作変更の内容" class="headerlink" title="動作変更の内容"></a>動作変更の内容</h2><h3 id="強制トンネリングを実現する-2-種類の方法"><a href="#強制トンネリングを実現する-2-種類の方法" class="headerlink" title="強制トンネリングを実現する 2 種類の方法"></a>強制トンネリングを実現する 2 種類の方法</h3><p>Azure のサイト間 VPN においては、Azure 仮想ネットワークから送信されるすべての通信を、データセンターのバックボーンネットワークではなく、VPN にルーティングする「強制トンネリング」という構成が可能です。サイト間 VPN で強制トンネリングを構成するためには、以下の 2 種類の方法があります。</p><ul><li>方法 1. 対向のルーターと BGP で経路交換を行い、対向のルーターからデフォルト ルート 0.0.0.0/0 (を広報する)</li><li>方法 2. BGP は利用せず、ゲートウェイに DefaultSite の設定を行う</li></ul><h3 id="動作が変更される対象となる方法"><a href="#動作が変更される対象となる方法" class="headerlink" title="動作が変更される対象となる方法"></a>動作が変更される対象となる方法</h3><p>このうち、方法 2 を利用している場合は、SKU によって強制トンネリングのために必要な作業が少し異なります。SKU に AZ がつく場合は、DefaultSite の設定を行うだけで、仮想ネットワーク内の全てのサブネットに対して、デフォルト ルートを VPN に向けるルートが反映されます。</p><p>しかし AZ がつかない場合は、DefaultSite の設定を行うだけでは強制トンネリングのためのルートが適用されません。DefaultSite の設定に加えて、0.0.0.0/0 のネクストホップをゲートウェイにしたユーザー定義ルート (UDR) を各サブネットに適用することで、はじめて強制トンネリングがそのサブネットで有効になります。</p><p>今回の動作変更では、この動作を AZ がつく SKU に合わせます。つまり、DefaultSite の設定がされている環境では、0.0.0.0/0 をゲートウェイに向ける UDR が適用されていなくても、強制トンネリングが有効になります。対象の環境においては、強制トンネリングが現状有効になっていないサブネットで、2 月 24 日以降に突然強制トンネリングが有効になる、ということが起こり得ます。</p><p>※ 方法 1 (BGP) を利用している場合は、今回の動作変更による影響はありません。</p><p><br><br></p><h2 id="動作変更による影響が生じる条件"><a href="#動作変更による影響が生じる条件" class="headerlink" title="動作変更による影響が生じる条件"></a>動作変更による影響が生じる条件</h2><p>以下の 5 つの条件に <strong>すべて</strong> 合致した場合に、今回の動作変更の影響を受けます。</p><ul><li>A. VPN 用の仮想ネットワーク ゲートウェイがある</li><li>B. ゲートウェイの SKU は末尾に AZ がつかないものである</li><li>C. サイト間 VPN を利用している</li><li>D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していない</li><li>E. DefaultSiteの設定がされている</li></ul><p>それぞれの条件についての合致確認の方法は、本記事の末尾にまとめております。</p><p><br><br></p><h2 id="条件にすべて合致した場合の対応"><a href="#条件にすべて合致した場合の対応" class="headerlink" title="条件にすべて合致した場合の対応"></a>条件にすべて合致した場合の対応</h2><p>上記の 5 つの条件に <strong>すべて</strong> 合致した場合、動作変更の影響が生じる可能性があります。つまり、0.0.0.0/0 をゲートウェイに向けるユーザー定義ルートが適用されていなくても、2 月 24 日以降の動作変更によって、強制トンネリングがそのサブネットで有効になります。</p><p>予期せず強制トンネリングが有効になることを防ぐためには、あらかじめ 0.0.0.0/0 のネクストホップをインターネットに向ける UDR を適用することが有効です。2 月 24 日よりも前にこの UDR を適用しておくことで、その UDR が適用されたサブネットでは、動作変更によって強制トンネリングが突然有効になる状況を回避することができます。</p><p>（したがって、現状ですでに 0.0.0.0/0 のネクストホップをインターネットに設定する UDR が適用されているサブネットについては、影響を受けません）</p><h3 id="対応手順の例"><a href="#対応手順の例" class="headerlink" title="対応手順の例"></a>対応手順の例</h3><p>具体的な手順の一例は以下のとおりです。各パラメーターについてはお客様の環境に合わせて確認および決定してください。</p><ol><li><p><b>Azure ポータルを開きます。<br></b><br><a href="https://portal.azure.com/">https://portal.azure.com/</a></p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている場合は、手順 5) までスキップします。</b></p></li><li><p><b>[ルート テーブル] を開き、[+作成] をクリックします。</b></p></li><li><p><b>以下のパラメーターを入力し、[確認および作成] をクリックします。(詳細なパラメーターは環境に合わせてください)</b><br><br>　リソース グループ: 任意<br><br>　リージョン: ルート テーブルの適用対象の仮想ネットワークと合わせる<br><br>　名前: ルート テーブルの任意の名前<br><br>　ゲートウェイのルートを伝達する: Yes</p></li><li><p><b>4) で作成したルート テーブルか、既存のルート テーブルを開きます。</b></p></li><li><p><b>[ルート] メニューをクリックし、[+追加] をクリックします。</b></p></li><li><p><b>以下のパラメーターでルートを追加して [OK] をクリックします。</b><br><br>　ルート名: 任意の名前<br><br>　アドレス プレフィックス: 0.0.0.0/0<br><br>　ネクスト ホップの種類: インターネット<br></p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている状態で作業を行った場合は、これで終了です。</b></p></li><li><p><b>[サブネット] メニューをクリックし、[+関連付け] をクリックします。</b></p></li><li><p><b>ルート テーブルの適用対象の仮想ネットワークとサブネットを選択して、[OK] をクリックします。</b></p></li></ol><p>※ ルート テーブルの設定手順は <a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/manage-route-table">公開資料</a> でも説明されておりますので、あわせてご覧ください。</p><p><br>　<br>　<br></p><h2 id="条件に合致しているかどうかを確認するための詳細手順"><a href="#条件に合致しているかどうかを確認するための詳細手順" class="headerlink" title="条件に合致しているかどうかを確認するための詳細手順"></a>条件に合致しているかどうかを確認するための詳細手順</h2><p>A～E それぞれの条件について、合致しているかどうかを確認するための手順の一例をご紹介いたします。</p><h3 id="A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認"><a href="#A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認" class="headerlink" title="A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認"></a>A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認</h3><p>Azure ポータルで [仮想ネットワーク ゲートウェイ] メニューを開き、[ゲートウェイの種類] が [Vpn] のものがあれば、この条件に合致しています。</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-a01.png" alt="画面イメージ"></p><h3 id="B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認"><a href="#B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認" class="headerlink" title="B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認"></a>B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認</h3><p>A. でみつけたゲートウェイをクリックし、[SKU] 欄を確認して「AZ」が含まれていないものであれば、この条件に合致しています。（以下の画像は「AZ」が含まれる場合の例、つまり条件に合致しない例です）</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-b01.png" alt="画面イメージ"></p><h3 id="C-サイト間-VPN-を利用していることの確認"><a href="#C-サイト間-VPN-を利用していることの確認" class="headerlink" title="C. サイト間 VPN を利用していることの確認"></a>C. サイト間 VPN を利用していることの確認</h3><p>A. でみつけたゲートウェイをクリックし、[接続] メニューをクリックします。</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-c01.png" alt="画面イメージ"></p><p>[接続] オブジェクトが表示されれば、この条件に合致しています。</p><p><img src="/blog/network/vpn-defaultsite-update-2022feb/vpn-defaultsite-update-2022feb-c02.png" alt="画面イメージ"></p><h3 id="D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認"><a href="#D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認" class="headerlink" title="D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認"></a>D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認</h3><p>A. でみつけたゲートウェイをクリックし、[BGP ピア] メニューをクリックします。</p><p>[学習したルート] に 0.0.0.0/0 が含まれて <strong>いなければ</strong>、この条件に合致しています。（0.0.0.0/0 が含まれていたら、この条件に合致しませんので今回の変更の影響も受けません。少し紛らわしいのでご注意ください）</p><h3 id="E-DefaultSiteの設定がされていることの確認"><a href="#E-DefaultSiteの設定がされていることの確認" class="headerlink" title="E. DefaultSiteの設定がされていることの確認"></a>E. DefaultSiteの設定がされていることの確認</h3><p>この確認は PowerShell での作業が必要になります。</p><ol><li><p><b>Azure PowerShell を起動するか、<a href="https://shell.azure.com/">Cloud Shell</a> (PowerShell を選択) を開きます。</b></p></li><li><p><b>Azure PowerShell の場合、以下のコマンドを実行してサインインします。</b><br><br>Login-AzAccount</p></li><li><p><b>A. でみつけたゲートウェイが構築されているサブスクリプション ID を確認し、以下のコマンドを実行して操作対象のサブスクリプションを指定します。</b><br><br>Select-AzSubscription -SubscriptionId &lt;確認したサブスクリプション ID&gt;</p></li><li><p><b>以下のコマンドを実行し、対象のゲートウェイの構成情報を取得・表示します。</b><br><br>Get-AzVirtualNetworkGateway -Name &lt;ゲートウェイの名前&gt; -ResourceGroupName &lt;ゲートウェイのリソース グループ名&gt;</p></li><li><p><b>出力結果の中から、GatewayDefaultSite という行を探します。サイト名の情報が入っている場合は、この条件に合致します。「null」となっている場合は合致しません。</b></p></li></ol><br><hr><p><br>　<br>　<br>　<br><br><b>※ 以下は、クラシック デプロイ モデルをご利用の方に向けた手順です。</b><br><br></p><hr><h2 id="クラシックの場合-条件にすべて合致した場合の対応"><a href="#クラシックの場合-条件にすべて合致した場合の対応" class="headerlink" title="(クラシックの場合) 条件にすべて合致した場合の対応"></a>(クラシックの場合) 条件にすべて合致した場合の対応</h2><p>クラシック デプロイ モデルをご利用の場合における具体的な手順の一例は以下のとおりです。各パラメーターについてはお客様の環境に合わせて確認および決定してください。</p><h3 id="事前準備-Azure-PowerShell-の利用"><a href="#事前準備-Azure-PowerShell-の利用" class="headerlink" title="事前準備: Azure PowerShell の利用"></a>事前準備: Azure PowerShell の利用</h3><p>クラシック デプロイ モデルにおける対処のためには、Azure PowerShell をご利用いただくことができます。対処用のコマンドを実行するためには、事前に以下のコマンドを実行する必要があります。</p><ol><li><p><b>以下のコマンドを実行し、サインインします。</b><br><br>Add-AzureAccount</p></li><li><p><b>以下のコマンドを実行し、対象のサブスクリプションを指定します。</b><br><br>Select-AzureSubscription -SubscriptionId &lt;サブスクリプション ID&gt;</p></li></ol><h3 id="対応手順の例-1"><a href="#対応手順の例-1" class="headerlink" title="対応手順の例"></a>対応手順の例</h3><p>具体的な手順の一例は以下のとおりです。各パラメーターについてはお客様の環境に合わせて確認および決定してください。</p><ol><li><p><b>対象のサブネットにすでにルート テーブルが適用されているかどうかを確認します。</b><br><br>Get-AzureSubnetRouteTable -VirtualNetworkName “仮想ネットワーク名” -SubnetName “サブネット名”</p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている場合は、手順 4) までスキップします。</b></p></li><li><p><b>任意の名前でルート テーブルを作成します。</b><br><br>New-AzureRouteTable -Name “ルート テーブルの名前” -Location “リージョン名”</p></li><li><p><b>ルート テーブルに、0.0.0.0/0 のネクストホップを Internet に指定したルートを追加します。</b><br><br>Get-AzureRouteTable -Name “ルート テーブルの名前” | Set-AzureRoute -RouteName “DefaultRoute” -AddressPrefix “0.0.0.0/0” -NextHopType Internet</p></li><li><p><b>すでに対象のサブネットにルート テーブルが適用されている状態で作業を行った場合は、これで終了です。</b></p></li><li><p><b>ルート テーブルをサブネットに適用します。</b><br><br>Set-AzureSubnetRouteTable -VirtualNetworkName “仮想ネットワーク名” -SubnetName “サブネット名” -RouteTableName “ルート テーブルの名前”</p></li></ol><br><hr><br><h2 id="クラシックの場合-条件に合致しているかどうかを確認するための詳細手順"><a href="#クラシックの場合-条件に合致しているかどうかを確認するための詳細手順" class="headerlink" title="(クラシックの場合) 条件に合致しているかどうかを確認するための詳細手順"></a>(クラシックの場合) 条件に合致しているかどうかを確認するための詳細手順</h2><p>クラシック デプロイ モデルをご利用の場合において、A～E それぞれの条件について、合致しているかどうかを確認するための手順の一例をご紹介いたします。</p><h3 id="事前準備-Azure-PowerShell-の利用-1"><a href="#事前準備-Azure-PowerShell-の利用-1" class="headerlink" title="事前準備: Azure PowerShell の利用"></a>事前準備: Azure PowerShell の利用</h3><p>クラシック デプロイ モデルにおける合致確認には、Azure PowerShell をご利用いただくことができます。合致確認用のコマンドを実行するためには、事前に以下のコマンドを実行する必要があります。</p><ol><li><p><b>以下のコマンドを実行し、サインインします。</b><br><br>Add-AzureAccount</p></li><li><p><b>以下のコマンドを実行し、対象のサブスクリプションを指定します。</b><br><br>Select-AzureSubscription -SubscriptionId &lt;確認したサブスクリプション ID&gt;</p></li></ol><h3 id="A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認-1"><a href="#A-VPN-用の仮想ネットワーク-ゲートウェイがあることの確認-1" class="headerlink" title="A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認"></a>A. VPN 用の仮想ネットワーク ゲートウェイがあることの確認</h3><p>(確認不要) 下記 E. の手順に包含されるため、本手順は割愛します。</p><h3 id="B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認-1"><a href="#B-ゲートウェイの-SKU-は末尾に-AZ-がつかないものであることの確認-1" class="headerlink" title="B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認"></a>B. ゲートウェイの SKU は末尾に AZ がつかないものであることの確認</h3><p>(確認不要) クラシックでは、必ず AZ がつかない SKU となりますので、本手順は割愛します。</p><h3 id="C-サイト間-VPN-を利用していることの確認-1"><a href="#C-サイト間-VPN-を利用していることの確認-1" class="headerlink" title="C. サイト間 VPN を利用していることの確認"></a>C. サイト間 VPN を利用していることの確認</h3><p>(確認不要) 下記 E. の手順に包含されるため、本手順は割愛します。</p><h3 id="D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認-1"><a href="#D-BGP-でデフォルト-ルートを-0-0-0-0-0-を受信していないことの確認-1" class="headerlink" title="D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認"></a>D. BGP でデフォルト ルートを 0.0.0.0/0 を受信していないことの確認</h3><p>(確認不要) クラシックでは BGP は利用できないため、本手順は割愛します。</p><h3 id="E-DefaultSiteの設定がされていることの確認-1"><a href="#E-DefaultSiteの設定がされていることの確認-1" class="headerlink" title="E. DefaultSiteの設定がされていることの確認"></a>E. DefaultSiteの設定がされていることの確認</h3><ol><li><p><b>Azure PowerShell で以下のコマンドを実行します。</b><br><br>Get-AzureVirtualNetworkGateway</p></li><li><p><b>表示されたゲートウェイの一覧から、以下のように DefaultSite に値が入っているものがあれば、合致しています。</b><br></p><blockquote><p>GatewayId            : xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx<br><br>GatewayName          : Default<br><br>LastEventData        :<br><br>GatewayType          : DynamicRouting<br><br>LastEventTimeStamp   : xx/xx/xxxx xx:xx:xx<br><br>LastEventMessage     : Successfully updated the gateway for the following virtual network: xxxx <b>← 通常、ここに対象の仮想ネットワーク名が入ります。</b><br><br>LastEventID          : xxxxx<br><br>State                : Provisioned<br><br>VIPAddress           : x.x.x.x<br><br>DefaultSite          : Site01 <b>← ここにサイト名が入っていれば該当しています。該当しない場合空欄です。</b><br><br>GatewaySKU           : Standard<br><br>Location             : Japan East<br><br>VnetId               : xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx<br><br>SubnetId             :<br><br>EnableBgp            : False<br><br>Asn                  : xxxxx<br><br>BgpPeeringAddress    : x.x.x.x<br><br>PeerWeight           : 0<br><br>OperationDescription :<br><br>OperationId          :<br><br>OperationStatus      :<br></p></blockquote></li></ol>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;Azure の仮想ネットワーク ゲートウェイ (以下「ゲートウェイ」) を用いたサイト間 VPN 接続について、2022 年 2 月 24 日以降に、強制トンネリングに関する一部の動作の変更が行われることがアナウンスされました。&lt;/p&gt;
&lt;p&gt;影響が生じる可能性のあるお客様には通知がすでに送信されているか、近日中に送信されることが想定されます。しかしながら、通知に含まれる説明は要点のみとなっているため、本記事にてその補足をさせていただきます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="VPN Gateway" scheme="https://jpaztech.github.io/blog/tags/VPN-Gateway/"/>
    
  </entry>
  
  <entry>
    <title>ExpressRoute の エッジ ルーターのメンテナンスに関して</title>
    <link href="https://jpaztech.github.io/blog/network/expressroute-maintenance/"/>
    <id>https://jpaztech.github.io/blog/network/expressroute-maintenance/</id>
    <published>2022-01-14T01:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.107Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。<br>今回は ExpressRoute 回線のエッジルーターにおけるメンテナンスについて、メンテナンス時の基本的な挙動と、お問い合わせをいただくことの多いご質問への回答を紹介させていただきます。</p><br><h2 id="メンテナンスの通知"><a href="#メンテナンスの通知" class="headerlink" title="メンテナンスの通知"></a>メンテナンスの通知</h2><p>ExpressRoute 回線でメンテナンスが実施される場合、通常以下のようなお客様への通知が事前に行われております。</p><p><img src="/blog/network/expressroute-maintenance/expressroute-maintenance1.jpg" alt="通知メールのサンプル"></p><p>※ 本文中の日時やロケーションはメンテナンスごとに異なります。</p><br><h2 id="メンテナンスの対象"><a href="#メンテナンスの対象" class="headerlink" title="メンテナンスの対象"></a>メンテナンスの対象</h2><p>ExpressRoute ではエッジルーター (Microsoft Enterprise Edge: MSEE) と呼ばれる物理ルーターが、既定で Microsoft 側に 2 系統存在しており、それぞれが回線プロバイダー様のルーター (Provider Edge: PE)と BGP セッションを構成することで、冗長化が行われております (2 系統で冗長化されていない環境は SLA の範囲外です)。</p><p>メンテナンスの対象となるのはこの MSEE (図における黄色のルーター) です。</p><p>※ L2 モデルの回線プロバイダー様ご利用されている場合、回線プロバイダー様のスイッチを経て L3 レベルではお客様の管理所有するルーターと接続されています。そのため L2 モデルの回線プロバイダー様をご利用の場合、PE という表現についてはお客様が管理所有されている BGP ルーターと読み替えてください。</p><p><img src="/blog/network/expressroute-maintenance/expressroute-maintenance2.jpg" alt="ExpressRoute の接続図"></p><br><h2 id="メンテナンス時の挙動"><a href="#メンテナンス時の挙動" class="headerlink" title="メンテナンス時の挙動"></a>メンテナンス時の挙動</h2><p>メンテナンスは MSEE の冗長性を考慮して片系統ずつ実施されます。そのためメンテナンス実施中であっても、後述する「通信影響が生じる可能性のあるケース」に該当しない限りは、お客様への通信影響は想定されておりませんのでご安心ください。</p><p>メンテナンス時の挙動について少し具体的にご説明すると、メンテナンス対象の MSEE と PE 間の BGP セッションが切断される前に、以下のような手法で通信経路を非メンテナンス側に寄せる処理が行われます。</p><ol><li>MSEE から PE への通信経路<br>弊社側での経路制御により非メンテナンス側の経路が優先されるよう制御します。</li><li>PE から MSEE への通信経路<br>MSEE から PE に対して、 BGP で広報する経路のうち、メンテナンスを行う側の AS PATH を長くして広報することで、非メンテナンス側の経路が優先されるように制御します (AS Path Prepend)。</li></ol><p>上記 1 、 2 の手法により、双方向とも非メンテナンス側の経路が優先されるように制御が行われますので、メンテナンスの実施中もお客様への通信影響は想定されておりません。</p><p>以下の公開文書にも、メンテナンス実施中に AS PATH により経路を制御する旨が記載されています。</p><ul><li><p><a href="https://docs.microsoft.com/ja-jp/azure/expressroute/designing-for-high-availability-with-expressroute#active-active-connections">ExpressRoute を使用した高可用性のための設計 - アクティブ/アクティブ接続</a></p><blockquote><p>メンテナンス アクティビティの期間、またはいずれかの接続に影響を与える計画外のイベント時に、Microsoft では、AS パス プリペンディングを使用して、正常な接続にトラフィックをドレインする方法を優先します。 Microsoft によりパス プリペンドが構成されている場合にトラフィックを正常なパスにルーティングできること、およびサービスの中断が発生しないように、必要なルート アドバタイズが適切に構成されていること確認する必要があります。</p></blockquote></li></ul><br><p><strong>通信影響が生じる可能性のあるケース</strong><br>上記のとおりほとんどの環境では通信影響はありませんが、例えば以下のような極めて限定的な条件下においては、一時的な通信影響が発生する可能性があります。</p><ul><li>お客様側で非常に長い AS Path を利用した経路制御を行っており、メンテナンス時に Microsoft 側で付与する AS Path がお客様の利用されている AS Path に負け、経路制御が効かないケース</li><li>お客様側で AS Path Prepend よりも優先度の高い手法による経路制御を行っているケース</li></ul><p>仮に上記のようなケースで PE から MSEE への通信経路の制御が動作しなくても、往復路が不一致となるのみですので、通常は通信への影響ありません。<br>しかし、例えばステートフルなファイアウォールを利用されている場合など、PE 側のネットワーク構成によってはこうして生じた往復路の不一致が許容されない場合があります。</p><p>このように、お客様側での通信制御によって AS Path Prepend が動作せず、かつ往復路の不一致が許容されない構成になっている場合には、メンテナンス時に一時的な通信影響が生じる可能性がございますので予めご承知おきください。<br>なお PE 側の経路制御状況やネットワーク構成が上記に該当しているかご確認されたい場合、お客様側のネットワークご担当者様にご確認いただくようお願いいたします。<br><br></p><hr><h2 id="よくあるご質問"><a href="#よくあるご質問" class="headerlink" title="よくあるご質問"></a>よくあるご質問</h2><ul><li><strong>現在利用している ExpressRoute 回線は冗長化されていますか</strong><br>ExpressRoute 回線は、「 1 回線」作成すると、必ず内部的には 2 本の物理的な回線が構成され、2 台の MSEE が利用されます。つまり、シングル構成になっていることは原則ありません。<br>ただし、L2 モデルのプロバイダー (お客様自身で BGP ルーターを構成いただく必要があるプロバイダー) をご利用いただいており、ルーターを片方の回線にしか接続していない、片方の回線しか BGP の Neighbor を確立していないなど、極めて例外的な構成を取っている場合に限っては、今回のメンテナンスにあたって通信影響が生じます。<br>このような構成は、SLA が担保されない、弊社として保証していない特殊な構成であり、プロバイダー様、またはお客様にて意図的に構成されるものです。そのため、ご利用されている ExpressRoute 回線が冗長構成となっているか確認されたい場合は、ご契約されているプロバイダー様、またはお客様側のネットワーク担当者様へご確認ください。</li></ul><ul><li><strong>仮想ネットワーク ゲートウェイ の SKU とメンテナンスに伴う影響の有無は関係ありますか</strong><br>既にリタイアした Basic 以外の SKU では、メンテナンスに伴う影響の有無には関係ありません。仮想ネットワーク ゲートウェイ は上記の図中の青色の部分ですが、メンテナンス対象である MSEE は黄色の部分です。</li></ul><ul><li><strong>メンテナンス期間が数時間取られていますが、この時間中ずっと切断されたままになるのですか</strong><br>いいえ、メンテナンス期間中の一部のタイミングでのみ、一時的な切断が発生します。また切断といっても、前述のとおり冗長化された回線の片系ずつの切断となります。</li></ul><ul><li><strong>PE 側で何らかのログが出力される可能性はありますか</strong><br>メンテナンスに伴って BGP セッションが切断された際には、PE 側では BGP セッションの切断を示すログなどが記録されることが想定されます。ルーターの監視を行っている場合は、メンテナンス期間中にこのようなログが記録されることをあらかじめご認識いただけますと幸いです。</li></ul><p>以上、ExpressRoute の MSEE メンテナンス通知を受け取られた際の影響確認、ならびに同メンテナンスによる影響を回避するにあたってのルーティング設計をご検討いただくにあたり、ご参考にしていただければ幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;br&gt;今回は ExpressRoute 回線のエッジルーターにおけるメンテナンスについて、メンテナンス時の基本的な挙動と、お問い合わせをいただくことの多いご質問への回答を紹介させていただきます。&lt;/p&gt;
&lt;br&gt;
</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="Maintenance" scheme="https://jpaztech.github.io/blog/tags/Maintenance/"/>
    
  </entry>
  
  <entry>
    <title>AKS コントロール プレーンとノード間の通信のはなし</title>
    <link href="https://jpaztech.github.io/blog/containers/aks-control-plane-node-communication/"/>
    <id>https://jpaztech.github.io/blog/containers/aks-control-plane-node-communication/</id>
    <published>2021-12-24T03:00:00.000Z</published>
    <updated>2022-12-22T05:56:35.067Z</updated>
    
    <content type="html"><![CDATA[<p>この記事は <a href="https://qiita.com/advent-calendar/2021/microsoft-azure-tech">Microsoft Azure Tech Advent Calendar 2021</a> の 24 日目の記事になります🎅</p><p>こんにちは！！ Azure テクニカル サポート チームの桐井です。</p><p>AKS クラスターをデプロイすると、kube-system ネームスペースで <code>tunnelfront</code> や <code>aks-link</code> という名前の Pod が動いているかとおもいます。あるいは <code>konnectivity-agent</code> という Pod を見たことがあるという方もいるかもしれません。これらの Pod はどのような目的で使用されるのでしょう？</p><p>本記事では、これらのシステム Pod が担う AKS コントロール プレーンとノード間の通信について紹介します。</p><span id="more"></span><hr><h2 id="Kubernetes-クラスターのアーキテクチャ"><a href="#Kubernetes-クラスターのアーキテクチャ" class="headerlink" title="Kubernetes クラスターのアーキテクチャ"></a>Kubernetes クラスターのアーキテクチャ</h2><p>まずは説明にあたり、前提情報となる Kubernetes のアーキテクチャについて簡単に紹介いたします。Kubernetes のクラスターは、大きく分けて <strong>コントロール プレーン</strong> と <strong>ノード</strong> の 2 つのコンポーネントで構成されています。</p><p><img src="/blog/containers/aks-control-plane-node-communication/aks-control-plane-node-communication01.png" alt="AKS (Kubernetes) のアーキテクチャ"></p><h3 id="コントロール-プレーン"><a href="#コントロール-プレーン" class="headerlink" title="コントロール プレーン"></a>コントロール プレーン</h3><p>Kubernetes の主要なサービスが稼働しており、アプリケーション ワークロードのオーケストレーションを担います。コントロール プレーンでは API サーバー (kube-apiserver) が存在し、クラスターの操作を <a href="https://kubernetes.io/ja/docs/concepts/overview/kubernetes-api/">Kubernetes API</a> として提供します。</p><h3 id="ノード"><a href="#ノード" class="headerlink" title="ノード"></a>ノード</h3><p>コンテナー化されたアプリケーション ワークロードが実行されます。各ノードでは kubelet が動作しており、Pod のデプロイ内容に基づいてコンテナー ランタイムを操作したり、Node や Pod のステータスを API サーバーへ送信したりといった処理を行います。</p><p>Azure Kubernetes Service (AKS) は、Kubernetes コントロール プレーンを Azure のマネージド リソースとして提供するサービスとなっています。クラスターのアーキテクチャの詳細につきましては、下記 AKS ドキュメントをあわせてご参照ください。</p><blockquote><p>ご参考) Azure Kubernetes Services (AKS) における Kubernetes の中心概念<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/concepts-clusters-workloads">https://docs.microsoft.com/ja-jp/azure/aks/concepts-clusters-workloads</a></p></blockquote><h2 id="コントロール-プレーンとノード間の通信"><a href="#コントロール-プレーンとノード間の通信" class="headerlink" title="コントロール プレーンとノード間の通信"></a>コントロール プレーンとノード間の通信</h2><p>前述のように、クラスターの各種操作は Kubernetes API を介して行われます。クラスターの利用者が実行する kubectl コマンドや、ノード上で稼働する kubelet は、コントロール プレーンの API サーバー (kube-apiserver) にアクセスして、リソース操作や情報取得のリクエストを行います。</p><p>実際のアプリケーション ワークロードは、コントロール プレーンではなくノード側で動作しています。そのため、API サーバーはリクエストされたクラスター操作を実現するために、ノードや Pod との通信をする必要があります。</p><p>API サーバーとノードの通信は大きく 2 つにわけることができます。</p><p><img src="/blog/containers/aks-control-plane-node-communication/aks-control-plane-node-communication02.png" alt="API サーバーとノードの通信"></p><h3 id="1-ノードから-API-サーバー"><a href="#1-ノードから-API-サーバー" class="headerlink" title="(1) ノードから API サーバー"></a>(1) ノードから API サーバー</h3><p>API サーバーは HTTPS ポート (443) で Kubernetes API を公開しています。<br>kubelet や、Ingress Controller などの Kubernetes API を利用する Pod は、API サーバーのエンドポイントに HTTPS でアクセスをし、各種リソース情報の取得や更新を行います。</p><h3 id="2-API-サーバーからノード"><a href="#2-API-サーバーからノード" class="headerlink" title="(2) API サーバーからノード"></a>(2) API サーバーからノード</h3><p>一部のクラスター操作には、API サーバーから <a href="https://kubernetes.io/docs/reference/ports-and-protocols/#node">kubelet が持つ API エンドポイント</a>に対してリクエストを送信し、その結果を取得する処理が必要になります。</p><ul><li>Pod からログを取得する (kubectl logs)</li><li>Pod 上でコマンドを実行する (kubectl exec)</li><li>Pod / Service にポート フォワードで接続する (kubectl port-forward)</li></ul><p>また、<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/resource-metrics-pipeline/">Metrics API</a> へのアクセス (kubectl top) では、Node や Pod のリソース使用量を取得するために、ノード側で動作する <a href="https://github.com/kubernetes-sigs/metrics-server">metric-server</a> へのアクセスが必要となります。</p><p>これらの機能の実現をするために、API サーバーは kubelet や Pod / Service にアクセスする必要があるため、コントロール プレーンからノードへの通信経路が必要となります。</p><h2 id="コントロール-プレーンからノードへの通信の実現方法"><a href="#コントロール-プレーンからノードへの通信の実現方法" class="headerlink" title="コントロール プレーンからノードへの通信の実現方法"></a>コントロール プレーンからノードへの通信の実現方法</h2><p>冒頭で挙げたシステム Pod は、コントロール プレーンからノードへの通信を実現するために仮想的なネットワーク経路を作るクライアント Pod となっています。</p><p>これらのコンポーネントは Kubernetes のアーキテクチャ図には載っておらず、あまり聞き馴染みのない Pod かと思います。自分で仮想マシンを使って Kubernetes クラスターの構築 (<a href="https://github.com/kelseyhightower/kubernetes-the-hard-way">Kubernetes Hard Way</a>) を試したことがある方は、そのような Pod をインストールしたかな？と疑問に思うかもしれません。</p><p>コントロール プレーンとノードが同じネットワークに接続している場合は、kube-apiserver はノードや Pod に直接通信できます。ところが、コントロールプレーンとノードが異なるネットワークに存在し分断されている場合は、そのままではお互いに通信ができないので、何らかの方法でネットワーク経路を作り、通信ができるようにする必要があります。また、信頼できないネットワークやパブリック ネットワークを経由させる場合には、盗聴や中間者攻撃を防ぐためにネットワークの保護も必要です。</p><p>パブリック クラウドの Kubernetes サービスでは、コントロールプレーンをマネージド サービスとして提供するため、ノードが存在しているお客様の環境とは別のネットワークが使用されます。そのため、SSH トンネルや VPN といった技術を使って、API サーバーとノード間で仮想的なネットワーク経路が作られる構成になっています。</p><p><img src="/blog/containers/aks-control-plane-node-communication/aks-control-plane-node-communication03.png" alt="異なるネットワークに存在するコントロール プレーンとノード間でネットワーク接続を実現する"></p><p>コントロール プレーンとノード間のネットワーク接続には、いくつかの実現方法がございます。ここでは、AKS で利用されている通信方式と、各方式において kube-system ネームスペースにデプロイされるシステム Pod の名前を紹介いたします。クラスターの構成や作成時期によって、以下のいずれかの方式が利用されます。</p><h3 id="SSH-トンネル-tunnelfront-Pod"><a href="#SSH-トンネル-tunnelfront-Pod" class="headerlink" title="SSH トンネル (tunnelfront-* Pod)"></a>SSH トンネル (tunnelfront-* Pod)</h3><p><code>tunnelfront</code> という名前の Pod が存在するクラスターでは、SSH トンネルが使用されています。コントロール プレーン側には SSH サーバーが存在し、API サーバーのエンドポイントで SSH クライアントからの接続を受け付けています。<code>tunnelfront</code> Pod は SSH クライアントとなっており、コントロール プレーンとノード間で SSH トンネルを開始します。kubelet や Pod / Service 宛てのトラフィックは SSH トンネル経由で転送されます。</p><h3 id="VPN-トンネル-aks-link-Pod"><a href="#VPN-トンネル-aks-link-Pod" class="headerlink" title="VPN トンネル (aks-link-* Pod)"></a>VPN トンネル (aks-link-* Pod)</h3><p><code>aks-link</code> という名前の Pod が存在する場合は、VPN トンネル (OpenVPN) が使用されています。コントロール プレーン側には VPN サーバーが存在します。ノード側の <code>aks-link</code> Pod が VPN クライアントとなっており、コントロール プレーンとノード間で VPN トンネルを開始します。</p><h3 id="Konnectivity-konnectivity-agent-Pod"><a href="#Konnectivity-konnectivity-agent-Pod" class="headerlink" title="Konnectivity (konnectivity-agent-* Pod)"></a>Konnectivity (konnectivity-agent-* Pod)</h3><p><code>konnectivity-agent</code> という名前の Pod が存在する場合には <a href="https://kubernetes.io/docs/concepts/architecture/control-plane-node-communication/#konnectivity-service">Konnectivity service</a> が使用されています。Konnectivity はアップストリームの Kubernetes プロジェクトで<a href="https://github.com/kubernetes-sigs/apiserver-network-proxy">開発されている</a> TCP レベルのプロキシーです。コントロール プレーン側では Konnectivity Server が起動し、ノード側では Konnectivity Agent が起動します。</p><p>AKS では SSH / VPN トンネルに替わる新しい方式として、段階的に Konnectivity の導入がすすめられています。<a href="https://github.com/Azure/AKS/releases/tag/2021-10-28">Release 2021-10-28</a> で一部リージョンからロールアウトが開始されましたが、<a href="https://github.com/Azure/AKS/releases/tag/2021-11-18">Release 2021-11-18</a> 以降、2021 年の残りの期間ではロールアウトが中断となっています。そのため、日本リージョンで利用可能になるのはもう少し先になる見込みです。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>余談: 「コネクティビティ」というと英語の「connectivity」と紛らわしいので「Konnectivity with K」と呼ばれることがあります。</p></div><h2 id="トラブルシューティングの事例"><a href="#トラブルシューティングの事例" class="headerlink" title="トラブルシューティングの事例"></a>トラブルシューティングの事例</h2><p>コントロール プレーンとノードの通信については、関連するトラブルのご相談を Azure サポートにお寄せいただくことがございます。多く寄せられるご相談としましては、Kubernetes の一部機能が利用できないという事象です。</p><ul><li>Pod 上でコマンド実行ができない (kubectl exec)</li><li>Pod のログ取得ができない (kubectl logs)</li><li>port-forward ができない (kubectl port-forward)</li><li>Pod や Node のメトリックが取得できない (kubectl top)</li></ul><p>Pod の作成/削除といったリソース操作は成功するものの、上記に挙げましたように kubectl の一部コマンドが使えないという症状がある場合は、何らかの要因でコントロール プレーンとノード間の通信が成功していないことが考えられます。</p><blockquote><p>ご参考) Azure Kubernetes Service (AKS) についてよく寄せられる質問<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/troubleshooting#i-cant-get-logs-by-using-kubectl-logs-or-i-cant-connect-to-the-api-server-im-getting-error-from-server-error-dialing-backend-dial-tcp-what-should-i-do">「kubectl logs を使用してログを取得できません。または、API サーバーに接続できません。 “Error from server: error dialing backend: dial tcp…” (サーバーからのエラー: バックエンドへのダイヤルでのエラー: tcp にダイヤル…) と表示されます。 どうすればよいですか。」</a><br><a href="https://docs.microsoft.com/ja-jp/azure/aks/troubleshooting#i-cant-get-logs-by-using-kubectl-logs-or-i-cant-connect-to-the-api-server-im-getting-error-from-server-error-dialing-backend-dial-tcp-what-should-i-do">https://docs.microsoft.com/ja-jp/azure/aks/troubleshooting#i-cant-get-logs-by-using-kubectl-logs-or-i-cant-connect-to-the-api-server-im-getting-error-from-server-error-dialing-backend-dial-tcp-what-should-i-do</a></p></blockquote><p>この事象が発生しました場合は以下の観点をご確認ください。</p><h3 id="観点-1-クラスターに必要な通信要件を満たしているか"><a href="#観点-1-クラスターに必要な通信要件を満たしているか" class="headerlink" title="(観点 1) クラスターに必要な通信要件を満たしているか"></a>(観点 1) クラスターに必要な通信要件を満たしているか</h3><p>API サーバーへの通信が NSG や Azure Firewall によってブロックされていないかを確認します。</p><p>下記 AKS ドキュメントに、クラスターの動作に必要なエンドポイントとポート番号の一覧がございます。ご利用の環境に応じて、通信が必要な FQDN / ポート番号の許可がされているかをご確認ください。</p><blockquote><p>ご参考) Azure Kubernetes Service (AKS) でクラスター ノードに対するエグレス トラフィックを制御する<br><a href="https://docs.microsoft.com/ja-jp/azure/aks/limit-egress-traffic#required-outbound-network-rules-and-fqdns-for-aks-clusters">AKS クラスターに必要な送信ネットワーク規則と FQDN</a><br><a href="https://docs.microsoft.com/ja-jp/azure/aks/limit-egress-traffic#required-outbound-network-rules-and-fqdns-for-aks-clusters">https://docs.microsoft.com/ja-jp/azure/aks/limit-egress-traffic#required-outbound-network-rules-and-fqdns-for-aks-clusters</a></p></blockquote><h3 id="観点-2-kube-system-ネームスペースのシステム-Pod-が正常動作しているか"><a href="#観点-2-kube-system-ネームスペースのシステム-Pod-が正常動作しているか" class="headerlink" title="(観点 2) kube-system ネームスペースのシステム Pod が正常動作しているか"></a>(観点 2) kube-system ネームスペースのシステム Pod が正常動作しているか</h3><p>kube-system ネームスペース内のシステム Pod が正常に動作しているかを確認します。</p><p>本記事で紹介をいたしました <code>tunnelfront</code> や <code>aks-link</code> といったシステム Pod が Running ステータスで動作をしているか、また、Pod のログに何らかのエラー メッセージが出力されていないかをご確認ください。詳細につきましては下記の AKS トリアージ ガイドをご参照ください。</p><blockquote><p>ご参考) AKS トリアージのプラクティス - ノードとポッドの正常性を調べる<br><a href="https://docs.microsoft.com/ja-jp/azure/architecture/operator-guides/aks/aks-triage-node-health#2--verify-the-control-plane-and-worker-node-connectivity">2 - コントロール プレーンとワーカー ノードの接続を確認する</a><br><a href="https://docs.microsoft.com/ja-jp/azure/architecture/operator-guides/aks/aks-triage-node-health#2--verify-the-control-plane-and-worker-node-connectivity">https://docs.microsoft.com/ja-jp/azure/architecture/operator-guides/aks/aks-triage-node-health#2--verify-the-control-plane-and-worker-node-connectivity</a></p></blockquote><p>API サーバーとの通信に問題がある場合、<code>kubectl logs</code> が成功せず、Pod のログ確認ができないことが想定されます。<a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-overview">Container Insights</a> が有効なクラスターでは、クラスター内の監視エージェント (omsagent) によって収集されたログが、Log Analytics ワークスペースから取得出来る場合がございます。kubectl コマンドでのログ取得が成功しない場合は、<a href="https://docs.microsoft.com/ja-jp/azure/azure-monitor/containers/container-insights-log-query">クエリーを使用した Log Analytics からのログ取得</a>をお試しください。</p><p>上記をご確認いただいたあとも引き続き事象が発生します場合は、Azure サポートまでお気兼ねなくご相談ください。クラスターの状態を拝見させていただき、見解・対処方法をご案内いたします。</p><h2 id="さいごに"><a href="#さいごに" class="headerlink" title="さいごに"></a>さいごに</h2><p>Kubernetes コントロール プレーンとノード間の通信と、AKS における通信方式、そしてトラブルシューティングの事例について紹介しました。</p><p>本記事で紹介しました Konnectivity は段階的に各リージョンへロールアウトされる見込みです。最新の情報につきましては、AKS の GitHub リポジトリにございますリリース情報をご参照ください。</p><blockquote><p>ご参考) Azure/AKS - Releases<br><a href="https://github.com/Azure/AKS/releases">https://github.com/Azure/AKS/releases</a></p></blockquote><p>本稿が皆様のお役に立ちましたら幸いです。</p><h3 id="参考リンク"><a href="#参考リンク" class="headerlink" title="参考リンク"></a>参考リンク</h3><ul><li><a href="https://kubernetes.io/docs/concepts/architecture/control-plane-node-communication/">Control Plane-Node Communication - Kubernetes</a></li><li><a href="https://kubernetes.io/docs/tasks/extend-kubernetes/setup-konnectivity/">Set up Konnectivity service - Kubernetes</a></li><li><a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-api-machinery/1281-network-proxy">kubernetes / enhancements - API Server Network Proxy</a></li></ul><hr><p>最後まで読んでいただきありがとうございました！<br><a href="https://qiita.com/advent-calendar/2021/microsoft-azure-tech">Microsoft Azure Tech Advent Calendar 2021</a> は明日が最終日となります！是非ご覧くださいー！</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;この記事は &lt;a href=&quot;https://qiita.com/advent-calendar/2021/microsoft-azure-tech&quot;&gt;Microsoft Azure Tech Advent Calendar 2021&lt;/a&gt; の 24 日目の記事になります🎅&lt;/p&gt;
&lt;p&gt;こんにちは！！ Azure テクニカル サポート チームの桐井です。&lt;/p&gt;
&lt;p&gt;AKS クラスターをデプロイすると、kube-system ネームスペースで &lt;code&gt;tunnelfront&lt;/code&gt; や &lt;code&gt;aks-link&lt;/code&gt; という名前の Pod が動いているかとおもいます。あるいは &lt;code&gt;konnectivity-agent&lt;/code&gt; という Pod を見たことがあるという方もいるかもしれません。これらの Pod はどのような目的で使用されるのでしょう？&lt;/p&gt;
&lt;p&gt;本記事では、これらのシステム Pod が担う AKS コントロール プレーンとノード間の通信について紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Containers" scheme="https://jpaztech.github.io/blog/tags/Containers/"/>
    
    <category term="Azure Kubernetes Service (AKS)" scheme="https://jpaztech.github.io/blog/tags/Azure-Kubernetes-Service-AKS/"/>
    
  </entry>
  
</feed>
